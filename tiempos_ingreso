/**Primer paso ejecutar Update**/
UPDATE trans_oc_enc set Fecha_Recepcion = DATEADD(hour, 1, Fec_Agr)
where Fecha_Recepcion<Fec_Agr

begin transaction

update trans_re_det set fecha_ingreso = (select sr.fecha_ingreso from stock_rec sr where sr.IdRecepcionEnc = trans_re_det.IdRecepcionEnc 
and sr.IdRecepcionDet = trans_re_det.IdRecepcionDet  ) 

select * from trans_re_det where IdRecepcionEnc = 2986
select * from stock_rec  where IdRecepcionEnc = 2986

commit transaction

/**Segundo paso Actualizar funcion **/
/****** Object:  UserDefinedFunction [dbo].[ConvertSecondsFormatoFecha]    Script Date: 2/12/2021 17:16:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author: <Author,,Name>
-- Create date: <Create Date, ,>
-- Description: <Description, ,>
-- =============================================
ALTER FUNCTION [dbo].[ConvertSecondsFormatoFecha]
(
@Seconds DECIMAL
)
RETURNS NVARCHAR(50)
AS
BEGIN

DECLARE @resultado NVARCHAR(50)
DECLARE @dias DECIMAL
DECLARE @segundos_sobrantes DECIMAL
DECLARE @horas AS DECIMAL
DECLARE @minutos AS DECIMAL
DECLARE @segundos AS DECIMAL

SELECT @dias = @Seconds / (24 * 60 * 60)
SELECT @segundos_sobrantes =ABS(@Seconds -(@dias* (24 * 60 * 60)))
SELECT @horas = (@segundos_sobrantes % (24.0 * 60.0 * 60.0)) / (60.0 * 60.0)
SELECT @minutos = (((@segundos_sobrantes % (24.0 * 60.0 * 60.0)) % (60.0 * 60.0)) / 60.0)
SELECT @segundos = (((@segundos_sobrantes % (24.0 * 60.0 * 60.0)) % (60.0 * 60.0)) % 60.0)

-- Declare the return variable here
SELECT @resultado = CONVERT(NVARCHAR(50),@dias) + ' ' + 
RIGHT('00'+ CONVERT(NVARCHAR(2),@horas),2) + ':' +
RIGHT('00'+ CONVERT(NVARCHAR(2),@minutos),2) + ':' +
RIGHT('00'+ CONVERT(NVARCHAR(2),@segundos),2);

RETURN @resultado;

END ;


---Consultas
select ocre.IdRecepcionOc, re.IdRecepcionEnc, oc.IdOrdenCompraEnc, 
oc.Fec_Agr AS OC_Hora_Creacion,
re.Fec_Agr as RE_Hora_Creacion_Recepcion,
oc.Fecha_Recepcion as OC_Fecha_Recepcion,
ocre.hora_fin_hh AS REOC_HORA_FIN,
dbo.ConvertSecondsFormatoFecha(ABS(DATEDIFF(SECOND, oc.Fec_Agr, re.Fec_Agr))) AS DIF1,
dbo.ConvertSecondsFormatoFecha(ABS(DATEDIFF(SECOND, re.Fec_Agr, oc.Fecha_Recepcion))) AS DIF2,
dbo.ConvertSecondsFormatoFecha(ABS(DATEDIFF(SECOND,oc.Fecha_Recepcion, ocre.hora_fin_hh))) AS DIF3,
dbo.ConvertSecondsFormatoFecha(ABS(DATEDIFF(SECOND, re.Fec_Agr, ocre.hora_fin_hh))) AS DIF4
from trans_re_oc ocre inner join trans_re_enc re on ocre.IdRecepcionEnc = re.IdRecepcionEnc
inner join trans_oc_enc oc on ocre.IdOrdenCompraEnc = oc.IdOrdenCompraEnc
where re.IdTipoTransaccion = 'HCOC00' and oc.Fecha_Creacion>'20190101'

select * from trans_oc_enc where Fecha_Recepcion<Fec_Agr

--Promedio de atencion
select dbo.ConvertSecondsFormatoFecha(AVG(DATEDIFF(SECOND, re.Fec_Agr, ocre.hora_fin_hh))) AS PROMEDIO
from trans_re_oc ocre inner join trans_re_enc re on ocre.IdRecepcionEnc = re.IdRecepcionEnc
inner join trans_oc_enc oc on ocre.IdOrdenCompraEnc = oc.IdOrdenCompraEnc
where re.IdTipoTransaccion = 'HCOC00' and oc.Fecha_Creacion>'20190301'


