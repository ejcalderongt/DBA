--#EJC20260211 Agregué sync_mi3 e IdBodega
ALTER VIEW [dbo].[VW_TransUbicacionHhEnc]
AS
SELECT
    e.IdTareaUbicacionEnc,
    e.IdPropietarioBodega,
    e.IdMotivoUbicacion,
    mu.Nombre AS DescripcionMotivo,
    e.FechaInicio,
    e.HoraInicio,
    e.FechaFin,
    e.HoraFin,
    e.user_agr,
    e.fec_agr,
    e.user_mod,
    e.fec_mod,
    e.Observacion,
    e.activo,
    e.operador_por_linea,
    e.ubicacion_con_hh,
    e.estado,
    e.cambio_estado,
    e.IdReabastecimientoLog,
    e.es_traslado_sap,
    e.no_documento,
    u.nombres AS Usuario,
    r.nombre AS Rol,
    e.sync_mi3,
    pb.IdBodega,
    b.Codigo AS CodigoBodega
FROM dbo.trans_ubic_hh_enc e
INNER JOIN dbo.motivo_ubicacion mu
    ON e.IdMotivoUbicacion = mu.IdMotivoUbicacion
INNER JOIN dbo.usuario u
    ON e.user_agr = u.IdUsuario
INNER JOIN dbo.usuario_bodega ub
    ON u.IdUsuario = ub.IdUsuario
INNER JOIN dbo.rol r
    ON ub.IdRol = r.IdRol
INNER JOIN dbo.propietario_bodega pb
    ON e.IdPropietarioBodega = pb.IdPropietarioBodega
   AND ub.IdBodega = pb.IdBodega
INNER JOIN dbo.bodega b
    ON b.IdBodega = pb.IdBodega;
GO

--#AT20260106 Mostrar tareas de HH
ALTER VIEW [dbo].[VW_TransUbicacionHhEnc]
AS
SELECT dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc, dbo.trans_ubic_hh_enc.IdPropietarioBodega, dbo.trans_ubic_hh_enc.IdMotivoUbicacion, dbo.motivo_ubicacion.Nombre AS DescripcionMotivo, dbo.trans_ubic_hh_enc.FechaInicio, 
                  dbo.trans_ubic_hh_enc.HoraInicio, dbo.trans_ubic_hh_enc.FechaFin, dbo.trans_ubic_hh_enc.HoraFin, dbo.trans_ubic_hh_enc.user_agr, dbo.trans_ubic_hh_enc.fec_agr, dbo.trans_ubic_hh_enc.user_mod, dbo.trans_ubic_hh_enc.fec_mod, 
                  dbo.trans_ubic_hh_enc.Observacion, dbo.trans_ubic_hh_enc.activo, dbo.trans_ubic_hh_enc.operador_por_linea, dbo.trans_ubic_hh_enc.ubicacion_con_hh, dbo.trans_ubic_hh_enc.estado, dbo.trans_ubic_hh_enc.cambio_estado, 
                  dbo.trans_ubic_hh_enc.IdReabastecimientoLog, dbo.trans_ubic_hh_enc.es_traslado_sap, dbo.trans_ubic_hh_enc.no_documento, isnull(dbo.usuario.nombres, 'ND') AS Usuario, isnull(dbo.rol.nombre, 'ND') AS Rol
FROM     dbo.trans_ubic_hh_enc INNER JOIN
                  dbo.motivo_ubicacion ON dbo.trans_ubic_hh_enc.IdMotivoUbicacion = dbo.motivo_ubicacion.IdMotivoUbicacion INNER JOIN
                  dbo.usuario ON dbo.trans_ubic_hh_enc.user_agr = dbo.usuario.IdUsuario INNER JOIN
                  dbo.usuario_bodega ON dbo.usuario.IdUsuario = dbo.usuario_bodega.IdUsuario INNER JOIN
                  dbo.rol ON dbo.usuario_bodega.IdRol = dbo.rol.IdRol INNER JOIN
                  dbo.propietario_bodega ON dbo.trans_ubic_hh_enc.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega AND dbo.usuario_bodega.IdBodega = dbo.propietario_bodega.IdBodega
WHERE trans_ubic_hh_enc.ubicacion_con_hh = 0
UNION
SELECT dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc, dbo.trans_ubic_hh_enc.IdPropietarioBodega, dbo.trans_ubic_hh_enc.IdMotivoUbicacion, dbo.motivo_ubicacion.Nombre AS DescripcionMotivo, dbo.trans_ubic_hh_enc.FechaInicio, 
                  dbo.trans_ubic_hh_enc.HoraInicio, dbo.trans_ubic_hh_enc.FechaFin, dbo.trans_ubic_hh_enc.HoraFin, dbo.trans_ubic_hh_enc.user_agr, dbo.trans_ubic_hh_enc.fec_agr, dbo.trans_ubic_hh_enc.user_mod, dbo.trans_ubic_hh_enc.fec_mod, 
                  dbo.trans_ubic_hh_enc.Observacion, dbo.trans_ubic_hh_enc.activo, dbo.trans_ubic_hh_enc.operador_por_linea, dbo.trans_ubic_hh_enc.ubicacion_con_hh, dbo.trans_ubic_hh_enc.estado, dbo.trans_ubic_hh_enc.cambio_estado, 
                  dbo.trans_ubic_hh_enc.IdReabastecimientoLog, dbo.trans_ubic_hh_enc.es_traslado_sap, dbo.trans_ubic_hh_enc.no_documento,  isnull(dbo.operador.nombres,'ND')COLLATE Modern_Spanish_CI_AS AS Usuario, 
				  isnull(dbo.rol_operador.nombre, 'ND')COLLATE Modern_Spanish_CI_AS  AS Rol
FROM     dbo.trans_ubic_hh_enc INNER JOIN
                  dbo.motivo_ubicacion ON dbo.trans_ubic_hh_enc.IdMotivoUbicacion = dbo.motivo_ubicacion.IdMotivoUbicacion left JOIN
                  dbo.operador_bodega ON dbo.trans_ubic_hh_enc.user_agr = dbo.operador_bodega.IdOperadorBodega left JOIN
				  dbo.operador ON dbo.operador_bodega.idoperador = dbo.operador.IdOperador left JOIN
                  dbo.rol_operador ON dbo.operador.IdRolOperador = dbo.rol_operador.IdRolOperador left JOIN
                  dbo.propietario_bodega ON dbo.trans_ubic_hh_enc.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega AND dbo.operador_bodega.IdBodega = dbo.propietario_bodega.IdBodega
WHERE trans_ubic_hh_enc.ubicacion_con_hh = 1
GO


--#CKFK20251226 Modifiqué el inner por left porque cuando el usuario es el operador de la HH no se muestran los registros
ALTER VIEW [dbo].[VW_TransUbicacionHhEnc]
AS
SELECT
dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc, dbo.trans_ubic_hh_enc.IdPropietarioBodega, dbo.trans_ubic_hh_enc.IdMotivoUbicacion, dbo.motivo_ubicacion.Nombre AS DescripcionMotivo, dbo.trans_ubic_hh_enc.FechaInicio, 
                  dbo.trans_ubic_hh_enc.HoraInicio, dbo.trans_ubic_hh_enc.FechaFin, dbo.trans_ubic_hh_enc.HoraFin, dbo.trans_ubic_hh_enc.user_agr, dbo.trans_ubic_hh_enc.fec_agr, dbo.trans_ubic_hh_enc.user_mod, dbo.trans_ubic_hh_enc.fec_mod, 
                  dbo.trans_ubic_hh_enc.Observacion, dbo.trans_ubic_hh_enc.activo, dbo.trans_ubic_hh_enc.operador_por_linea, dbo.trans_ubic_hh_enc.ubicacion_con_hh, dbo.trans_ubic_hh_enc.estado, dbo.trans_ubic_hh_enc.cambio_estado, 
                  dbo.trans_ubic_hh_enc.IdReabastecimientoLog, dbo.trans_ubic_hh_enc.es_traslado_sap, dbo.trans_ubic_hh_enc.no_documento, ISNULL(dbo.usuario.nombres,'Usuario HH') AS Usuario, 
				  ISNULL(dbo.rol.nombre,'N/D') AS Rol
FROM dbo.trans_ubic_hh_enc INNER JOIN
     dbo.motivo_ubicacion ON dbo.trans_ubic_hh_enc.IdMotivoUbicacion = dbo.motivo_ubicacion.IdMotivoUbicacion LEFT JOIN
     dbo.usuario ON dbo.trans_ubic_hh_enc.user_agr = dbo.usuario.IdUsuario LEFT JOIN
     dbo.usuario_bodega ON dbo.usuario.IdUsuario = dbo.usuario_bodega.IdUsuario  LEFT  JOIN
     dbo.rol ON dbo.usuario_bodega.IdRol = dbo.rol.IdRol LEFT JOIN
     dbo.propietario_bodega ON dbo.trans_ubic_hh_enc.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega AND 
	                           dbo.usuario_bodega.IdBodega = dbo.propietario_bodega.IdBodega
GO

/****** CKFK: 24-oCT-2024 Agregamos usuario y rol ******/
ALTER VIEW [dbo].[VW_TransUbicacionHhEnc]
AS
SELECT dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc, dbo.trans_ubic_hh_enc.IdPropietarioBodega, dbo.trans_ubic_hh_enc.IdMotivoUbicacion, dbo.motivo_ubicacion.Nombre AS DescripcionMotivo, dbo.trans_ubic_hh_enc.FechaInicio, 
                  dbo.trans_ubic_hh_enc.HoraInicio, dbo.trans_ubic_hh_enc.FechaFin, dbo.trans_ubic_hh_enc.HoraFin, dbo.trans_ubic_hh_enc.user_agr, dbo.trans_ubic_hh_enc.fec_agr, dbo.trans_ubic_hh_enc.user_mod, dbo.trans_ubic_hh_enc.fec_mod, 
                  dbo.trans_ubic_hh_enc.Observacion, dbo.trans_ubic_hh_enc.activo, dbo.trans_ubic_hh_enc.operador_por_linea, dbo.trans_ubic_hh_enc.ubicacion_con_hh, dbo.trans_ubic_hh_enc.estado, dbo.trans_ubic_hh_enc.cambio_estado, 
                  dbo.trans_ubic_hh_enc.IdReabastecimientoLog, dbo.trans_ubic_hh_enc.es_traslado_sap, dbo.trans_ubic_hh_enc.no_documento, dbo.usuario.nombres AS Usuario, dbo.rol.nombre AS Rol
FROM     dbo.trans_ubic_hh_enc INNER JOIN
                  dbo.motivo_ubicacion ON dbo.trans_ubic_hh_enc.IdMotivoUbicacion = dbo.motivo_ubicacion.IdMotivoUbicacion INNER JOIN
                  dbo.usuario ON dbo.trans_ubic_hh_enc.user_agr = dbo.usuario.IdUsuario INNER JOIN
                  dbo.usuario_bodega ON dbo.usuario.IdUsuario = dbo.usuario_bodega.IdUsuario INNER JOIN
                  dbo.rol ON dbo.usuario_bodega.IdRol = dbo.rol.IdRol INNER JOIN
                  dbo.propietario_bodega ON dbo.trans_ubic_hh_enc.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega AND dbo.usuario_bodega.IdBodega = dbo.propietario_bodega.IdBodega
GO

/****** CKFK: 29-Mar-24 12:16:10 PM Agregue los campos es_traslado_sap y no_documento******/
ALTER VIEW [dbo].[VW_TransUbicacionHhEnc]
AS
SELECT        dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc, dbo.trans_ubic_hh_enc.IdPropietarioBodega, dbo.trans_ubic_hh_enc.IdMotivoUbicacion, dbo.motivo_ubicacion.Nombre AS DescripcionMotivo, dbo.trans_ubic_hh_enc.FechaInicio, 
                         dbo.trans_ubic_hh_enc.HoraInicio, dbo.trans_ubic_hh_enc.FechaFin, dbo.trans_ubic_hh_enc.HoraFin, dbo.trans_ubic_hh_enc.user_agr, dbo.trans_ubic_hh_enc.fec_agr, dbo.trans_ubic_hh_enc.user_mod, 
                         dbo.trans_ubic_hh_enc.fec_mod, dbo.trans_ubic_hh_enc.Observacion, dbo.trans_ubic_hh_enc.activo, dbo.trans_ubic_hh_enc.operador_por_linea, dbo.trans_ubic_hh_enc.ubicacion_con_hh, dbo.trans_ubic_hh_enc.estado, 
                         dbo.trans_ubic_hh_enc.cambio_estado, dbo.trans_ubic_hh_enc.IdReabastecimientoLog, dbo.trans_ubic_hh_enc.es_traslado_sap, dbo.trans_ubic_hh_enc.no_documento
FROM            dbo.trans_ubic_hh_enc INNER JOIN
                         dbo.motivo_ubicacion ON dbo.trans_ubic_hh_enc.IdMotivoUbicacion = dbo.motivo_ubicacion.IdMotivoUbicacion
GO



/****** Object:  View [dbo].[VW_TransUbicacionHhEnc]    Script Date: 19/11/2021 11:17:35 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_TransUbicacionHhEnc]
AS
SELECT        dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc, dbo.trans_ubic_hh_enc.IdPropietarioBodega, dbo.trans_ubic_hh_enc.IdMotivoUbicacion, dbo.motivo_ubicacion.Nombre AS DescripcionMotivo, dbo.trans_ubic_hh_enc.FechaInicio, 
                         dbo.trans_ubic_hh_enc.HoraInicio, dbo.trans_ubic_hh_enc.FechaFin, dbo.trans_ubic_hh_enc.HoraFin, dbo.trans_ubic_hh_enc.user_agr, dbo.trans_ubic_hh_enc.fec_agr, dbo.trans_ubic_hh_enc.user_mod, 
                         dbo.trans_ubic_hh_enc.fec_mod, dbo.trans_ubic_hh_enc.Observacion, dbo.trans_ubic_hh_enc.activo, dbo.trans_ubic_hh_enc.operador_por_linea, dbo.trans_ubic_hh_enc.ubicacion_con_hh, dbo.trans_ubic_hh_enc.estado, 
                         dbo.trans_ubic_hh_enc.cambio_estado, dbo.trans_ubic_hh_enc.IdReabastecimientoLog
FROM            dbo.trans_ubic_hh_enc INNER JOIN
                         dbo.motivo_ubicacion ON dbo.trans_ubic_hh_enc.IdMotivoUbicacion = dbo.motivo_ubicacion.IdMotivoUbicacion
GO


/****** #CKFK20230215 Se agrego esta funcionalidad para mostrar el operador por tarea de reabastecimiento
/****** Object:  View [dbo].[VW_TransUbicacionHhEnc]    Script Date: 14/02/2023 23:46:13 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[VW_TransUbicacionHhEnc]
AS
SELECT    dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc, dbo.trans_ubic_hh_enc.IdPropietarioBodega, dbo.trans_ubic_hh_enc.IdMotivoUbicacion, dbo.motivo_ubicacion.Nombre AS DescripcionMotivo, dbo.trans_ubic_hh_enc.FechaInicio, 
                         dbo.trans_ubic_hh_enc.HoraInicio, dbo.trans_ubic_hh_enc.FechaFin, dbo.trans_ubic_hh_enc.HoraFin, dbo.trans_ubic_hh_enc.user_agr, dbo.trans_ubic_hh_enc.fec_agr, dbo.trans_ubic_hh_enc.user_mod, 
                         dbo.trans_ubic_hh_enc.fec_mod, dbo.trans_ubic_hh_enc.Observacion, dbo.trans_ubic_hh_enc.activo, dbo.trans_ubic_hh_enc.operador_por_linea, dbo.trans_ubic_hh_enc.ubicacion_con_hh, dbo.trans_ubic_hh_enc.estado, 
                         dbo.trans_ubic_hh_enc.cambio_estado, dbo.trans_ubic_hh_enc.IdReabastecimientoLog,
						 CASE WHEN dbo.trans_ubic_hh_enc.operador_por_linea = 1 AND dbo.trans_ubic_hh_enc.IdReabastecimientoLog <>0  THEN 
						 (SELECT TOP(1) o.nombres + ' ' + o.apellidos
						  FROM dbo.trans_ubic_hh_det h inner join operador_bodega b on h.IdOperadorBodega = b.IdOperadorBodega
						       inner join operador o on o.IdOperador = b.IdOperador
						  WHERE h.IdTareaUbicacionEnc =  dbo.trans_ubic_hh_enc.IdTareaUbicacionEnc) ELSE '' END AS Nombre_Operador
FROM            dbo.trans_ubic_hh_enc INNER JOIN
                         dbo.motivo_ubicacion ON dbo.trans_ubic_hh_enc.IdMotivoUbicacion = dbo.motivo_ubicacion.IdMotivoUbicacion
GO
