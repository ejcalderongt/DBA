'#EJC202310311708: Última versión.
Public Shared Function Reserva_Stock_From_MI3(ByRef pStockResSolicitud As clsBeStock_res,
                                                  ByVal DiasVencimiento As Double,
                                                  ByVal MaquinaQueSolicita As String,
                                                  ByVal pBeConfigEnc As clsBeI_nav_config_enc,
                                                  ByRef pCantidadDisponibleStock As Double,
                                                  ByVal pIdPropietarioBodega As Integer,
                                                  ByRef pListStockResOUT As List(Of clsBeStock_res),
                                                  ByRef lConnection As SqlConnection,
                                                  ByRef ltransaction As SqlTransaction,
                                                  Optional No_Linea As Integer = 0,
                                                  Optional pTarea_Reabasto As Boolean = False,
                                                  Optional ByVal pBeTrasladoDet As clsBeI_nav_ped_traslado_det = Nothing) As Boolean

        Reserva_Stock_From_MI3 = False

        Try



#Region "Variables"

            Dim lBeStockExistente As New List(Of clsBeStock)
            Dim lBeStockExistenteZonasNoPicking As New List(Of clsBeStock)
            Dim lBeStockExistenteZonaPicking As New List(Of clsBeStock)
            Dim lBeStockExistenteZonaPickingPresentacion As New List(Of clsBeStock)
            Dim lBeStockExistenteTmp As New List(Of clsBeStock)
            Dim lBeStockExistenteTomeDesde As New List(Of clsBeStock)
            Dim lBeStockDisponible As New List(Of clsBeStock)
            Dim lBeStockAReservar As New List(Of clsBeStock_res)
            Dim BeProductoPresentacion As New clsBeProducto_Presentacion()
            Dim vIndicePresentacion As Integer = -1
            Dim vIndiceUbicacion As Integer = 0
            Dim vCantidadReservada As Double = 0
            Dim vPesoReservado As Double = 0
            Dim BeProducto As New clsBeProducto
            Dim BeStockRes As New clsBeStock_res
            Dim vCantidadCompletada As Boolean = False
            Dim vCantidadDispStock As Double = 0
            Dim vCantidadPendiente As Double = 0
            Dim vCantidadSolicitadaPedido As Double = 0
            Dim vValorEnteroCantidadSolicitadaPedido As Integer = 0
            Dim vCantidadAReservarPorIdStock As Double = 0
            Dim vCantidadEnteraPres As Integer = 0
            Dim vCantidadDecimalUMBas As Double = 0
            Dim vCantidadStock As Double = 0
            Dim vCantidadStockEnPres As Double = 0
            Dim vDisponibleStockEnPres As Double = 0
            Dim vPesoStock As Double = 0
            Dim vPesoPendiente As Double = 0
            Dim vPesoSolicitadoPedido As Double = 0
            Dim vPesoAReservarPorIdStock As Double = 0
            Dim Idx As Integer = 0
            Dim BePresentacionStock As New clsBeProducto_Presentacion
            Dim vCantidadEnStockEnPres As Double = 0
            Dim vCantidadSolicitadaPedidoEnPres As Double = 0
            Dim vCantidadEnteraStockPres As Double = 0
            Dim vCantidadDecimalStockUMBas As Double = 0
            Dim vPesoEnteroPres As Double = 0
            Dim vPesoDecimalUMBas As Double = 0
            Dim vPesoEnteroPresStock As Double = 0
            Dim vPesoDecimalStockUMBas As Double = 0
            Dim vCantidadDecimalUMBasStock As Double = 0
            Dim BeStockDestino As New clsBeStock
            Dim BeUbicacionStock As New clsBeBodega_ubicacion()
            Dim vCantidadPendienteEnPres As Double = 0
            Dim vCantidadDispStockEnPres As Double = 0
            Dim CantidadEnUMBasPorPresentacionDelStock As Double = 0
            Dim vCantidadEnteraSolicitadaPedidoEnPres As Double = 0
            Dim vCantidadDecimalSolicitadaPedidoEnPres As Double = 0
            Dim IdProducto As Integer = 0
            Dim vSolicitudEsEnUMBas As Boolean = False 'Buscar reservar unidades 
            Dim BeStockOriginal As New clsBeStock()
            Dim vOrdernarListaStockSinPresentacionPrimero As Boolean = False
            Dim vConvirtioCantidadSolicitadaEnUmBas As Boolean = False
            Dim vlBeStockAReservarUMBas As New List(Of clsBeStock_res)
            Dim vCantidadTarimasCompletasAPickearClavaud As Double = 0
            Dim vCantidadEnteraTarimasCompletasClavaud As Double = 0
            Dim vCantidadDecimalTarimasCompletasClavaud As Double = 0
            Dim BeUbicacionEnMemoria As New clsBeBodega_ubicacion()
            Dim vCantidadProductoPorTarima As Double = 0
            Dim vResultCalculoTarimaEstaCompleta As Double = 0
            Dim vCantidadEnStockEnPresentacionClavaud As Double = 0
            Dim lBeStockConPalletsCompletosClavaud As New List(Of clsBeStock)
            Dim lBeStockConPalletsInCompletosClavaud As New List(Of clsBeStock)
            Dim lBeStockZonaPicking As New List(Of clsBeStock)
            Dim lBeStockZonasNoPicking As New List(Of clsBeStock)
            Dim vCantPVConPalletsCompletosClavaud As Integer = 0 'Próximos a vencer
            Dim vCantPVConPalletsInCompletosClavaud As Integer = 0 'Próximos a vencer
            Dim vBusquedaEnUmBas As Boolean = False
            Dim vZonaNoPickingStockEnUmBas As Boolean = False
            Dim vRefCantidadReservada As Double = 0
            Dim vRestoInventarioEnUmBas As Boolean = False
            Dim BePresentacionDefecto As New clsBeProducto_Presentacion
            Dim vEncontroExistenciaEnPresentacion As Boolean = False
            Dim CantidadStockDestino As Double = 0
            Dim BePedidoDet As New clsBeTrans_pe_det
            Dim FechaMinimaVenceStock As Date = New Date(1900, 1, 1)
            Dim ExcepcionFechaVenceEsInferiorEnZonaPicking As Boolean = False
            Dim vFechaMinimaVenceZonaPicking As Date = New Date(1900, 1, 1)
            Dim vFechaMinimaVenceZonaALM As Date = New Date(1900, 1, 1)
            Dim vVenceMinimaPickingCompletoClavaud As Date = New Date(1900, 1, 1)
            Dim vVenceMinimaPickingInCompletoClavaud As Date = New Date(1900, 1, 1)
            Dim ListaEstadosDeProceso As New List(Of Integer)
            Dim vPermitirDecimales As Boolean = False
            Dim BeBodega As New clsBeBodega
            Dim vCantidadStockZonaNoPicking As Double = 0
            Dim vCantidadStockZonaPicking As Double = 0
            Dim vMensajeNoExplosionEnZonasNoPicking = ""
            Dim vCantidadTotalStock As Double = 0
            Dim vStockDispZonaPicking As Integer = 0
            Dim vFechaMinima As Date = New Date(1900, 1, 1)
            Dim Iniciar_En As Integer = 0
            Dim pStockResBusquedaParaExplosion As New clsBeStock_res
#End Region

            Dim vIdPropietario As Integer = clsLnPropietarios.Get_IdPropietario(pStockResSolicitud.IdBodega,
                                                                                pIdPropietarioBodega,
                                                                                lConnection,
                                                                                ltransaction)

            pStockResSolicitud.IdBodega = pBeConfigEnc.Idbodega
            BeBodega = clsLnBodega.GetSingle_By_Idbodega(pBeConfigEnc.Idbodega,
                                                         lConnection,
                                                         ltransaction)

            BePedidoDet = clsLnTrans_pe_det.Get_Single_By_IdPedidoEnc_And_IdPedidoDet(pStockResSolicitud.IdPedido,
                                                                                      pStockResSolicitud.IdPedidoDet,
                                                                                      lConnection,
                                                                                      ltransaction)

            lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                  BeProducto,
                                                  DiasVencimiento,
                                                  pBeConfigEnc,
                                                  lConnection,
                                                  ltransaction,
                                                  IIf(pTarea_Reabasto, True, False),
                                                  False,
                                                  pTarea_Reabasto)


            lBeStockExistenteZonasNoPicking = clsLnStock.lStock(pStockResSolicitud,
                                                                BeProducto,
                                                                DiasVencimiento,
                                                                pBeConfigEnc,
                                                                lConnection,
                                                                ltransaction,
                                                                True,
                                                                False,
                                                                pTarea_Reabasto)

            lBeStockExistenteZonaPicking = clsLnStock.lStock(pStockResSolicitud,
                                                             BeProducto,
                                                             DiasVencimiento,
                                                             pBeConfigEnc,
                                                             lConnection,
                                                             ltransaction,
                                                             False,
                                                             False,
                                                             pTarea_Reabasto)

            If pStockResSolicitud.IdPresentacion <> 0 Then
                If Not lBeStockExistenteZonaPicking Is Nothing Then
                    If lBeStockExistenteZonaPicking.Count > 0 Then
                        lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.FindAll(Function(x) x.UbicacionPicking = True)
                    End If
                End If
            End If

            vFechaMinimaVenceZonaPicking = New Date(1900, 1, 1)
            vFechaMinimaVenceZonaALM = New Date(1900, 1, 1)
            vVenceMinimaPickingCompletoClavaud = New Date(1900, 1, 1)
            vVenceMinimaPickingInCompletoClavaud = New Date(1900, 1, 1)

            If Not lBeStockExistente Is Nothing Then

#Region "RESTAR_STOCK_RESERVADO"

                If lBeStockExistente.Count > 0 Then

                    '#CKFK20230202 Subí esto para que se haga antes 
                    If vOrdernarListaStockSinPresentacionPrimero Then
                        lBeStockExistente = lBeStockExistente.OrderBy(Function(x) x.IdPresentacion).ToList
                    End If


                    Restar_Stock_Reservado(lBeStockExistente,
                                           pBeConfigEnc,
                                           lConnection,
                                           ltransaction)


                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()
                    If lBeStockExistente.Count > 0 Then
                        If FechaMinimaVenceStock.Date = New Date(1900, 1, 1) Then
                            FechaMinimaVenceStock = lBeStockExistente.Min(Function(x) x.Fecha_vence)
                        End If
                    End If

                    If pStockResSolicitud.IdPresentacion = 0 AndAlso Not BeBodega.Permitir_Decimales Then
                        vOrdernarListaStockSinPresentacionPrimero = True : vBusquedaEnUmBas = True
                    Else

                        If lBeStockExistente.Count > 0 Then vEncontroExistenciaEnPresentacion = True

                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = pStockResSolicitud.IdPresentacion}

                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                        If vIndicePresentacion <> -1 Then
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                        Else
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock.IdPresentacion = pStockResSolicitud.IdPresentacion
                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                            lPresentaciones.Add(BePresentacionStock.Clone())
                        End If

                        If Not BePresentacionStock Is Nothing Then

                            If BePresentacionStock.Factor > 0 Then

                                If (BePresentacionStock.CajasPorCama > 0) AndAlso (BePresentacionStock.CamasPorTarima > 0) Then

                                    vCantidadProductoPorTarima = Math.Round(BePresentacionStock.CajasPorCama * BePresentacionStock.CamasPorTarima, 2)

                                    vCantidadTarimasCompletasAPickearClavaud = Math.Round(pStockResSolicitud.Cantidad / vCantidadProductoPorTarima, 2)

                                    Split_Decimal(vCantidadTarimasCompletasAPickearClavaud,
                                                  vCantidadEnteraTarimasCompletasClavaud,
                                                  vCantidadDecimalTarimasCompletasClavaud)

                                End If

                            End If

                        End If

                    End If

                End If

                If lBeStockExistenteZonasNoPicking.Count > 0 Then

                    '#CKFK20230202 Subí esto para que se haga antes 
                    If vOrdernarListaStockSinPresentacionPrimero Then
                        lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.OrderBy(Function(x) x.IdPresentacion).ToList
                    End If


                    Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                           pBeConfigEnc,
                                           lConnection,
                                           ltransaction)

                    lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.Where(Function(x) x.Cantidad > 0).ToList()

                End If

                If lBeStockExistenteZonaPicking.Count > 0 Then

                    '#CKFK20230202 Subí esto para que se haga antes 
                    If vOrdernarListaStockSinPresentacionPrimero Then
                        lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.OrderBy(Function(x) x.IdPresentacion).ToList
                    End If


                    Restar_Stock_Reservado(lBeStockExistenteZonaPicking,
                                           pBeConfigEnc,
                                           lConnection,
                                           ltransaction)

                    lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.Where(Function(x) x.Cantidad > 0).ToList()

                End If

#End Region

#Region "OBTENER_FECHA_MINIMA_DE_INVENTARIO"

                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                  DiasVencimiento,
                                                                                  pBeConfigEnc,
                                                                                  lConnection,
                                                                                  ltransaction,
                                                                                  BeProducto,
                                                                                  pTarea_Reabasto,
                                                                                  vFechaMinimaVenceZonaPicking,
                                                                                  vFechaMinimaVenceZonaALM,
                                                                                  lBeStockExistente,
                                                                                  BePresentacionStock)

                '#EJC202308211030:Esto quiere decir que fuera de la zona de picking hay una fecha más corta de vencimiento.
                'Entonces debería empezar por esa otra lista (la que no es de zonas de picking)
                If lBeStockExistenteZonasNoPicking.Count > 0 Then
                    If vFechaMinimaVenceZonaALM < FechaMinimaVenceStock Then
                        lBeStockExistente = lBeStockExistenteZonasNoPicking
                    End If
                End If

                If FechaMinimaVenceStock.Date = New Date(1900, 1, 1) Then
                    If Not lBeStockExistente Is Nothing Then
                        If lBeStockExistente.Count > 0 Then
                            FechaMinimaVenceStock = lBeStockExistente.Min(Function(x) x.Fecha_vence)
                        End If
                    End If
                End If

#End Region

EXPLOSIONAR_PRODUCTO:

                If (pBeConfigEnc.Explosion_Automatica OrElse pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking) AndAlso (lBeStockExistente.Count = 0 OrElse pStockResSolicitud.IdPresentacion = 0) Then

                    If IdProducto = 0 Then
                        IdProducto = clsLnProducto_bodega.Get_IdProducto_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                             lConnection,
                                                                                             ltransaction)
                    End If

                    If IdProducto <> 0 Then
                        BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                lConnection,
                                                                                                                ltransaction)

                    End If

                    If BeProducto Is Nothing Then
                        BeProducto = clsLnProducto.Get_BeProducto_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                      pBeConfigEnc.Idbodega,
                                                                                      lConnection,
                                                                                      ltransaction)
                    End If

                    If BeProducto Is Nothing Then
                        Throw New Exception("Error_202302021128: No se pudo obtener el objeto de producto asociado al IdProductoBodega: " & pStockResSolicitud.IdProductoBodega)
                    End If

                    If pStockResSolicitud.IdPresentacion = 0 Then
                        vOrdernarListaStockSinPresentacionPrimero = True : vBusquedaEnUmBas = True
                    End If

                    pStockResBusquedaParaExplosion = Nothing


                    If lBeStockExistente.Count = 0 Then '#EJC20230202: Si no se obtuvo stock.
                        If pStockResSolicitud.IdPresentacion = 0 Then '#EJC20230202: Y la primera búsqueda fue en unidades.                            
                            If Not BePresentacionStock Is Nothing Then '#EJC20230202: Entonces voy a buscar inventario en cajas (con la presentación por defecto si existe)
                                clsPublic.CopyObject(pStockResSolicitud, pStockResBusquedaParaExplosion)
                                pStockResBusquedaParaExplosion = pStockResSolicitud.Clone()
                                pStockResBusquedaParaExplosion.IdPresentacion = BePresentacionStock.IdPresentacion
                                vBusquedaEnUmBas = False
                            Else
                                Throw New Exception("ERROR_202302021127: Se está intentando reservar inventario que requiere explosión pero no está definida la presentación por defecto del producto: " & BeProducto.Codigo)
                            End If
                        Else

                            If Not vEncontroExistenciaEnPresentacion Then

                                If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                    Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                               BeProducto.Codigo,
                                                                               pStockResSolicitud.Cantidad,
                                                                               0))
                                Else

                                    If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                        '#CKFK20230324 Agregué esta condición para que busque en unidades si la primera búsqueda fue en presentación
                                        vBusquedaEnUmBas = True
                                    Else
                                        '#EJC20230724 Se agregó esta condición para que cuando el pedido sea en UMBas y ya no haya existencias en presentación busque en UMBas
                                        If Not BePedidoDet Is Nothing Then
                                            If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                                vBusquedaEnUmBas = True
                                            End If
                                        End If
                                    End If

                                End If
                            Else
                                vBusquedaEnUmBas = True
                            End If

                        End If

                    Else
                        '#EJC202310192207: Caso 6, cuando se solicitan unidades y no hay inventario, mantener la variable busquedaumbas = true
                        If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                            vBusquedaEnUmBas = True
                        Else
                            If Not BePedidoDet Is Nothing Then
                                If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                    vBusquedaEnUmBas = True
                                End If
                            End If
                        End If

                    End If

                    If vBusquedaEnUmBas Then

                        Split_Decimal(pStockResSolicitud.Cantidad,
                                      vCantidadEnteraPres,
                                      vCantidadDecimalUMBas)


                        vCantidadDecimalUMBas = Math.Ceiling(Math.Round(vCantidadDecimalUMBas * BePresentacionStock.Factor, 2))

                        If vCantidadEnteraPres > 0 Then

                            If pStockResSolicitud.IdPresentacion <> 0 Then

                                vCantidadSolicitadaPedido = vCantidadEnteraPres
                                '#CKFK20230601 Creo que esto solo aplica cuando vCantidadEnteraPres es mayor que 0 y estoy buscando en UMBas
                                vCantidadSolicitadaPedido = (vCantidadEnteraPres * BePresentacionStock.Factor)

                                '#CKFK20230815 Agregué que si no tengo cantidad en presentación voy a buscar en unidades todo lo que falta
                                If Not vEncontroExistenciaEnPresentacion Then
                                    vCantidadSolicitadaPedido = vCantidadSolicitadaPedido + vCantidadDecimalUMBas
                                    vCantidadDecimalUMBas = 0
                                End If
                            Else
                                vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad
                            End If

                        Else
                            vCantidadSolicitadaPedido = vCantidadDecimalUMBas
                        End If

                        pStockResSolicitud.Cantidad = vCantidadSolicitadaPedido
                        pStockResSolicitud.Atributo_Variante_1 = Nothing
                        pStockResSolicitud.IdPresentacion = 0

                    End If

                    If lBeStockExistente.Count = 0 Then

                        If Not vBusquedaEnUmBas AndAlso pStockResBusquedaParaExplosion Is Nothing Then
                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                           BeProducto.Codigo,
                                                                           pStockResSolicitud.Cantidad,
                                                                           0))
                            Else
                                If Not vCantidadCompletada Then
                                    Dim vMensajeError20230306 As String = String.Format("Error202303051226: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                    BeProducto.Codigo,
                                                                                    vCantidadSolicitadaPedido,
                                                                                    vCantidadStock)
                                    clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "C se realizó exit function con Reserva_Stock_From_MI3 = false")
                                    Exit Function
                                End If
                            End If
                        End If

                        '#EJC202309271639: Se busca explosionar primero de zonas de picking.
                        lBeStockExistenteZonaPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              False,
                                                              True,
                                                              pTarea_Reabasto)

                        Restar_Stock_Reservado(lBeStockExistenteZonaPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        If Not lBeStockExistenteZonaPicking Is Nothing Then

                            If lBeStockExistenteZonaPicking.Count > 0 Then
                                vFechaMinimaVenceZonaPicking = lBeStockExistenteZonaPicking.Min(Function(x) x.Fecha_vence)
                            End If

                        End If

                        lBeStockExistenteZonasNoPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              True,
                                                              True,
                                                              pTarea_Reabasto)

                        Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        If Not lBeStockExistenteZonasNoPicking Is Nothing Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                vFechaMinimaVenceZonaALM = lBeStockExistenteZonasNoPicking.Min(Function(x) x.Fecha_vence)
                            End If
                        End If

                        vRestoInventarioEnUmBas = True

                    End If

                    If vFechaMinimaVenceZonaALM > vFechaMinimaVenceZonaPicking Then
                        If Not lBeStockExistenteZonaPicking Is Nothing Then
                            If lBeStockExistenteZonaPicking.Count > 0 Then
                                lBeStockExistente = lBeStockExistenteZonaPicking
                            End If
                        End If
                    Else
                        If Not lBeStockExistenteZonasNoPicking Is Nothing Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                lBeStockExistente = lBeStockExistenteZonasNoPicking
                                Iniciar_En = 3
                            End If
                        End If
                    End If

                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                    vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                    vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)
                    vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vCantidadSolicitadaPedido = 0 Then
                        vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad
                    End If

                    If (vBusquedaEnUmBas AndAlso lBeStockExistente.Count = 0) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                        If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                            Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       pStockResSolicitud.Cantidad,
                                                                       0))
                        Else
                            If Not vCantidadCompletada Then
                                Dim vMensajeError20230306 As String = String.Format("Error202303051227: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                    BeProducto.Codigo,
                                                                                    vCantidadSolicitadaPedido,
                                                                                    vCantidadStock)

                                clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "D se realizó exit function con Reserva_Stock_From_MI3 = false")

                                Exit Function

                            End If

                        End If

                    Else

                        If lBeStockExistente.Count = 0 Then

                            If pStockResSolicitud.IdPresentacion = 0 Then vBusquedaEnUmBas = True

                            '#CKFK20231009 Puse el conmutar en false porque aqui solo quiero unidades
                            lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                                  BeProducto,
                                                                  DiasVencimiento,
                                                                  pBeConfigEnc,
                                                                  lConnection,
                                                                  ltransaction,
                                                                  True,
                                                                  False,
                                                                  pTarea_Reabasto)

                            Restar_Stock_Reservado(lBeStockExistente,
                                                   pBeConfigEnc,
                                                   lConnection,
                                                   ltransaction)

                            vRestoInventarioEnUmBas = True

                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                            If lBeStockExistente.Count > 0 Then
                                '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                 DiasVencimiento,
                                                                                                 pBeConfigEnc,
                                                                                                 lConnection,
                                                                                                 ltransaction,
                                                                                                 BeProducto,
                                                                                                 pTarea_Reabasto,
                                                                                                 vFechaMinimaVenceZonaPicking,
                                                                                                 vFechaMinimaVenceZonaALM,
                                                                                                 lBeStockExistente,
                                                                                                 BePresentacionDefecto)
                            Else
                                If Not lBeStockExistenteZonaPicking.Count = 0 Then
                                    lBeStockExistente = lBeStockExistenteZonaPicking
                                End If
                            End If

                            vZonaNoPickingStockEnUmBas = lBeStockExistente.Count > 0

                        End If

                        If lBeStockExistente.Count = 0 Then

                            If pStockResSolicitud.IdPresentacion = 0 Then vBusquedaEnUmBas = True

                            '#EJC202309121412: Buscar en zonas de picking  unidades
                            lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                                  BeProducto,
                                                                  DiasVencimiento,
                                                                  pBeConfigEnc,
                                                                  lConnection,
                                                                  ltransaction,
                                                                  False,
                                                                  True,
                                                                  pTarea_Reabasto)


                            Restar_Stock_Reservado(lBeStockExistente,
                                                   pBeConfigEnc,
                                                   lConnection,
                                                   ltransaction)

                            vRestoInventarioEnUmBas = True

                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                             DiasVencimiento,
                                                                                             pBeConfigEnc,
                                                                                             lConnection,
                                                                                             ltransaction,
                                                                                             BeProducto,
                                                                                             pTarea_Reabasto,
                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                             vFechaMinimaVenceZonaALM,
                                                                                             lBeStockExistente,
                                                                                             BePresentacionDefecto)

                        End If

                        If vBusquedaEnUmBas AndAlso lBeStockExistente.Count = 0 Then

                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       pStockResSolicitud.Cantidad,
                                                                       0))
                            Else

                                If Not vCantidadCompletada Then

                                    If Not ListaEstadosDeProceso.Contains(105) Then

                                        If (pBeConfigEnc.Explosion_Automatica) AndAlso (lBeStockExistente.Count = 0 OrElse pStockResSolicitud.IdPresentacion = 0) Then

                                            If Not BePresentacionStock Is Nothing Then '#EJC20230202: Entonces voy a buscar inventario en cajas (con la presentación por defecto si existe)
                                                clsPublic.CopyObject(pStockResSolicitud, pStockResBusquedaParaExplosion)
                                                pStockResBusquedaParaExplosion = pStockResSolicitud.Clone()
                                                pStockResBusquedaParaExplosion.IdPresentacion = BePresentacionStock.IdPresentacion
                                                vBusquedaEnUmBas = False
                                            Else
                                                Throw New Exception("ERROR_202302021127: Se está intentando reservar inventario que requiere explosión pero no está definida la presentación por defecto del producto: " & BeProducto.Codigo)
                                            End If

                                            lBeStockExistente = clsLnStock.lStock(pStockResBusquedaParaExplosion,
                                                                                  BeProducto,
                                                                                  DiasVencimiento,
                                                                                  pBeConfigEnc,
                                                                                  lConnection,
                                                                                  ltransaction,
                                                                                  True,
                                                                                  True,
                                                                                  pTarea_Reabasto)


                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                    pBeConfigEnc,
                                                                    lConnection,
                                                                    ltransaction)

                                            vRestoInventarioEnUmBas = True

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                             DiasVencimiento,
                                                                                                             pBeConfigEnc,
                                                                                                             lConnection,
                                                                                                             ltransaction,
                                                                                                             BeProducto,
                                                                                                             pTarea_Reabasto,
                                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                                             vFechaMinimaVenceZonaALM,
                                                                                                             lBeStockExistente,
                                                                                                             BePresentacionDefecto)

                                            ListaEstadosDeProceso.Add(105)

                                        Else

                                            ListaEstadosDeProceso.Add(105)

                                            Dim vMensajeError20230306 As String = String.Format("Error202303051227: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                        BeProducto.Codigo,
                                                                                        vCantidadSolicitadaPedido,
                                                                                        vCantidadStock)
                                            clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "D se realizó exit function con Reserva_Stock_From_MI3 = false")
                                            Exit Function

                                        End If

                                    Else

                                        Dim vMensajeError20230306 As String = String.Format("Error202303051227: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                        BeProducto.Codigo,
                                                                                        vCantidadSolicitadaPedido,
                                                                                        vCantidadStock)
                                        clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "D se realizó exit function con Reserva_Stock_From_MI3 = false")
                                        Exit Function

                                    End If

                                End If

                            End If

                        End If

                    End If

                End If

                If lBeStockExistente.Count > 0 Then

                    If pStockResSolicitud.IdPresentacion = 0 Then
                        vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad
                    Else

                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = pStockResSolicitud.IdPresentacion}

                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                        If vIndicePresentacion <> -1 Then
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                        Else
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock.IdPresentacion = pStockResSolicitud.IdPresentacion
                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                            lPresentaciones.Add(BePresentacionStock.Clone())
                        End If

                        If BePresentacionStock.EsPallet Then

                            Dim vFactorPallet As Double = (BePresentacionStock.Factor * BePresentacionStock.CajasPorCama * BePresentacionStock.CamasPorTarima)

                            If vFactorPallet > 0 Then
                                vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad * vFactorPallet
                            Else
                                Throw New Exception("No se pudo reservar el stock para el tipo de producto pallet porque los factores de conversión dan un denominador = 0")
                            End If

                        Else

                            If (pBeConfigEnc.Explosion_Automatica) Then

                                Split_Decimal(pStockResSolicitud.Cantidad,
                                              vCantidadEnteraPres,
                                              vCantidadDecimalUMBas)


                                vCantidadDecimalUMBas = Math.Ceiling(Math.Round(vCantidadDecimalUMBas * BePresentacionStock.Factor, 2))

                                If vCantidadEnteraPres > 0 Then
                                    vCantidadSolicitadaPedido = vCantidadEnteraPres
                                Else
                                    vCantidadSolicitadaPedido = vCantidadDecimalUMBas
                                End If

                            Else
                                vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad * BePresentacionStock.Factor
                                vConvirtioCantidadSolicitadaEnUmBas = True
                            End If

                            If Not clsLnProducto.Tiene_Control_Por_Peso_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                            lConnection,
                                                                                            ltransaction) Then

                                If Integer.TryParse(vCantidadSolicitadaPedido, vValorEnteroCantidadSolicitadaPedido) Then
                                    vCantidadSolicitadaPedido = vValorEnteroCantidadSolicitadaPedido
                                Else
                                    vCantidadSolicitadaPedido = Math.Truncate(vCantidadSolicitadaPedido)
                                End If

                            Else
                                vCantidadSolicitadaPedido = Math.Round(vCantidadSolicitadaPedido, 6)
                            End If

                        End If

                    End If

                    If Not lBeStockExistente Is Nothing Then

                        vCantidadStock = lBeStockExistente.Sum(Function(x) x.Cantidad)
                        vDisponibleStockEnPres = lBeStockExistente.Where(Function(x) x.IdPresentacion <> 0).Sum(Function(x) x.Cantidad)
                        vPesoStock = lBeStockExistente.Sum(Function(x) x.Peso)

                        If pBeConfigEnc.Explosion_Automatica Then

                            If pStockResSolicitud.IdPresentacion = 0 Then

                                vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                                vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)
                                vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                                If (vCantidadSolicitadaPedido > vCantidadStock) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                                    BePresentacionDefecto = New clsBeProducto_Presentacion()
                                    BePresentacionDefecto = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                              lConnection,
                                                                                                                              ltransaction)

                                    Dim BeStockResUMBas As New clsBeStock_res
                                    BeStockResUMBas = pStockResSolicitud.Clone()
                                    BeStockResUMBas.IdPresentacion = BePresentacionDefecto.IdPresentacion

                                    lBeStockExistenteTmp = clsLnStock.lStock(BeStockResUMBas,
                                                                             BeProducto,
                                                                             DiasVencimiento,
                                                                             pBeConfigEnc,
                                                                             lConnection,
                                                                             ltransaction,
                                                                             IIf(pTarea_Reabasto, True, False),
                                                                             True,
                                                                             pTarea_Reabasto)

                                    Restar_Stock_Reservado(lBeStockExistenteTmp,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)


                                    lBeStockExistenteTmp = lBeStockExistenteTmp.FindAll(Function(x) x.Cantidad > 0)

                                    vCantidadStock = lBeStockExistenteTmp.Sum(Function(x) x.Cantidad)
                                    vDisponibleStockEnPres = lBeStockExistenteTmp.Where(Function(x) x.IdPresentacion <> 0).Sum(Function(x) x.Cantidad)

                                    vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                                    vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)

                                    vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                                    If (vCantidadSolicitadaPedido > vCantidadStock) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                                        If pBeConfigEnc.Rechazar_pedido_incompleto Then

                                            pCantidadDisponibleStock = vCantidadStock

                                            Throw New Exception(String.Format("Error_202212140140E:  {0} Código:  {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                               BeProducto.Codigo,
                                                                               vCantidadSolicitadaPedido,
                                                                               vCantidadTotalStock))
                                        Else

                                            If (vCantidadSolicitadaPedido > vDisponibleStockEnPres) Then
                                                If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                                    Throw New Exception(String.Format("ERROR_202212140132D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       vCantidadSolicitadaPedido,
                                                                       vCantidadTotalStock))
                                                    'Else
                                                    '    Exit Function
                                                End If
                                            Else
                                                vCantidadSolicitadaPedido = vCantidadStock
                                            End If

                                        End If

                                    End If

                                End If

                            Else

                                If Not BePresentacionStock Is Nothing Then

                                    If (BePresentacionStock.Factor > 0) Then

                                        vCantidadStockEnPres = Math.Round(vCantidadStock / BePresentacionStock.Factor, 6)

                                        vCantidadSolicitadaPedidoEnPres = vCantidadSolicitadaPedido

                                        If vCantidadSolicitadaPedidoEnPres > vCantidadStockEnPres Then

                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                                Throw New Exception(vbNewLine & String.Format("ERROR_202212140132B: {0} Código: {1} Sol: {2} Disp: {3}", clsDalEx.ErrorS0002A, BeProducto.Codigo, vCantidadSolicitadaPedido, vCantidadStockEnPres))
                                            Else
                                                vCantidadCompletada = False
                                            End If

                                        End If

                                    End If

                                End If

                            End If

                        Else

                            vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                            vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)
                            vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                            If (vCantidadSolicitadaPedido > vCantidadStock) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                                If pBeConfigEnc.Rechazar_pedido_incompleto AndAlso Not pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking Then

                                    pCantidadDisponibleStock = vCantidadDispStock
                                    Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}", clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       vCantidadSolicitadaPedido,
                                                                       vCantidadStock))
                                Else

                                    If vCantidadSolicitadaPedido > vDisponibleStockEnPres Then
                                        If pBeConfigEnc.Rechazar_pedido_incompleto Then
                                            Throw New Exception(String.Format("Error_202212140140C: {0} Código: {1} Sol: {2} Disp: {3}",
                                                                              clsDalEx.ErrorS0002A,
                                                                              BeProducto.Codigo,
                                                                              vCantidadSolicitadaPedido,
                                                                              vCantidadStockEnPres))
                                        Else
                                            '#CKFK20230211 Aqregué esta validación para que no me cambie la cantidad reservada
                                            If pStockResSolicitud.IdPresentacion <> 0 Then
                                                vCantidadSolicitadaPedido = vCantidadDispStockEnPres
                                            End If
                                        End If

                                    Else
                                        '#EJC202212140117: Aquí va a nacer otra condición faltante. (caso de unidades).
                                        vCantidadSolicitadaPedido = vCantidadDispStockEnPres
                                    End If

                                End If

                            End If

                        End If

                        '#EJC20180614: Cantidad total disponible en stock.
                        vCantidadDispStock = lBeStockExistente.Sum(Function(x) x.Cantidad)

                        '#CKFK20221116 Por lo que he debuggeado aquí se colocan las cantidades tal como se piden en el pedido
                        vCantidadPendiente = vCantidadSolicitadaPedido

                        If IdProducto = 0 Then
                            IdProducto = BeProducto.IdProducto
                        End If

ANALIZAR_FECHAS_DE_VENCIMIENTO:

#Region "Recalcular stocks y fechas de vencimiento"

                        If pStockResSolicitud.IdPresentacion <> 0 Then
                            If Not pStockResBusquedaParaExplosion Is Nothing Then
                                If pStockResBusquedaParaExplosion.IdProductoBodega = 0 Then
                                    clsPublic.CopyObject(pStockResSolicitud, pStockResBusquedaParaExplosion)
                                    pStockResBusquedaParaExplosion = pStockResSolicitud.Clone()
                                    pStockResBusquedaParaExplosion.IdPresentacion = BePresentacionStock.IdPresentacion
                                End If
                            End If
                        End If

                        '#EJC202309271639: Se busca explosionar primero de zonas de picking.
                        lBeStockExistenteZonaPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              False,
                                                              True,
                                                              pTarea_Reabasto)

                        Restar_Stock_Reservado(lBeStockExistenteZonaPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.FindAll(Function(x) x.Cantidad > 0)

                        lBeStockExistenteZonasNoPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              True,
                                                              True,
                                                              pTarea_Reabasto)


                        Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.FindAll(Function(x) x.Cantidad > 0)

#End Region

                        Restar_Stock_Reservado(lBeStockExistente,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        If lBeStockExistente.Count > 0 Then
                            lBeStockExistente = lBeStockExistente.FindAll(Function(x) x.Cantidad > 0)
                        End If

                        vFechaMinimaVenceZonaPicking = New Date(1900, 1, 1)
                        vFechaMinimaVenceZonaALM = New Date(1900, 1, 1)
                        vVenceMinimaPickingCompletoClavaud = New Date(1900, 1, 1)
                        vVenceMinimaPickingInCompletoClavaud = New Date(1900, 1, 1)

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                          DiasVencimiento,
                                                                                          pBeConfigEnc,
                                                                                          lConnection,
                                                                                          ltransaction,
                                                                                          BeProducto,
                                                                                          pTarea_Reabasto,
                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                          vFechaMinimaVenceZonaALM,
                                                                                          lBeStockExistente,
                                                                                          BePresentacionStock)

                        vFechaMinima = FechaMinimaVenceStock

                        If vFechaMinimaVenceZonaALM > vFechaMinimaVenceZonaPicking Then

                            If Not lBeStockExistenteZonaPicking Is Nothing Then

                                If lBeStockExistenteZonaPicking.Count > 0 Then

                                    lBeStockExistente = lBeStockExistenteZonaPicking

                                    Restar_Stock_Reservado(lBeStockExistente,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)

                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                End If

                            End If

                        Else
                            If Not lBeStockExistenteZonasNoPicking Is Nothing Then
                                If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                    lBeStockExistente = lBeStockExistenteZonasNoPicking
                                    Iniciar_En = 3
                                End If
                            End If
                        End If

                        If pBeConfigEnc.Conservar_Zona_Picking_Clavaud Then

                            vCantPVConPalletsCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = True _
                                                                                           AndAlso x.UbicacionPicking = False _
                                                                                           AndAlso x.Fecha_vence <= FechaMinimaVenceStock).Count()

                            vCantPVConPalletsInCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = False _
                                                                                           AndAlso x.UbicacionPicking = False _
                                                                                           AndAlso x.Fecha_vence <= FechaMinimaVenceStock).Count()


                            'Reservo pallets completos que no están en zonas de picking (generalmente rack o piso)
                            lBeStockConPalletsCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = True _
                                                                                           AndAlso x.UbicacionPicking = False)

                            'Reservo pallets incompletos (Producidos parcialmente o por proceso) de zonas que no son de picing.
                            lBeStockConPalletsInCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = False _
                                                                                           AndAlso x.UbicacionPicking = False)

                            If lBeStockConPalletsCompletosClavaud.Count > 0 Then
                                vVenceMinimaPickingCompletoClavaud = lBeStockConPalletsCompletosClavaud.Min(Function(x) x.Fecha_vence)
                            End If

                            If lBeStockConPalletsInCompletosClavaud.Count > 0 Then
                                vVenceMinimaPickingInCompletoClavaud = lBeStockConPalletsInCompletosClavaud.Min(Function(x) x.Fecha_vence)
                            End If

                            lBeStockZonaPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = True AndAlso x.Cantidad > 0).OrderBy(Function(x) x.Fecha_vence).ToList()
                            lBeStockZonasNoPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = False AndAlso x.Cantidad > 0).OrderBy(Function(x) x.Fecha_vence).ToList()

                        End If

                        If Iniciar_En = 0 Then
                            If pBeConfigEnc.Conservar_Zona_Picking_Clavaud Then

                                If vVenceMinimaPickingCompletoClavaud > vFechaMinima AndAlso (vVenceMinimaPickingCompletoClavaud.Date > New Date(1900, 1, 1)) Then
                                    Iniciar_En = 1
                                End If

                                If vFechaMinima > vVenceMinimaPickingInCompletoClavaud And vVenceMinimaPickingInCompletoClavaud > New Date(1900, 1, 1) Then
                                    Iniciar_En = 2
                                End If

                            End If
                        End If

                        If vFechaMinimaVenceZonaPicking = New Date(1900, 1, 1) AndAlso vFechaMinimaVenceZonaALM = New Date(1900, 1, 1) Then

                            If Not lBeStockExistente Is Nothing Then

                                If lBeStockExistenteZonasNoPicking.Count = 0 Then

                                    pStockResBusquedaParaExplosion = Nothing

                                    If pStockResSolicitud.IdPresentacion = 0 Then '#EJC20230202: Y la primera búsqueda fue en unidades.
                                        If Not BePresentacionStock Is Nothing Then '#EJC20230202: Entonces voy a buscar inventario en cajas (con la presentación por defecto si existe)
                                            clsPublic.CopyObject(pStockResSolicitud, pStockResBusquedaParaExplosion)
                                            pStockResBusquedaParaExplosion = pStockResSolicitud.Clone()
                                            pStockResBusquedaParaExplosion.IdPresentacion = BePresentacionStock.IdPresentacion
                                            vBusquedaEnUmBas = False
                                        Else
                                            Throw New Exception("ERROR_202302021127: Se está intentando reservar inventario que requiere explosión pero no está definida la presentación por defecto del producto: " & BeProducto.Codigo)
                                        End If
                                    Else

                                        If Not vEncontroExistenciaEnPresentacion Then

                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                                Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                               BeProducto.Codigo,
                                                                               pStockResSolicitud.Cantidad,
                                                                               0))
                                            Else

                                                If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                                    '#CKFK20230324 Agregué esta condición para que busque en unidades si la primera búsqueda fue en presentación
                                                    vBusquedaEnUmBas = True
                                                Else
                                                    '#EJC20230724 Se agregó esta condición para que cuando el pedido sea en UMBas y ya no haya existencias en presentación busque en UMBas
                                                    If Not BePedidoDet Is Nothing Then
                                                        If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                                            vBusquedaEnUmBas = True
                                                        End If
                                                    End If
                                                End If

                                            End If
                                        Else
                                            vBusquedaEnUmBas = True
                                        End If
                                    End If

                                    lBeStockExistenteZonasNoPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                                                      pStockResSolicitud,
                                                                                                      pStockResBusquedaParaExplosion),
                                                                                                  BeProducto,
                                                                                                  DiasVencimiento,
                                                                                                  pBeConfigEnc,
                                                                                                  lConnection,
                                                                                                  ltransaction,
                                                                                                  True,
                                                                                                  True,
                                                                                                  pTarea_Reabasto)

                                    Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)

                                    lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.FindAll(Function(x) x.Cantidad > 0)

                                    If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                        vFechaMinimaVenceZonaALM = lBeStockExistenteZonasNoPicking.Min(Function(x) x.Fecha_vence)
                                        If FechaMinimaVenceStock = New Date(1900, 1, 1) OrElse FechaMinimaVenceStock > vFechaMinimaVenceZonaALM Then
                                            vFechaMinima = vFechaMinimaVenceZonaALM
                                            Iniciar_En = 4
                                        End If
                                    End If

                                End If

                            End If

                        End If

                        If Iniciar_En = 0 Then
                            If vFechaMinima > vFechaMinimaVenceZonaPicking And vFechaMinimaVenceZonaPicking > New Date(1900, 1, 1) Then
                                Iniciar_En = 3
                            End If

                            If vFechaMinima > vFechaMinimaVenceZonaALM And vFechaMinimaVenceZonaALM > New Date(1900, 1, 1) Then
                                Iniciar_En = 3
                            End If

                            If vFechaMinima > FechaMinimaVenceStock And FechaMinimaVenceStock > New Date(1900, 1, 1) Then
                                Iniciar_En = 3
                            End If
                        End If

                        If Iniciar_En = 4 Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                lBeStockExistente = lBeStockExistenteZonasNoPicking
                                Iniciar_En = 0
                            End If
                        End If


                        Select Case Iniciar_En
                            Case 1
                                GoTo INICIAR_EN_1 'Tomar pallets completos lBeStockConPalletsCompletosClavaud
                            Case 2
                                GoTo INICIAR_EN_2 'Tomar de pallets incompletos lBeStockConPalletsInCompletosClavaud
                            Case 3
                                GoTo INICIAR_EN_3 'Tomar producto de la zona de picking.
                            Case Else
                                GoTo EJC_202308081248_RESERVAR_DESDE_ULITIMA_LISTA 'Tomar de la lista como la devolvió lStock
                        End Select

INICIAR_EN_1:
                        If Not ListaEstadosDeProceso.Contains(100) Then

                            If pBeConfigEnc.Conservar_Zona_Picking_Clavaud Then

                                For Each vStockOrigen As clsBeStock In lBeStockConPalletsCompletosClavaud

                                    BeStockDestino = New clsBeStock()
                                    clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                    vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                    If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                        ListaEstadosDeProceso.Add(100)
                                        GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                    ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                        ListaEstadosDeProceso.Add(100)
                                        Exit For
                                    Else
                                        ListaEstadosDeProceso.Add(100)
                                    End If

                                    BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                    vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                    If vIndiceUbicacion <> -1 Then
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                    Else
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                        lUbicaciones.Add(BeUbicacionStock.Clone())
                                    End If

                                    If vCantidadDispStock < 0 Then
                                        Throw New Exception("ERROR_202302061300E: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                    End If

                                    If vCantidadDispStock > 0 Then

                                        If pStockResSolicitud.IdPresentacion = 0 Then

                                            If pBeConfigEnc.Explosion_Automatica Then

                                                If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                    If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                        If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                            Continue For

                                                        End If

                                                    End If

                                                Else

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then
                                                        Continue For
                                                    End If

                                                End If

                                            End If

                                        End If

                                        If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                            BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                            vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If

                                            Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                            vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                            vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                            If BeStockRes.Indicador = "" Then BeStockRes.Indicador = "PED"
                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                            ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    vCantidadPendiente -= vCantidadPendiente
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                    BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion
                                                Else

                                                    BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                    BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                    BeStockDestino.Fec_agr = Now
                                                    BeStockDestino.IdPresentacion = 0
                                                    BeStockDestino.Presentacion.IdPresentacion = 0
                                                    BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                    BeStockRes.IdStock = BeStockDestino.IdStock
                                                    BeStockDestino.No_bulto = 1989
                                                    CantidadStockDestino = BeStockDestino.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockDestino.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    clsLnStock.Insertar(BeStockDestino,
                                                                        lConnection,
                                                                        ltransaction)

                                                    If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                    Else
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    End If

                                                    vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                    If vStockOrigen.Cantidad > 0 Then
                                                        clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                    Else
                                                        clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                    End If

                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                    BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220525
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#1_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                                    End If

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                        'Reservar el remanente en cajas completas.
                                                        vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                        BeStockRes = New clsBeStock_res
                                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                        If BeStockRes.Indicador = "" Then
                                                            BeStockRes.Indicador = "PED"
                                                        End If
                                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                        BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                        BeStockRes.Lote = vStockOrigen.Lote
                                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                        BeStockRes.Peso = vStockOrigen.Peso
                                                        BeStockRes.Estado = "UNCOMMITED"
                                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                        BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.IdPicking = 0
                                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                        BeStockRes.IdDespacho = 0
                                                        BeStockRes.añada = vStockOrigen.Añada
                                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.Host = MaquinaQueSolicita

                                                        If BeStockRes.Cantidad = 0 Then
                                                            Throw New Exception("Error_202302061305G: La cantidad a reservar no puede ser 0")
                                                        End If

                                                        CantidadStockDestino = BeStockRes.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                        Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                        vNombreCasoReservaInternoWMS = "CASO_#2_EJC202310090957"
                                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                        Dim vMensajeError20230301ABC As String = String.Format("Error_202303011301A: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                                       BeProducto.Codigo,
                                                                                                       vCantidadSolicitadaPedido,
                                                                                                       BeStockRes.Cantidad)

                                                        clsLnLog_error_wms.Agregar_Error(vMensajeError20230301ABC)

                                                        If Not pBeTrasladoDet Is Nothing Then
                                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                        End If


                                                        Restar_Stock_Reservado(lBeStockConPalletsCompletosClavaud,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                        lBeStockAReservar.Add(BeStockRes)

                                                    End If

                                                    vCantidadCompletada = (vCantidadPendiente = 0)

                                                    vCantidadEnteraTarimasCompletasClavaud -= 1

                                                    If vCantidadCompletada OrElse vCantidadEnteraTarimasCompletasClavaud = 0 Then Exit For

                                                End If

                                            ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)


                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                Else
                                                    Continue For
                                                End If

                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita

                                            If BeStockRes.Cantidad = 0 Then
                                                Throw New Exception("Error_202302061305G: La cantidad a reservar no puede ser 0")
                                            End If

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            If Math.Abs(CantidadStockDestino - Fix(CantidadStockDestino)) Then
                                                Throw New Exception("Error_202303101448C: El valor a insertar en stock sería un valor decimal no válido, se prevendrá continuar para evitar inconvenientes en reserva.")
                                            End If

                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#3_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                            End If

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            vCantidadEnteraTarimasCompletasClavaud -= 1


                                            Restar_Stock_Reservado(lBeStockConPalletsCompletosClavaud,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            If vCantidadCompletada OrElse vCantidadEnteraTarimasCompletasClavaud = 0 Then Exit For

                                        Else

                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                       lConnection,
                                                                                                                                       ltransaction)

                                                If Not BePresentacionStock Is Nothing Then

                                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                    If vIndicePresentacion <> -1 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                    Else
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If

                                                    vSolicitudEsEnUMBas = True

                                                End If

                                            ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                    clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                    If Not BePresentacionStock Is Nothing Then
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If
                                                End If

                                                vSolicitudEsEnUMBas = False

                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If


                                            Split_Decimal(pStockResSolicitud.Cantidad, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            If Not BePresentacionStock Is Nothing Then

                                                vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                            Else

                                                vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                            End If

                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                vCantidadPendienteEnPres = vCantidadPendiente
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                            Else

                                                vCantidadPendienteEnPres = vCantidadPendiente

                                                If pStockResSolicitud.IdPresentacion = 0 Then
                                                    vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                                Else
                                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                                End If

                                                If Not (vStockOrigen.IdPresentacion = 0) Then
                                                    If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                        vConvirtioCantidadSolicitadaEnUmBas = True
                                                    End If
                                                Else
                                                    vCantidadPendiente = vCantidadPendiente
                                                End If

                                            End If

                                            If vSolicitudEsEnUMBas Then

                                                If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                    If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                        clsLnLog_error_wms.Agregar_Error("#EJC202302081729A: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                    End If
                                                End If

                                            End If

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If Not vSolicitudEsEnUMBas Then
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            End If

                                            If vCantidadPendiente = vCantidadDispStock Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            ElseIf vCantidadPendiente < vCantidadDispStock Then
                                                Exit For 'No seguir buscando porque se infiere que no se logrará reservar nada que sea una tarima completa.
                                            ElseIf vCantidadPendiente > vCantidadDispStock Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)


                                            vNombreCasoReservaInternoWMS = "CASO_#4_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                            End If

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            vCantidadEnteraTarimasCompletasClavaud -= 1


                                            Restar_Stock_Reservado(lBeStockConPalletsCompletosClavaud,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            If vCantidadCompletada OrElse vCantidadEnteraTarimasCompletasClavaud = 0 Then Exit For

                                        End If

                                    End If

                                Next

INICIAR_EN_2:
                                If Not vCantidadCompletada Then

                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                      DiasVencimiento,
                                                                                                      pBeConfigEnc,
                                                                                                      lConnection,
                                                                                                      ltransaction,
                                                                                                      BeProducto,
                                                                                                      pTarea_Reabasto,
                                                                                                      vFechaMinimaVenceZonaPicking,
                                                                                                      vFechaMinimaVenceZonaALM,
                                                                                                      lBeStockExistente,
                                                                                                      BePresentacionStock)

                                    '#EJC202303031732: Condición y parametrizacióin solicitada por Carolina.
                                    If pTarea_Reabasto Then

                                        If pBeConfigEnc.considerar_paletizado_en_reabasto Then

                                            Dim vMensajeNoRellenado As String = "Error_202303031731: La tarea de reabasto para: " & pStockResSolicitud.Codigo_Producto & " no se generará porque no hay tarimas completas y la configuración está activa."

                                            Dim vMsgError As String = String.Format("{0} {1}", MethodBase.GetCurrentMethod.Name(), vMensajeNoRellenado)
                                            clsLnLog_error_wms.Agregar_Error(vMsgError)

                                            XtraMessageBox.Show(vMensajeNoRellenado,
                                                            "Reabasto",
                                                            MessageBoxButtons.OK,
                                                            MessageBoxIcon.Error)

                                            Exit Function

                                        End If

                                    End If

                                    For Each vStockOrigen As clsBeStock In lBeStockConPalletsInCompletosClavaud

                                        BeStockDestino = New clsBeStock()

                                        clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                        vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                        If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) AndAlso Not ListaEstadosDeProceso.Contains(101) AndAlso ListaEstadosDeProceso.Contains(100) Then
                                            ListaEstadosDeProceso.Add(101)
                                            GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                        ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                            ListaEstadosDeProceso.Add(101)
                                            Exit For
                                        Else
                                            ListaEstadosDeProceso.Add(101)
                                        End If

                                        BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                        vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                        If vIndiceUbicacion <> -1 Then
                                            BeUbicacionStock = New clsBeBodega_ubicacion()
                                            BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                        Else
                                            BeUbicacionStock = New clsBeBodega_ubicacion()
                                            BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                            lUbicaciones.Add(BeUbicacionStock.Clone())

                                        End If

                                        If vCantidadDispStock < 0 Then
                                            Throw New Exception("ERROR_202302061300F: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                        End If

                                        '#EJC20180620: Si la cantidad de un IdStock es 0, es porque la cantidad reservada es igual a lo disponible, por eso se valida aquí.
                                        If vCantidadDispStock > 0 Then

                                            If pStockResSolicitud.IdPresentacion = 0 Then

                                                If pBeConfigEnc.Explosion_Automatica Then

                                                    If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                        If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                            If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                                Continue For

                                                            End If

                                                        End If

                                                    Else

                                                        If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                            Continue For

                                                        End If

                                                    End If

                                                End If

                                            End If

                                            If (pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0) OrElse vBusquedaEnUmBas Then

                                                BePresentacionStock = Nothing
                                                vIndicePresentacion = -1

                                                If vStockOrigen.IdPresentacion <> 0 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}
                                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)
                                                End If

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    If Not vStockOrigen.IdPresentacion = 0 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                        clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                        If Not BePresentacionStock Is Nothing Then
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If
                                                    Else
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                            lConnection,
                                                                                                                                            ltransaction)

                                                        If Not BePresentacionStock Is Nothing Then
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If
                                                    End If
                                                End If

                                                If Not BePresentacionStock Is Nothing And Not vBusquedaEnUmBas Then
                                                    If Not BePresentacionStock.Factor = 0 Then
                                                        vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                                    End If
                                                End If

                                                Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                                Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                                If vCantidadDecimalStockUMBas = 0 AndAlso vBusquedaEnUmBas Then
                                                    vCantidadDecimalStockUMBas = pStockResSolicitud.Cantidad
                                                End If

                                                If Not vBusquedaEnUmBas Then

                                                    If BePresentacionStock.Factor > 0 Then
                                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                                    End If

                                                    vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                                End If

                                                BeStockRes = New clsBeStock_res
                                                BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                BeStockRes.Indicador = IIf(BeStockRes.Indicador = "", "PED", BeStockRes.Indicador)
                                                BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                BeStockRes.IdStock = vStockOrigen.IdStock
                                                BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                    Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                    If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                                        vCantidadPendiente -= vCantidadPendiente
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                        vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                        BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                                    Else

                                                        BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                        BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                        BeStockDestino.Fec_agr = Now
                                                        BeStockDestino.IdPresentacion = 0
                                                        BeStockDestino.Presentacion.IdPresentacion = 0
                                                        BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                        BeStockRes.IdStock = BeStockDestino.IdStock
                                                        BeStockDestino.No_bulto = 1989

                                                        CantidadStockDestino = BeStockDestino.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        clsLnStock.Insertar(BeStockDestino,
                                                                            lConnection,
                                                                            ltransaction)


                                                        If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                            vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                        Else
                                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                                        End If

                                                        vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                        If vStockOrigen.Cantidad > 0 Then
                                                            clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                        Else
                                                            clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                        End If

                                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                        vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                        BeStockRes.IdPresentacion = IIf(BeStockRes.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                        BeStockRes.Lote = vStockOrigen.Lote
                                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                        BeStockRes.Peso = vStockOrigen.Peso
                                                        BeStockRes.Estado = "UNCOMMITED"
                                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                        BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.IdPicking = 0
                                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                        BeStockRes.IdDespacho = 0
                                                        BeStockRes.añada = vStockOrigen.Añada
                                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.Host = MaquinaQueSolicita
                                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                        CantidadStockDestino = BeStockRes.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                        vNombreCasoReservaInternoWMS = "CASO_#5_EJC202310090957"
                                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                        If Not pBeTrasladoDet Is Nothing Then
                                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                         BeProducto,
                                                                                                                         lConnection,
                                                                                                                         ltransaction)
                                                        End If

                                                        lBeStockAReservar.Add(BeStockRes)


                                                        Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                        vCantidadDecimalTarimasCompletasClavaud -= 1

                                                        If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                            vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                            BeStockRes = New clsBeStock_res
                                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                            BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                            BeStockRes.Lote = vStockOrigen.Lote
                                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                            BeStockRes.Peso = vStockOrigen.Peso
                                                            BeStockRes.Estado = "UNCOMMITED"
                                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                            BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                            BeStockRes.IdPicking = 0
                                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                            BeStockRes.IdDespacho = 0
                                                            BeStockRes.añada = vStockOrigen.Añada
                                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                            BeStockRes.Host = MaquinaQueSolicita
                                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                            If BeStockRes.Cantidad = 0 Then
                                                                Throw New Exception("Error_202302061305A: La cantidad a reservar no puede ser 0")
                                                            End If

                                                            CantidadStockDestino = BeStockRes.Cantidad

                                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                            Insertar(BeStockRes,
                                                                     lConnection,
                                                                     ltransaction)

                                                            vNombreCasoReservaInternoWMS = "CASO_#6_EJC202310090957"
                                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                            If Not pBeTrasladoDet Is Nothing Then
                                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                             BeProducto,
                                                                                                                             lConnection,
                                                                                                                             ltransaction)
                                                            End If

                                                            lBeStockAReservar.Add(BeStockRes)


                                                            Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                            vCantidadDecimalTarimasCompletasClavaud -= 1

                                                        End If

                                                        vCantidadCompletada = (vCantidadPendiente = 0)

                                                        If vCantidadCompletada Then Exit For

                                                    End If

                                                ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                    Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                    If Not vBusquedaEnUmBas Then
                                                        If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                                            vCantidadPendiente -= vCantidadDispStock
                                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                        Else
                                                            Continue For
                                                        End If
                                                    Else
                                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                                        vCantidadPendiente -= vCantidadDispStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                        vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                                    End If

                                                End If
                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                If BeStockRes.Cantidad = 0 Then
                                                    Throw New Exception("Error_202302061305A: La cantidad a reservar no puede ser 0")
                                                End If

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#7_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)

                                                lBeStockAReservar.Add(BeStockRes)


                                                Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                                vCantidadDecimalTarimasCompletasClavaud -= 1

                                                If vCantidadCompletada Then Exit For

                                            Else

                                                'Se pidió en UMBAS y el stock está en UMBAS
                                                If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                       lConnection,
                                                                                                                                       ltransaction)

                                                    If Not BePresentacionStock Is Nothing Then

                                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                        If vIndicePresentacion <> -1 Then
                                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                        Else
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If

                                                        vSolicitudEsEnUMBas = True

                                                    End If


                                                ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                                    If vIndicePresentacion <> -1 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                    Else
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                        clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                        If Not BePresentacionStock Is Nothing Then
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If
                                                    End If

                                                    vSolicitudEsEnUMBas = False

                                                End If

                                                If Not BePresentacionStock Is Nothing Then
                                                    vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                                End If

                                                If Not (pStockResSolicitud.IdPresentacion = 0) Then
                                                    Split_Decimal(pStockResSolicitud.Cantidad, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                                    Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)
                                                Else
                                                    vCantidadDecimalStockUMBas = pStockResSolicitud.Cantidad
                                                End If

                                                If Not BePresentacionStock Is Nothing Then
                                                    If Not (pStockResSolicitud.IdPresentacion = 0) Then
                                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                                    End If
                                                Else
                                                    vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                                End If


                                                If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                    vCantidadPendienteEnPres = vCantidadPendiente
                                                    vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                                Else

                                                    vCantidadPendienteEnPres = vCantidadPendiente

                                                    If pStockResSolicitud.IdPresentacion = 0 Then
                                                        vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                                    Else
                                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                                    End If

                                                    If Not (vStockOrigen.IdPresentacion = 0) Then
                                                        If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                            vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                            vConvirtioCantidadSolicitadaEnUmBas = True
                                                        End If
                                                    Else
                                                        vCantidadPendiente = vCantidadPendiente
                                                    End If

                                                End If

                                                If vSolicitudEsEnUMBas Then

                                                    If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                        If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso (vCantidadDispStockEnPres < BePresentacionStock.Factor)) OrElse (vCantidadPendienteEnPres < vCantidadDispStockEnPres) Then
                                                            Continue For
                                                        End If
                                                    End If

                                                End If

                                                BeStockRes = New clsBeStock_res
                                                BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                BeStockRes.IdStock = vStockOrigen.IdStock
                                                BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                                If Not vSolicitudEsEnUMBas Then
                                                    BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                End If

                                                If vCantidadPendiente = vCantidadDispStock Then

                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                ElseIf vCantidadPendiente < vCantidadDispStock Then

                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                End If

                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                If BeStockRes.Cantidad = 0 Then
                                                    Throw New Exception("Error_202302061305B: La cantidad a reservar no puede ser 0")
                                                End If

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#8_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)
                                                lBeStockAReservar.Add(BeStockRes)


                                                Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                                If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then
                                                    vCantidadDecimalUMBas = vCantidadPendiente
                                                Else
                                                    If vCantidadPendiente = 0 AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                                        vCantidadDecimalUMBas = 0
                                                    Else
                                                        If lBeStockConPalletsInCompletosClavaud.Count = 1 AndAlso
                                                        lBeStockConPalletsInCompletosClavaud.Item(0).Cantidad = 0 AndAlso
                                                        vCantidadPendiente > 0 AndAlso vBusquedaEnUmBas Then
                                                            vCantidadDecimalUMBas = vCantidadPendiente
                                                        End If
                                                    End If
                                                End If

                                                vCantidadDecimalTarimasCompletasClavaud -= 1

                                                If vCantidadCompletada Then
                                                    Exit For
                                                End If

                                            End If

                                        End If

                                    Next

                                End If

                            End If

                        End If

                    End If
INICIAR_EN_3:
                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                         DiasVencimiento,
                                                                                         pBeConfigEnc,
                                                                                         lConnection,
                                                                                         ltransaction,
                                                                                         BeProducto,
                                                                                         pTarea_Reabasto,
                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                         vFechaMinimaVenceZonaALM,
                                                                                         lBeStockExistente,
                                                                                         BePresentacionStock)

                        '#EJC202308081023: Tomar producto de la zona de picking.
                        If lBeStockZonaPicking.Count = 0 Then
                            If lBeStockExistente.Count > 0 Then
                                lBeStockZonaPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = True AndAlso x.Cantidad > 0).ToList()
                            End If
                        End If

                        '#EJC202308081023: Tomar producto de las zonas de NO picking.
                        lBeStockZonasNoPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = False AndAlso x.Cantidad > 0).ToList()

                    End If


EJC_202308081248_RESERVAR_DESDE_ZONA_PICKING:
#Region "Reservar stock de zona de picking"

                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                         DiasVencimiento,
                                                                                         pBeConfigEnc,
                                                                                         lConnection,
                                                                                         ltransaction,
                                                                                         BeProducto,
                                                                                         pTarea_Reabasto,
                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                         vFechaMinimaVenceZonaALM,
                                                                                         lBeStockExistente,
                                                                                         BePresentacionStock)

                        If Not ExcepcionFechaVenceEsInferiorEnZonaPicking Then

                            If pStockResSolicitud.IdPresentacion = 0 Then
                                '#EJC: Verificar que en ALM, no existan unidades antes de llevar de PICK.
                                lBeStockExistenteZonasNoPicking = clsLnStock.lStock(pStockResSolicitud,
                                                                                    BeProducto,
                                                                                    DiasVencimiento,
                                                                                    pBeConfigEnc,
                                                                                    lConnection,
                                                                                    ltransaction,
                                                                                    True,
                                                                                    False,
                                                                                    pTarea_Reabasto)

                                Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                                       pBeConfigEnc,
                                                       lConnection,
                                                       ltransaction)

                                lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.Where(Function(x) x.Cantidad > 0).ToList()

                            End If

                            For Each vStockOrigen As clsBeStock In lBeStockZonaPicking

                                BeStockDestino = New clsBeStock()
                                clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) AndAlso Not ListaEstadosDeProceso.Contains(100) AndAlso Not ListaEstadosDeProceso.Contains(101) AndAlso Not ListaEstadosDeProceso.Contains(102) Then
                                    ListaEstadosDeProceso.Add(102)
                                    GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                    If Not ListaEstadosDeProceso.Contains(102) Then
                                        ListaEstadosDeProceso.Add(102)
                                    End If
                                    GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                Else
                                    If Not ListaEstadosDeProceso.Contains(102) Then
                                        ListaEstadosDeProceso.Add(102)
                                    End If
                                End If

                                BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                If vIndiceUbicacion <> -1 Then
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                Else
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                    If Not BeUbicacionStock Is Nothing Then
                                        lUbicaciones.Add(BeUbicacionStock.Clone())
                                    End If
                                End If

                                If vCantidadDispStock < 0 Then
                                    Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                End If

                                If vCantidadDispStock > 0 Then

                                    If pStockResSolicitud.IdPresentacion = 0 Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                        Continue For

                                                    End If

                                                End If

                                            Else

                                                If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                    Continue For

                                                End If

                                            End If

                                        End If


                                    End If

                                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                            Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                                vCantidadPendiente -= vCantidadPendiente
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                            Else

                                                BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                BeStockDestino.Fec_agr = Now
                                                BeStockDestino.IdPresentacion = 0
                                                BeStockDestino.Presentacion.IdPresentacion = 0
                                                BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                BeStockRes.IdStock = BeStockDestino.IdStock
                                                BeStockDestino.No_bulto = 1989

                                                CantidadStockDestino = BeStockDestino.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                clsLnStock.Insertar(BeStockDestino,
                                                                        lConnection,
                                                                        ltransaction)

                                                If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                Else
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                End If

                                                '#EJC20220510: Quitar al stock en cajas, las unidades.
                                                vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                If vStockOrigen.Cantidad > 0 Then
                                                    clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                Else
                                                    clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                End If

                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#9_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                End If


                                                Restar_Stock_Reservado(lBeStockZonaPicking,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                                lBeStockAReservar.Add(BeStockRes)

                                                lBeStockZonaPicking = lBeStockZonaPicking.Where(Function(x) x.Cantidad > 0).ToList()

                                                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                 DiasVencimiento,
                                                                                                                 pBeConfigEnc,
                                                                                                                 lConnection,
                                                                                                                 ltransaction,
                                                                                                                 BeProducto,
                                                                                                                 pTarea_Reabasto,
                                                                                                                 vFechaMinimaVenceZonaPicking,
                                                                                                                 vFechaMinimaVenceZonaALM,
                                                                                                                 lBeStockExistente,
                                                                                                                 BePresentacionDefecto)

                                                If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                    'Reservar el remanente en cajas completas.
                                                    vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                    BeStockRes = New clsBeStock_res
                                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                    BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#10_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                    End If

                                                    Restar_Stock_Reservado(lBeStockZonaPicking,
                                                                           pBeConfigEnc,
                                                                           lConnection,
                                                                           ltransaction)

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    lBeStockZonaPicking = lBeStockZonaPicking.Where(Function(x) x.Cantidad > 0).ToList()

                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionDefecto)

                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)

                                                If vCantidadCompletada Then
                                                    Exit For
                                                End If

                                            End If

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                '#EJC202310311502_CASO03
                                                Dim vCantPendientePres As Double = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)

                                                If (vCantPendientePres - vCantidadPendienteEnPres) > 0 Then
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                                Else
                                                    vCantidadPendienteEnPres -= vCantPendientePres
                                                End If

                                            Else
                                                Continue For
                                            End If

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS += "CASO_#11_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then

                                            If BeStockRes.IdPresentacion = 0 Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS += BeStockRes.Cantidad
                                            Else
                                                pBeTrasladoDet.Quantity_Reserved_WMS += Math.Round(BeStockRes.Cantidad / BePresentacionStock.Factor, 6)
                                            End If

                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If

                                        Restar_Stock_Reservado(lBeStockZonaPicking,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockZonaPicking = lBeStockZonaPicking.Where(Function(x) x.Cantidad > 0).ToList()

                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                         DiasVencimiento,
                                                                                                         pBeConfigEnc,
                                                                                                         lConnection,
                                                                                                         ltransaction,
                                                                                                         BeProducto,
                                                                                                         pTarea_Reabasto,
                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                         lBeStockExistente,
                                                                                                         BePresentacionDefecto)
                                        If vCantidadCompletada Then
                                            Exit For
                                        End If

                                    Else
                                        'Se pidió en UMBAS y el stock está en UMBAS
                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                        lConnection,
                                                                                                                                        ltransaction)

                                            If Not BePresentacionStock Is Nothing Then

                                                vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If

                                                vSolicitudEsEnUMBas = True

                                            End If


                                        ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            vSolicitudEsEnUMBas = False

                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        Else
                                            vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                        End If

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            vCantidadPendienteEnPres = vCantidadPendiente
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                        Else

                                            vCantidadPendienteEnPres = vCantidadPendiente

                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                            Else
                                                vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                            End If

                                            If Not (vStockOrigen.IdPresentacion = 0) Then
                                                If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                    vConvirtioCantidadSolicitadaEnUmBas = True
                                                End If
                                            Else
                                                vCantidadPendiente = vCantidadPendiente
                                            End If

                                        End If

                                        If vSolicitudEsEnUMBas Then
                                            If vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                            ElseIf vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                    clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                End If
                                            End If
                                        End If

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If Not vSolicitudEsEnUMBas Then
                                            BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                        End If

                                        If vCantidadPendiente = vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente < vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#12_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                        End If

                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                          DiasVencimiento,
                                                                                                          pBeConfigEnc,
                                                                                                          lConnection,
                                                                                                          ltransaction,
                                                                                                          BeProducto,
                                                                                                          pTarea_Reabasto,
                                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                                          vFechaMinimaVenceZonaALM,
                                                                                                          lBeStockExistente,
                                                                                                          BePresentacionStock)

                                        If vCantidadCompletada Then
                                            Exit For
                                        End If

                                    End If

                                End If

                            Next

                        Else

#Region "Reserverar stock de zona NO Picking"

                            If Not vCantidadCompletada Then

                                For Each vStockOrigen As clsBeStock In lBeStockZonasNoPicking

                                    BeStockDestino = New clsBeStock()
                                    clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                    vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                    If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(100) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(101) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(102) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(103) Then
                                        ListaEstadosDeProceso.Add(103)
                                        Exit For
                                    ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                        ListaEstadosDeProceso.Add(103)
                                        Exit For
                                    Else
                                        ListaEstadosDeProceso.Add(103)
                                    End If

                                    BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                    vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                    If vIndiceUbicacion <> -1 Then
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                    Else
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                        If Not BeUbicacionStock Is Nothing Then
                                            lUbicaciones.Add(BeUbicacionStock.Clone())
                                        End If
                                    End If


                                    If vCantidadDispStock < 0 Then
                                        Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                    End If

                                    '#EJC20180620: Si la cantidad de un IdStock es 0, es porque la cantidad reservada es igual a lo disponible, por eso se valida aquí.
                                    If vCantidadDispStock > 0 Then

                                        If pStockResSolicitud.IdPresentacion = 0 Then

                                            If pBeConfigEnc.Explosion_Automatica Then

                                                If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                    If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                        If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                            Continue For

                                                        End If

                                                    End If

                                                Else

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                        Continue For

                                                    End If

                                                End If

                                            End If


                                        End If

                                        If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                            BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                            vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If

                                            Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))

                                            vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                            vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion

                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)

                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                            ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    vCantidadPendiente -= vCantidadPendiente
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                    BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                                Else


                                                    BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)

                                                    BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                    BeStockDestino.Fec_agr = Now
                                                    BeStockDestino.IdPresentacion = 0
                                                    BeStockDestino.Presentacion.IdPresentacion = 0
                                                    BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                    BeStockRes.IdStock = BeStockDestino.IdStock
                                                    BeStockDestino.No_bulto = 1989

                                                    CantidadStockDestino = BeStockDestino.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    clsLnStock.Insertar(BeStockDestino,
                                                                        lConnection,
                                                                        ltransaction)

                                                    If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                    Else
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    End If

                                                    vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                    If vStockOrigen.Cantidad > 0 Then
                                                        clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                    Else
                                                        clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                    End If

                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado

                                                    BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#13_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                    End If

                                                    Restar_Stock_Reservado(lBeStockExistente,
                                                                           pBeConfigEnc,
                                                                           lConnection,
                                                                           ltransaction)

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionDefecto)

                                                    If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                        vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                        BeStockRes = New clsBeStock_res
                                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion

                                                        If pStockResSolicitud.Indicador = "" Then
                                                            BeStockRes.Indicador = "PED"
                                                        Else
                                                            BeStockRes.Indicador = pStockResSolicitud.Indicador
                                                        End If

                                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                        BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                        BeStockRes.Lote = vStockOrigen.Lote
                                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                        BeStockRes.Peso = vStockOrigen.Peso
                                                        BeStockRes.Estado = "UNCOMMITED"
                                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                        BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.IdPicking = 0
                                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                        BeStockRes.IdDespacho = 0
                                                        BeStockRes.añada = vStockOrigen.Añada
                                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.Host = MaquinaQueSolicita
                                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1
                                                        CantidadStockDestino = BeStockRes.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        vNombreCasoReservaInternoWMS = "CASO_#14_EJC202310090957"
                                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                        Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                        If Not pBeTrasladoDet Is Nothing Then
                                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                         BeProducto,
                                                                                                                         lConnection,
                                                                                                                         ltransaction)
                                                        End If


                                                        Restar_Stock_Reservado(lBeStockExistente,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                        lBeStockAReservar.Add(BeStockRes)

                                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                         DiasVencimiento,
                                                                                                                         pBeConfigEnc,
                                                                                                                         lConnection,
                                                                                                                         ltransaction,
                                                                                                                         BeProducto,
                                                                                                                         pTarea_Reabasto,
                                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                                         lBeStockExistente,
                                                                                                                         BePresentacionDefecto)

                                                    End If

                                                    vCantidadCompletada = (vCantidadPendiente = 0)

                                                    If vCantidadCompletada Then
                                                        Exit For
                                                    End If

                                                End If

                                            ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                Else
                                                    Continue For
                                                End If

                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#15_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                            End If

                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                              DiasVencimiento,
                                                                                                              pBeConfigEnc,
                                                                                                              lConnection,
                                                                                                              ltransaction,
                                                                                                              BeProducto,
                                                                                                              pTarea_Reabasto,
                                                                                                              vFechaMinimaVenceZonaPicking,
                                                                                                              vFechaMinimaVenceZonaALM,
                                                                                                              lBeStockExistente,
                                                                                                              BePresentacionStock)

                                            If vCantidadCompletada Then
                                                Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                              BeProducto.Codigo,
                                                                                              vCantidadSolicitadaPedido,
                                                                                              BeStockRes.Cantidad)
                                                clsLnLog_error_wms.Agregar_Error(Log_20230301_N)
                                                Exit For
                                            End If

                                        Else
                                            'Se pidió en UMBAS y el stock está en UMBAS
                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                        lConnection,
                                                                                                                                        ltransaction)

                                                If Not BePresentacionStock Is Nothing Then

                                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                    If vIndicePresentacion <> -1 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                    Else
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If

                                                    vSolicitudEsEnUMBas = True

                                                End If


                                            ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                    clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                    If Not BePresentacionStock Is Nothing Then
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If
                                                End If

                                                vSolicitudEsEnUMBas = False

                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If

                                            Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                            Else
                                                vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                            End If

                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                vCantidadPendienteEnPres = vCantidadPendiente
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                            Else

                                                vCantidadPendienteEnPres = vCantidadPendiente

                                                If pStockResSolicitud.IdPresentacion = 0 Then
                                                    vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                                Else
                                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                                End If

                                                If Not (vStockOrigen.IdPresentacion = 0) Then
                                                    If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                        vConvirtioCantidadSolicitadaEnUmBas = True
                                                    End If
                                                Else
                                                    vCantidadPendiente = vCantidadPendiente
                                                End If

                                            End If

                                            If vSolicitudEsEnUMBas Then
                                                If vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                ElseIf vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                    If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                        clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                    End If
                                                End If
                                            End If

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If Not vSolicitudEsEnUMBas Then
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            End If

                                            If vCantidadPendiente = vCantidadDispStock Then

                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            ElseIf vCantidadPendiente < vCantidadDispStock Then

                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#16_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                            End If


                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                              DiasVencimiento,
                                                                                                              pBeConfigEnc,
                                                                                                              lConnection,
                                                                                                              ltransaction,
                                                                                                              BeProducto,
                                                                                                              pTarea_Reabasto,
                                                                                                              vFechaMinimaVenceZonaPicking,
                                                                                                              vFechaMinimaVenceZonaALM,
                                                                                                              lBeStockExistente,
                                                                                                              BePresentacionStock)

                                            If vCantidadCompletada Then
                                                Exit For
                                            End If

                                        End If

                                    End If

                                Next

                            End If
#End Region

                        End If

                    End If

#End Region

EJC_202308081248_RESERVAR_DESDE_ZONA_NO_PICKING:
#Region "Reservar stock de zona NO Picking"

                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                          DiasVencimiento,
                                                                                          pBeConfigEnc,
                                                                                          lConnection,
                                                                                          ltransaction,
                                                                                          BeProducto,
                                                                                          pTarea_Reabasto,
                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                          vFechaMinimaVenceZonaALM,
                                                                                          lBeStockExistente,
                                                                                          BePresentacionStock)

                        If lBeStockZonasNoPicking.Count = 0 Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                lBeStockZonasNoPicking = lBeStockExistenteZonasNoPicking
                                Restar_Stock_Reservado(lBeStockZonasNoPicking,
                                                       pBeConfigEnc,
                                                       lConnection,
                                                       ltransaction)

                                If Not lBeStockZonasNoPicking Is Nothing Then
                                    If lBeStockZonasNoPicking.Count > 0 Then
                                        lBeStockZonasNoPicking = lBeStockZonasNoPicking.Where(Function(x) x.UbicacionPicking = False _
                                                                                              AndAlso x.Cantidad > 0).OrderBy(Function(x) x.Fecha_vence).ToList()
                                    End If
                                End If
                            End If
                        End If

                        For Each vStockOrigen As clsBeStock In lBeStockZonasNoPicking

                            BeStockDestino = New clsBeStock()
                            clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                            vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                            If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(100) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(101) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(102) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(103) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(104) Then
                                If Not ListaEstadosDeProceso.Contains(104) Then
                                    ListaEstadosDeProceso.Add(104)
                                End If
                                GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                            ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                If Not ListaEstadosDeProceso.Contains(104) Then
                                    ListaEstadosDeProceso.Add(104)
                                End If
                                GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                            Else
                                If Not ListaEstadosDeProceso.Contains(104) Then
                                    ListaEstadosDeProceso.Add(104)
                                End If
                            End If

                            BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                            vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                          AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                            If vIndiceUbicacion <> -1 Then
                                BeUbicacionStock = New clsBeBodega_ubicacion()
                                BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                            Else
                                BeUbicacionStock = New clsBeBodega_ubicacion()
                                BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                    vStockOrigen.IdBodega,
                                                                                                                    lConnection,
                                                                                                                    ltransaction)
                                If Not BeUbicacionStock Is Nothing Then
                                    lUbicaciones.Add(BeUbicacionStock.Clone())
                                End If
                            End If

                            If vCantidadDispStock < 0 Then
                                Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                            End If

                            '#EJC20180620: Si la cantidad de un IdStock es 0, es porque la cantidad reservada es igual a lo disponible, por eso se valida aquí.
                            If vCantidadDispStock > 0 Then

                                If pStockResSolicitud.IdPresentacion = 0 Then

                                    If pBeConfigEnc.Explosion_Automatica Then

                                        If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                            If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then
                                                Continue For
                                            End If

                                        End If

                                    End If

                                End If

                                If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                    BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                    If vIndicePresentacion <> -1 Then
                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                    Else
                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                        BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                        clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                        If Not BePresentacionStock Is Nothing Then
                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                        End If
                                    End If

                                    If Not BePresentacionStock Is Nothing Then
                                        vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                    End If

                                    Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                    Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                    vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                    vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                    '#EJC202309121310: Revisión escensario explosión de cajas por solicitud de unidades, solo en niveles de picking.
                                    If (vStockOrigen.IdPresentacion <> 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If Not BeUbicacionStock.Ubicacion_picking Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    Dim BeUnidadMedida As New clsBeUnidad_medida
                                                    BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                    If Not BeUnidadMedida Is Nothing Then

                                                        '#CKFK20230918 Agregué esta funcionalidad para obtener el disponible en zona de picking
                                                        pStockResSolicitud.IdPresentacion = 0
                                                        lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                        vStockDispZonaPicking = 0

                                                        If lBeStockDisponible IsNot Nothing Then
                                                            If lBeStockDisponible.Count > 0 Then
                                                                Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                                lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                                vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                            End If
                                                        End If

                                                        vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159E: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona no picking: " & vStockDispZonaPicking
                                                        Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                        clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                    End If

                                                End If

                                            Else
                                                Dim BeUnidadMedida As New clsBeUnidad_medida
                                                BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                If Not BeUnidadMedida Is Nothing Then

                                                    '#CKFK20230918 Agregué esta funcionalidad para obtener el disponible en zona de picking
                                                    pStockResSolicitud.IdPresentacion = 0
                                                    lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                           BeProducto,
                                                                                           DiasVencimiento,
                                                                                           pBeConfigEnc,
                                                                                           lConnection,
                                                                                           ltransaction,
                                                                                           False,
                                                                                           False,
                                                                                           pTarea_Reabasto)

                                                    vStockDispZonaPicking = 0

                                                    If lBeStockDisponible IsNot Nothing Then
                                                        If lBeStockDisponible.Count > 0 Then
                                                            Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                            lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                            vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                        End If
                                                    End If

                                                    vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159F: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp: " & vStockDispZonaPicking
                                                    Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                    clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)
                                                End If
                                            End If

                                        End If

                                    End If

                                    BeStockRes = New clsBeStock_res
                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                    If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                        vCantidadPendiente -= vCantidadDispStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                        vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                    ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then


                                        Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)


                                        If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadPendiente
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                            BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                        Else


                                            BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                            BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                            BeStockDestino.Fec_agr = Now
                                            BeStockDestino.IdPresentacion = 0
                                            BeStockDestino.Presentacion.IdPresentacion = 0
                                            BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                            BeStockRes.IdStock = BeStockDestino.IdStock
                                            BeStockDestino.No_bulto = 1989

                                            CantidadStockDestino = BeStockDestino.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            clsLnStock.Insertar(BeStockDestino,
                                                                lConnection,
                                                                ltransaction)

                                            If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                            Else
                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                            End If

                                            vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                            If vStockOrigen.Cantidad > 0 Then
                                                clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                            Else
                                                clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                            End If

                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#17_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                            End If

                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            lBeStockAReservar.Add(BeStockRes)

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                              DiasVencimiento,
                                                                                                              pBeConfigEnc,
                                                                                                              lConnection,
                                                                                                              ltransaction,
                                                                                                              BeProducto,
                                                                                                              pTarea_Reabasto,
                                                                                                              vFechaMinimaVenceZonaPicking,
                                                                                                              vFechaMinimaVenceZonaALM,
                                                                                                              lBeStockExistente,
                                                                                                              BePresentacionStock)

                                            If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                BeStockRes = New clsBeStock_res
                                                BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                BeStockRes.IdStock = vStockOrigen.IdStock
                                                BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#18_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                                End If


                                                Restar_Stock_Reservado(lBeStockExistente,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                                lBeStockAReservar.Add(BeStockRes)

                                                lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                  DiasVencimiento,
                                                                                                                  pBeConfigEnc,
                                                                                                                  lConnection,
                                                                                                                  ltransaction,
                                                                                                                  BeProducto,
                                                                                                                  pTarea_Reabasto,
                                                                                                                  vFechaMinimaVenceZonaPicking,
                                                                                                                  vFechaMinimaVenceZonaALM,
                                                                                                                  lBeStockExistente,
                                                                                                                  BePresentacionStock)

                                            End If

                                            vCantidadCompletada = (vCantidadPendiente = 0)

                                            If vCantidadCompletada Then
                                                Exit For
                                            End If

                                        End If

                                    ElseIf vCantidadPendiente > vCantidadDispStock Then


                                        Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                        If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        Else
                                            Continue For
                                        End If

                                    End If

                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                    BeStockRes.Lote = vStockOrigen.Lote
                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                    BeStockRes.Peso = vStockOrigen.Peso
                                    BeStockRes.Estado = "UNCOMMITED"
                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                    BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.IdPicking = 0
                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                    BeStockRes.IdDespacho = 0
                                    BeStockRes.añada = vStockOrigen.Añada
                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.Host = MaquinaQueSolicita
                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                    CantidadStockDestino = BeStockRes.Cantidad

                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                    Insertar(BeStockRes,
                                             lConnection,
                                             ltransaction)

                                    vNombreCasoReservaInternoWMS = "CASO_#19_EJC202310090957"
                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                    If Not pBeTrasladoDet Is Nothing Then
                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                     BeProducto,
                                                                                                     lConnection,
                                                                                                     ltransaction)
                                    End If

                                    Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                    vCantidadCompletada = (vCantidadPendiente = 0)
                                    lBeStockAReservar.Add(BeStockRes)

                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                    DiasVencimiento,
                                                                                                    pBeConfigEnc,
                                                                                                    lConnection,
                                                                                                    ltransaction,
                                                                                                    BeProducto,
                                                                                                    pTarea_Reabasto,
                                                                                                    vFechaMinimaVenceZonaPicking,
                                                                                                    vFechaMinimaVenceZonaALM,
                                                                                                    lBeStockExistente,
                                                                                                    BePresentacionStock)

                                    If vCantidadCompletada Then
                                        Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                          BeProducto.Codigo,
                                                                                          vCantidadSolicitadaPedido,
                                                                                          BeStockRes.Cantidad)
                                        clsLnLog_error_wms.Agregar_Error(Log_20230301_N)
                                        Exit For
                                    End If

                                Else

                                    If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                        BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                    lConnection,
                                                                                                                                    ltransaction)

                                        If Not BePresentacionStock Is Nothing Then

                                            vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If

                                            vSolicitudEsEnUMBas = True

                                        End If


                                    ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        vSolicitudEsEnUMBas = False

                                    End If

                                    If Not BePresentacionStock Is Nothing Then
                                        vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                    End If

                                    Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                    Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                    If Not BePresentacionStock Is Nothing Then
                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                    Else
                                        vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                    End If

                                    If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        vCantidadPendienteEnPres = vCantidadPendiente
                                        vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                    Else

                                        vCantidadPendienteEnPres = vCantidadPendiente

                                        If pStockResSolicitud.IdPresentacion = 0 Then
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                        Else
                                            vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                        End If

                                        If Not (vStockOrigen.IdPresentacion = 0) Then
                                            If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                vConvirtioCantidadSolicitadaEnUmBas = True
                                            End If
                                        Else
                                            vCantidadPendiente = vCantidadPendiente
                                        End If

                                    End If

                                    If vSolicitudEsEnUMBas Then
                                        If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                            If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                            End If
                                        End If
                                    End If

                                    If (vStockOrigen.IdPresentacion <> 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If Not BeUbicacionStock.Ubicacion_picking Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    Dim BeUnidadMedida As New clsBeUnidad_medida
                                                    BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                    If Not BeUnidadMedida Is Nothing Then

                                                        pStockResSolicitud.IdPresentacion = 0
                                                        lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                        vStockDispZonaPicking = 0

                                                        If lBeStockDisponible IsNot Nothing Then
                                                            If lBeStockDisponible.Count > 0 Then
                                                                Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                                lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                                vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                            End If
                                                        End If

                                                        vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159C: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                        Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                        clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)
                                                    End If

                                                End If

                                            Else

                                                Dim BeUnidadMedida As New clsBeUnidad_medida
                                                BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                If Not BeUnidadMedida Is Nothing Then

                                                    pStockResSolicitud.IdPresentacion = 0
                                                    lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                    vStockDispZonaPicking = 0

                                                    If lBeStockDisponible IsNot Nothing Then
                                                        If lBeStockDisponible.Count > 0 Then
                                                            Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                            lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                            vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                        End If
                                                    End If

                                                    vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159D: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                    Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                    clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                End If

                                            End If

                                        End If

                                    End If

                                    BeStockRes = New clsBeStock_res
                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                    If Not vSolicitudEsEnUMBas Then
                                        BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                    End If

                                    If vCantidadPendiente = vCantidadDispStock Then

                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                        vCantidadPendiente -= vCantidadDispStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                    ElseIf vCantidadPendiente < vCantidadDispStock Then

                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                    ElseIf vCantidadPendiente > vCantidadDispStock Then

                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                    End If

                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                    BeStockRes.Lote = vStockOrigen.Lote
                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                    BeStockRes.Peso = vStockOrigen.Peso
                                    BeStockRes.Estado = "UNCOMMITED"
                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                    BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.IdPicking = 0
                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                    BeStockRes.IdDespacho = 0
                                    BeStockRes.añada = vStockOrigen.Añada
                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.Host = MaquinaQueSolicita
                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                    CantidadStockDestino = BeStockRes.Cantidad

                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                    Insertar(BeStockRes,
                                             lConnection,
                                             ltransaction)

                                    vNombreCasoReservaInternoWMS = "CASO_#20_EJC202310090957"
                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                    If Not pBeTrasladoDet Is Nothing Then

                                        If BeStockRes.IdPresentacion = 0 Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS += BeStockRes.Cantidad
                                        Else
                                            pBeTrasladoDet.Quantity_Reserved_WMS += Math.Round(BeStockRes.Cantidad / BePresentacionStock.Factor, 6)
                                        End If

                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                     BeProducto,
                                                                                                     lConnection,
                                                                                                     ltransaction)
                                    End If


                                    Restar_Stock_Reservado(lBeStockExistente,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)

                                    vCantidadCompletada = (vCantidadPendiente = 0)
                                    lBeStockAReservar.Add(BeStockRes)

                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                    '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                      DiasVencimiento,
                                                                                                      pBeConfigEnc,
                                                                                                      lConnection,
                                                                                                      ltransaction,
                                                                                                      BeProducto,
                                                                                                      pTarea_Reabasto,
                                                                                                      vFechaMinimaVenceZonaPicking,
                                                                                                      vFechaMinimaVenceZonaALM,
                                                                                                      lBeStockExistente,
                                                                                                      BePresentacionStock)

                                    If vCantidadCompletada Then
                                        Exit For
                                    End If

                                End If

                            End If

                        Next

                        '#EJC202309120404: Identificar si la reserva se hizo o se está buscando umbas (si quedó cantidad pendiente de reserva)
                        If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                            vBusquedaEnUmBas = True
                        Else
                            If Not vCantidadCompletada Then
                                If Not BePedidoDet Is Nothing Then
                                    If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                        vBusquedaEnUmBas = True
                                    End If
                                End If
                            Else
                                Reserva_Stock_From_MI3 = True
                                Exit Function
                            End If
                        End If

                    End If

#End Region


EJC_202308081248_RESERVAR_DESDE_ULITIMA_LISTA:

                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                          DiasVencimiento,
                                                                                          pBeConfigEnc,
                                                                                          lConnection,
                                                                                          ltransaction,
                                                                                          BeProducto,
                                                                                          pTarea_Reabasto,
                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                          vFechaMinimaVenceZonaALM,
                                                                                          lBeStockExistente,
                                                                                          BePresentacionStock)

                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                        If lBeStockExistente.Count = 0 Then
                            If Not lBeStockExistenteZonaPicking.Count = 0 AndAlso vBusquedaEnUmBas Then
                                lBeStockExistente = lBeStockExistenteZonaPicking
                                lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()
                            End If
                        End If

                        If lBeStockExistente.Count > 0 Then

                            If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                vBusquedaEnUmBas = True
                            Else
                                If Not BePedidoDet Is Nothing Then
                                    If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                        vBusquedaEnUmBas = True
                                    End If
                                End If
                            End If

                            For Each vStockOrigen As clsBeStock In lBeStockExistente

                                BeStockDestino = New clsBeStock()
                                clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(100) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(101) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(102) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(103) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(104) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(105) Then
                                    ListaEstadosDeProceso.Add(105)
                                    Exit For
                                ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                    ListaEstadosDeProceso.Add(105)
                                    GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                Else
                                    ListaEstadosDeProceso.Add(105)
                                End If

                                BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                          AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                If vIndiceUbicacion <> -1 Then
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                Else
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                    vStockOrigen.IdBodega,
                                                                                                                    lConnection,
                                                                                                                    ltransaction)
                                    If Not BeUbicacionStock Is Nothing Then
                                        lUbicaciones.Add(BeUbicacionStock.Clone())
                                    End If
                                End If


                                If vCantidadDispStock < 0 Then
                                    Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                End If

                                If vCantidadDispStock > 0 AndAlso Not BeBodega.Permitir_Decimales Then

                                    If pStockResSolicitud.IdPresentacion = 0 Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                        Continue For

                                                    End If

                                                End If

                                            Else

                                                If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then
                                                    If Not vBusquedaEnUmBas Then
                                                        Continue For
                                                    End If
                                                End If

                                            End If

                                        End If


                                    End If

                                    If (vStockOrigen.IdPresentacion <> 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If Not BeUbicacionStock.Ubicacion_picking Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    Dim BeUnidadMedida As New clsBeUnidad_medida
                                                    BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                    If Not BeUnidadMedida Is Nothing Then

                                                        pStockResSolicitud.IdPresentacion = 0
                                                        lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                        vStockDispZonaPicking = 0

                                                        If lBeStockDisponible IsNot Nothing Then
                                                            If lBeStockDisponible.Count > 0 Then
                                                                Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                                lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                                vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                            End If
                                                        End If

                                                        'FIN #CKFK20230202
                                                        vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159A: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                        Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                        clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                    End If

                                                End If

                                            Else

                                                Dim BeUnidadMedida As New clsBeUnidad_medida
                                                BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                If Not BeUnidadMedida Is Nothing Then

                                                    pStockResSolicitud.IdPresentacion = 0
                                                    lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                           BeProducto,
                                                                                           DiasVencimiento,
                                                                                           pBeConfigEnc,
                                                                                           lConnection,
                                                                                           ltransaction,
                                                                                           False,
                                                                                           False,
                                                                                           pTarea_Reabasto)

                                                    vStockDispZonaPicking = 0

                                                    If lBeStockDisponible IsNot Nothing Then

                                                        If lBeStockDisponible.Count > 0 Then

                                                            Restar_Stock_Reservado(lBeStockDisponible,
                                                                                   pBeConfigEnc,
                                                                                   lConnection,
                                                                                   ltransaction)

                                                            lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                            vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                        End If

                                                    End If

                                                    If Not vStockOrigen.UbicacionPicking Then

                                                        If Not Iniciar_En = 0 Then

                                                            vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159B: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                            Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                            clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                        End If

                                                    End If

                                                End If

                                            End If

                                        End If

                                    End If

                                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then


                                            Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                                vCantidadPendiente -= vCantidadPendiente
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                            Else

                                                BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                BeStockDestino.Fec_agr = Now
                                                BeStockDestino.IdPresentacion = 0
                                                BeStockDestino.Presentacion.IdPresentacion = 0
                                                BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                BeStockRes.IdStock = BeStockDestino.IdStock
                                                BeStockDestino.No_bulto = 1989

                                                CantidadStockDestino = BeStockDestino.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                clsLnStock.Insertar(BeStockDestino,
                                                                    lConnection,
                                                                    ltransaction)


                                                If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                Else
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                End If

                                                vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                If vStockOrigen.Cantidad > 0 Then
                                                    clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                Else
                                                    clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                End If

                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#21_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                                End If


                                                Restar_Stock_Reservado(lBeStockExistente,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                                lBeStockAReservar.Add(BeStockRes)


                                                lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                If lBeStockExistente.Count > 0 Then
                                                    '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionDefecto)
                                                End If

                                                If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                    'Reservar el remanente en cajas completas.
                                                    vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                    BeStockRes = New clsBeStock_res
                                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                    BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#22_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                    End If


                                                    Restar_Stock_Reservado(lBeStockExistente,
                                                                           pBeConfigEnc,
                                                                           lConnection,
                                                                           ltransaction)

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionStock)

                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)

                                                If vCantidadCompletada Then
                                                    Exit For
                                                End If

                                            End If

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                            Else
                                                Continue For
                                            End If

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        '#EJC20231031: Viene de un proceso recursivo (probablemente) tratando de reservar en presentación.
                                        If Not vSolicitudEsEnUMBas Then
                                            BeStockRes.IdPresentacion = vStockOrigen.IdPresentacion
                                        End If

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#23_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If


                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        If lBeStockExistente.Count > 0 Then
                                            '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3                                            
                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                             DiasVencimiento,
                                                                                                             pBeConfigEnc,
                                                                                                             lConnection,
                                                                                                             ltransaction,
                                                                                                             BeProducto,
                                                                                                             pTarea_Reabasto,
                                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                                             vFechaMinimaVenceZonaALM,
                                                                                                             lBeStockExistente,
                                                                                                             BePresentacionDefecto)
                                        End If

                                        If vCantidadCompletada Then
                                            Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                          BeProducto.Codigo,
                                                                                          vCantidadSolicitadaPedido,
                                                                                          BeStockRes.Cantidad)

                                            clsLnLog_error_wms.Agregar_Error(Log_20230301_N)

                                            Exit For

                                        End If

                                    Else

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                    lConnection,
                                                                                                                                    ltransaction)

                                            If Not BePresentacionStock Is Nothing Then

                                                vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If

                                                vSolicitudEsEnUMBas = True

                                            End If


                                        ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            vSolicitudEsEnUMBas = False

                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        Else
                                            vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                        End If

                                        '#EJC20231019: CASO 15 Se agregó NOT vOrdernarListaStockSinPresentacionPrimero
                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso Not vOrdernarListaStockSinPresentacionPrimero Then

                                            vCantidadPendienteEnPres = vCantidadPendiente
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                        Else

                                            vCantidadPendienteEnPres = vCantidadPendiente

                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                            Else
                                                vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                            End If

                                            If Not (vStockOrigen.IdPresentacion = 0) Then
                                                If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                    If Not vOrdernarListaStockSinPresentacionPrimero Then
                                                        '#EJC20231019: CASO 15 En vCantidadPendienteEnPres el valor asignado corresponde a las unidades.
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                        vConvirtioCantidadSolicitadaEnUmBas = True
                                                    Else

                                                    End If
                                                End If
                                            Else
                                                vCantidadPendiente = vCantidadPendiente
                                            End If

                                        End If

                                        If vSolicitudEsEnUMBas Then

                                            If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                    clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                End If
                                            End If

                                        End If

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If Not vSolicitudEsEnUMBas Then
                                            If Not vOrdernarListaStockSinPresentacionPrimero Then
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            Else
                                                BeStockRes.IdPresentacion = 0
                                            End If
                                        End If

                                        If vCantidadPendiente = vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente < vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1
                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#24_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If

                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)


                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                         DiasVencimiento,
                                                                                                         pBeConfigEnc,
                                                                                                         lConnection,
                                                                                                         ltransaction,
                                                                                                         BeProducto,
                                                                                                         pTarea_Reabasto,
                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                         lBeStockExistente,
                                                                                                         BePresentacionDefecto)
                                        If vCantidadCompletada Then
                                            Exit For
                                        End If

                                    End If

                                Else

                                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadPendiente
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            If vCantidadPendiente = 0 Then
                                                vCantidadPendienteEnPres = 0
                                            Else
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                            End If

                                            BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion
                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                BeStockRes.IdPresentacion = 0
                                            Else
                                                BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion
                                            End If
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = 0
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), BeBodega.Permitir_Decimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#25_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                            End If


                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                            lBeStockAReservar.Add(BeStockRes)


                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                            DiasVencimiento,
                                                                                                            pBeConfigEnc,
                                                                                                            lConnection,
                                                                                                            ltransaction,
                                                                                                            BeProducto,
                                                                                                            pTarea_Reabasto,
                                                                                                            vFechaMinimaVenceZonaPicking,
                                                                                                            vFechaMinimaVenceZonaALM,
                                                                                                            lBeStockExistente,
                                                                                                            BePresentacionStock)

                                            vCantidadCompletada = (vCantidadPendiente = 0)

                                            If vCantidadCompletada Then
                                                Exit For
                                            End If

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#26_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If


                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                            DiasVencimiento,
                                                                                                            pBeConfigEnc,
                                                                                                            lConnection,
                                                                                                            ltransaction,
                                                                                                            BeProducto,
                                                                                                            pTarea_Reabasto,
                                                                                                            vFechaMinimaVenceZonaPicking,
                                                                                                            vFechaMinimaVenceZonaALM,
                                                                                                            lBeStockExistente,
                                                                                                            BePresentacionStock)

                                        If vCantidadCompletada Then
                                            Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                          BeProducto.Codigo,
                                                                                          vCantidadSolicitadaPedido,
                                                                                          BeStockRes.Cantidad)
                                            clsLnLog_error_wms.Agregar_Error(Log_20230301_N)
                                            Exit For
                                        End If

                                    Else

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                    lConnection,
                                                                                                                                    ltransaction)

                                            If Not BePresentacionStock Is Nothing Then

                                                vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If

                                                vSolicitudEsEnUMBas = True

                                            End If


                                        ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            vSolicitudEsEnUMBas = False

                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If


                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        Else

                                            vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                        End If

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            vCantidadPendienteEnPres = vCantidadPendiente
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                        Else

                                            vCantidadPendienteEnPres = vCantidadPendiente

                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                            Else
                                                vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                            End If

                                            If Not (vStockOrigen.IdPresentacion = 0) Then
                                                If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                    vConvirtioCantidadSolicitadaEnUmBas = True
                                                End If
                                            Else
                                                vCantidadPendiente = vCantidadPendiente
                                            End If

                                        End If

                                        If vSolicitudEsEnUMBas Then
                                            If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                    clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                End If
                                            End If
                                        End If

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If Not vSolicitudEsEnUMBas Then
                                            BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                        End If

                                        If vCantidadPendiente = vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente < vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#27_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If


                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                             DiasVencimiento,
                                                                                                             pBeConfigEnc,
                                                                                                             lConnection,
                                                                                                             ltransaction,
                                                                                                             BeProducto,
                                                                                                             pTarea_Reabasto,
                                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                                             vFechaMinimaVenceZonaALM,
                                                                                                             lBeStockExistente,
                                                                                                             BePresentacionDefecto)

                                        If vCantidadCompletada Then
                                            Exit For
                                        End If

                                    End If

                                End If

                            Next

                        End If

                    End If

                    If lBeStockAReservar.Count > 0 Then

                        If Inserta_Stock_Reservado(lBeStockAReservar,
                                                   lConnection,
                                                   ltransaction) Then

                            pListStockResOUT.AddRange(lBeStockAReservar)

                            If Not (vCantidadCompletada AndAlso vCantidadPendiente > 0) AndAlso (pStockResSolicitud.IdPresentacion = 0 AndAlso vCantidadDecimalUMBas = 0) Then
                                vCantidadDecimalUMBas = vCantidadPendiente
                            ElseIf Not ((vCantidadCompletada AndAlso vCantidadPendiente > 0) AndAlso (pStockResSolicitud.IdPresentacion <> 0 AndAlso vCantidadDecimalUMBas = 0 AndAlso pBeConfigEnc.Explosion_Automatica)) AndAlso vBusquedaEnUmBas Then
                                vCantidadDecimalUMBas = vCantidadPendiente
                            End If

                            Reserva_Stock_From_MI3 = True

                            If (pBeConfigEnc.Explosion_Automatica) AndAlso (vCantidadDecimalUMBas > 0) OrElse (vCantidadPendiente > 0) Then

                                If (vCantidadDecimalUMBas > 0) OrElse (vCantidadPendiente > 0) Then

                                    Dim BeStockResUMBas As New clsBeStock_res
                                    BeStockResUMBas = BeStockRes.Clone()

                                    If vCantidadPendiente > 0 AndAlso Not (vCantidadDecimalUMBas = vCantidadPendiente) Then
                                        vCantidadDecimalUMBas += vCantidadPendiente
                                    End If

                                    BeStockResUMBas.Cantidad = vCantidadDecimalUMBas
                                    BeStockResUMBas.IdPresentacion = 0
                                    BeStockResUMBas.Serial = No_Linea

                                    If pStockResSolicitud.IdUbicacionAbastecerCon <> 0 Then
                                        BeStockResUMBas.IdUbicacionAbastecerCon = pStockResSolicitud.IdUbicacionAbastecerCon
                                    End If

                                    Dim vCantDisRef As Double = 0

                                    Dim ExcluirUbicacionesPicking As Boolean

                                    ExcluirUbicacionesPicking = pTarea_Reabasto

                                    If lBeStockExistente.Count = 0 Then

                                        If pStockResSolicitud.IdPresentacion = 0 Then vBusquedaEnUmBas = True

                                        lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                                              BeProducto,
                                                                              DiasVencimiento,
                                                                              pBeConfigEnc,
                                                                              lConnection,
                                                                              ltransaction,
                                                                              True,
                                                                              True,
                                                                              pTarea_Reabasto)

                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vRestoInventarioEnUmBas = True


                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                         DiasVencimiento,
                                                                                                         pBeConfigEnc,
                                                                                                         lConnection,
                                                                                                         ltransaction,
                                                                                                         BeProducto,
                                                                                                         pTarea_Reabasto,
                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                         lBeStockExistente,
                                                                                                         BePresentacionDefecto)

                                        If pStockResSolicitud.IdPresentacion = 0 Then
                                            vZonaNoPickingStockEnUmBas = lBeStockExistente.Count > 0
                                        Else
                                            Debug.WriteLine("vZonaNoPickingStockEnUmBas = false")
                                        End If

                                    End If

                                    If pStockResSolicitud.IdPresentacion = 0 And Not pTarea_Reabasto And vZonaNoPickingStockEnUmBas Then
                                        ExcluirUbicacionesPicking = True
                                    End If

                                    'No tengo unidades en almacenaje.
                                    If vZonaNoPickingStockEnUmBas Then

                                        vNombreCasoReservaInternoWMS += "_LLR_28_"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                      DiasVencimiento,
                                                                      MaquinaQueSolicita,
                                                                      pBeConfigEnc,
                                                                      vCantDisRef,
                                                                      pIdPropietarioBodega,
                                                                      vlBeStockAReservarUMBas,
                                                                      lConnection,
                                                                      ltransaction,
                                                                      No_Linea,
                                                                      ExcluirUbicacionesPicking,
                                                                      pBeTrasladoDet) Then


                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                                pCantidadDisponibleStock = vCantidadDispStock
                                                Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                          BeProducto.Codigo,
                                                                          vCantidadSolicitadaPedido,
                                                                          vCantidadStock))

                                            Else
                                                Reserva_Stock_From_MI3 = False
                                            End If

                                        End If

                                    Else

                                        If Not vNombreCasoReservaInternoWMS.Contains("LLR_CASO_#29_EJC202310090957") Then

                                            vNombreCasoReservaInternoWMS += "_LLR29_"

                                            '#EJC20231031: Si la solicitud es presentación, mantener la presentación en la llamada recursiva.
                                            If Not (pStockResSolicitud.IdPresentacion = 0) AndAlso Not vBusquedaEnUmBas Then
                                                BeStockResUMBas.IdPresentacion = pStockResSolicitud.IdPresentacion
                                            End If

                                            If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                          DiasVencimiento,
                                                                          MaquinaQueSolicita,
                                                                          pBeConfigEnc,
                                                                          vCantDisRef,
                                                                          pIdPropietarioBodega,
                                                                          vlBeStockAReservarUMBas,
                                                                          lConnection,
                                                                          ltransaction,
                                                                          No_Linea,
                                                                          False,
                                                                          pBeTrasladoDet) Then

                                                If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                                    pCantidadDisponibleStock = vCantidadDispStock
                                                    Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                  BeProducto.Codigo,
                                                                                  vCantidadSolicitadaPedido,
                                                                                  vCantidadStock))
                                                End If

                                            Else
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)
                                                Exit Function
                                            End If

                                        Else
                                            'Ya hizo recursividad sobre esta funcionalidad 1 vez.
                                            Exit Function
                                        End If

                                    End If

                                End If

                            End If

                            pStockResSolicitud = BeStockRes

                            If Not vlBeStockAReservarUMBas Is Nothing Then
                                If vlBeStockAReservarUMBas.Count > 0 Then
                                    lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                End If
                            End If

                            pListStockResOUT = lBeStockAReservar

                            Reserva_Stock_From_MI3 = True

                        Else
                            If Not vOrdernarListaStockSinPresentacionPrimero Then
                                Throw New Exception(String.Format("{0} IdProductoBodegaSol: {1}", clsDalEx.ErrorS0006, pStockResSolicitud.IdProductoBodega))
                            Else
                                Throw New Exception(vbNewLine & String.Format("{0} IdProductoBodegaSol: {1}", clsDalEx.ErrorS0002, pStockResSolicitud.IdProductoBodega))
                            End If
                        End If

                    Else
                        Throw New Exception(String.Format("{0} IdProductoBodegaSol: {1}", clsDalEx.ErrorS0005, pStockResSolicitud.IdProductoBodega))
                    End If

                Else

                    If pStockResSolicitud.IdPresentacion <> 0 Then

                        If (pBeConfigEnc.Explosion_Automatica) Then

                            Split_Decimal(pStockResSolicitud.Cantidad,
                                              vCantidadEnteraPres,
                                              vCantidadDecimalUMBas)

                            If IdProducto = 0 Then
                                IdProducto = clsLnProducto_bodega.Get_IdProducto_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                                     lConnection,
                                                                                                     ltransaction)
                            End If

                            If IdProducto <> 0 Then
                                BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)

                            End If

                            If Not BePresentacionStock Is Nothing Then

                                If Not BePresentacionStock.Factor = 0 Then

                                    vCantidadDecimalUMBas = Math.Ceiling(Math.Round(vCantidadDecimalUMBas * BePresentacionStock.Factor, 2))

                                    If vCantidadEnteraPres > 0 Then
                                        vCantidadSolicitadaPedido = vCantidadEnteraPres
                                    Else
                                        vCantidadSolicitadaPedido = vCantidadDecimalUMBas
                                    End If

                                End If

                            End If

                        Else
                            vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad * BePresentacionStock.Factor
                            vConvirtioCantidadSolicitadaEnUmBas = True
                        End If

                        If vCantidadDecimalUMBas > 0 Then

                            If (pBeConfigEnc.Explosion_Automatica) AndAlso (vCantidadDecimalUMBas > 0) Then

                                Dim BeStockResUMBas As New clsBeStock_res
                                BeStockResUMBas = pStockResSolicitud.Clone()

                                If BeStockResUMBas.No_bulto = 0 Then

                                    BeStockResUMBas.Cantidad = vCantidadDecimalUMBas
                                    BeStockResUMBas.Atributo_Variante_1 = Nothing
                                    BeStockResUMBas.IdPresentacion = 0
                                    BeStockResUMBas.Serial = No_Linea
                                    BeStockResUMBas.No_bulto = 1965 'Identificación para solicitud recursiva.

                                    If pStockResSolicitud.IdUbicacionAbastecerCon <> 0 Then
                                        BeStockResUMBas.IdUbicacionAbastecerCon = pStockResSolicitud.IdUbicacionAbastecerCon
                                    End If

                                    Dim vCantDisRef As Double = 0

                                    If Inserta_Stock_Reservado(lBeStockAReservar, lConnection, ltransaction) Then

                                        If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                          DiasVencimiento,
                                                                          MaquinaQueSolicita,
                                                                          pBeConfigEnc,
                                                                          vCantDisRef,
                                                                          pIdPropietarioBodega,
                                                                          vlBeStockAReservarUMBas,
                                                                          lConnection,
                                                                          ltransaction,
                                                                          No_Linea,
                                                                          False,
                                                                          pBeTrasladoDet) Then

                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                                pCantidadDisponibleStock = vCantidadDispStock
                                                Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                          BeProducto.Codigo,
                                                                          vCantidadSolicitadaPedido,
                                                                          vCantidadStock))
                                            Else
                                                Exit Function
                                            End If

                                        End If

                                        '#CKFK20230207 Agregué esto porque no se agrega a la respuesta
                                        pStockResSolicitud = BeStockResUMBas

                                        If Not vlBeStockAReservarUMBas Is Nothing Then
                                            If vlBeStockAReservarUMBas.Count > 0 Then
                                                lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                            End If
                                        End If

                                        pListStockResOUT = lBeStockAReservar
                                        Reserva_Stock_From_MI3 = True

                                    End If

                                    '#EJC20210707: Igualar el stock reservador con la solicitud.
                                    pStockResSolicitud = BeStockRes

                                    If Not vlBeStockAReservarUMBas Is Nothing Then
                                        If vlBeStockAReservarUMBas.Count > 0 Then
                                            lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                        End If
                                    End If

                                    '#EJC20220627_0927:Devolver la lista de stock reservado para adicionar en picking existente.
                                    pListStockResOUT = lBeStockAReservar
                                    Reserva_Stock_From_MI3 = True

                                Else
                                    Exit Function
                                End If

                            End If

                        Else

                            If pBeConfigEnc.Despachar_existencia_parcial = tDespacharExistenciaParcial.No Then

                                If pStockResSolicitud.IdPresentacion = 0 Then
                                    Throw New Exception(String.Format("{0} Código:{1} UMBas={2} Pres='Sin pres' Cant={3} (Verifique si tiene existencia en UMBas en WMS) ", clsDalEx.ErrorS0004,
                                                                                                                                                                    BeProducto.Codigo,
                                                                                                                                                                    BeProducto.UnidadMedida.Nombre,
                                                                                                                                                                    pStockResSolicitud.Cantidad))
                                Else
                                    Throw New Exception(String.Format("{0} Código:{1} UMBas={2} Pres={3} Cant={4} (Verifique si tiene existencia en Pres. en WMS) ", clsDalEx.ErrorS0004,
                                                                                                                                                             BeProducto.Codigo,
                                                                                                                                                             BeProducto.UnidadMedida.Nombre,
                                                                                                                                                             pStockResSolicitud.IdPresentacion,
                                                                                                                                                             pStockResSolicitud.Cantidad))
                                End If

                            End If

                        End If

                    Else

                        'IDENTIFICACIÓN A DE RECURSIVIDAD.
                        '#CKFK20230202 No llega la cantidad pendiente solo se sabe que no está completo
                        vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad

                        '#CKFK20230202 Aquí necesitamos mandar a explosionar el producto
                        If (pBeConfigEnc.Explosion_Automatica) AndAlso (vCantidadSolicitadaPedido > 0) AndAlso lBeStockExistente.Count > 0 Then

                            Dim BeStockResUMBas As New clsBeStock_res
                            BeStockResUMBas = pStockResSolicitud.Clone()

                            If BeStockResUMBas.No_bulto = 0 Then

                                BeStockResUMBas.Cantidad = vCantidadSolicitadaPedido
                                BeStockResUMBas.IdPresentacion = 0
                                BeStockResUMBas.Serial = No_Linea
                                BeStockResUMBas.No_bulto = 1965 'Identificación para solicitud recursiva.

                                If pStockResSolicitud.IdUbicacionAbastecerCon <> 0 Then
                                    BeStockResUMBas.IdUbicacionAbastecerCon = pStockResSolicitud.IdUbicacionAbastecerCon
                                End If

                                Dim vCantDisRef As Double = 0

                                If Inserta_Stock_Reservado(lBeStockAReservar,
                                                           lConnection,
                                                           ltransaction) Then

                                    If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                  DiasVencimiento,
                                                                  MaquinaQueSolicita,
                                                                  pBeConfigEnc,
                                                                  vCantDisRef,
                                                                  pIdPropietarioBodega,
                                                                  vlBeStockAReservarUMBas,
                                                                  lConnection,
                                                                  ltransaction,
                                                                  No_Linea,
                                                                  False,
                                                                  pBeTrasladoDet) Then

                                        If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                            pCantidadDisponibleStock = vCantidadDispStock
                                            Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                          BeProducto.Codigo,
                                                                          vCantidadSolicitadaPedido,
                                                                          vCantidadStock))
                                        Else
                                            Exit Function
                                        End If

                                    End If

                                End If

                                '#EJC20210707: Igualar el stock reservador con la solicitud.
                                pStockResSolicitud = BeStockRes

                                If Not vlBeStockAReservarUMBas Is Nothing Then
                                    If vlBeStockAReservarUMBas.Count > 0 Then
                                        lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                    End If
                                End If

                                '#EJC20220627_0927:Devolver la lista de stock reservado para adicionar en picking existente.
                                pListStockResOUT = lBeStockAReservar

                            Else
                                Exit Function
                            End If

                        End If

                    End If

                End If

            End If

        Catch ex As Exception
            Throw ex
        End Try

    End Function


Public Shared Function Reserva_Stock_From_MI3(ByRef pStockResSolicitud As clsBeStock_res,
                                                  ByVal DiasVencimiento As Double,
                                                  ByVal MaquinaQueSolicita As String,
                                                  ByVal pBeConfigEnc As clsBeI_nav_config_enc,
                                                  ByRef pCantidadDisponibleStock As Double,
                                                  ByVal pIdPropietarioBodega As Integer,
                                                  ByRef pListStockResOUT As List(Of clsBeStock_res),
                                                  ByRef lConnection As SqlConnection,
                                                  ByRef ltransaction As SqlTransaction,
                                                  Optional No_Linea As Integer = 0,
                                                  Optional pTarea_Reabasto As Boolean = False,
                                                  Optional ByVal pBeTrasladoDet As clsBeI_nav_ped_traslado_det = Nothing) As Boolean

        Reserva_Stock_From_MI3 = False

        Try



#Region "Variables"

            Dim lBeStockExistente As New List(Of clsBeStock)
            Dim lBeStockExistenteZonasNoPicking As New List(Of clsBeStock)
            Dim lBeStockExistenteZonaPicking As New List(Of clsBeStock)
            Dim lBeStockExistenteZonaPickingPresentacion As New List(Of clsBeStock)
            Dim lBeStockExistenteTmp As New List(Of clsBeStock)
            Dim lBeStockExistenteTomeDesde As New List(Of clsBeStock)
            Dim lBeStockDisponible As New List(Of clsBeStock)
            Dim lBeStockAReservar As New List(Of clsBeStock_res)
            Dim BeProductoPresentacion As New clsBeProducto_Presentacion()
            Dim vIndicePresentacion As Integer = -1
            Dim vIndiceUbicacion As Integer = 0
            Dim vCantidadReservada As Double = 0
            Dim vPesoReservado As Double = 0
            Dim BeProducto As New clsBeProducto
            Dim BeStockRes As New clsBeStock_res
            Dim vCantidadCompletada As Boolean = False
            Dim vCantidadDispStock As Double = 0
            Dim vCantidadPendiente As Double = 0
            Dim vCantidadSolicitadaPedido As Double = 0
            Dim vValorEnteroCantidadSolicitadaPedido As Integer = 0
            Dim vCantidadAReservarPorIdStock As Double = 0
            Dim vCantidadEnteraPres As Integer = 0
            Dim vCantidadDecimalUMBas As Double = 0
            Dim vCantidadStock As Double = 0
            Dim vCantidadStockEnPres As Double = 0
            Dim vDisponibleStockEnPres As Double = 0
            Dim vPesoStock As Double = 0
            Dim vPesoPendiente As Double = 0
            Dim vPesoSolicitadoPedido As Double = 0
            Dim vPesoAReservarPorIdStock As Double = 0
            Dim Idx As Integer = 0
            Dim BePresentacionStock As New clsBeProducto_Presentacion
            Dim vCantidadEnStockEnPres As Double = 0
            Dim vCantidadSolicitadaPedidoEnPres As Double = 0
            Dim vCantidadEnteraStockPres As Double = 0
            Dim vCantidadDecimalStockUMBas As Double = 0
            Dim vPesoEnteroPres As Double = 0
            Dim vPesoDecimalUMBas As Double = 0
            Dim vPesoEnteroPresStock As Double = 0
            Dim vPesoDecimalStockUMBas As Double = 0
            Dim vCantidadDecimalUMBasStock As Double = 0
            Dim BeStockDestino As New clsBeStock
            Dim BeUbicacionStock As New clsBeBodega_ubicacion()
            Dim vCantidadPendienteEnPres As Double = 0
            Dim vCantidadDispStockEnPres As Double = 0
            Dim CantidadEnUMBasPorPresentacionDelStock As Double = 0
            Dim vCantidadEnteraSolicitadaPedidoEnPres As Double = 0
            Dim vCantidadDecimalSolicitadaPedidoEnPres As Double = 0
            Dim IdProducto As Integer = 0
            Dim vSolicitudEsEnUMBas As Boolean = False 'Buscar reservar unidades 
            Dim BeStockOriginal As New clsBeStock()
            Dim vOrdernarListaStockSinPresentacionPrimero As Boolean = False
            Dim vConvirtioCantidadSolicitadaEnUmBas As Boolean = False
            Dim vlBeStockAReservarUMBas As New List(Of clsBeStock_res)
            Dim vCantidadTarimasCompletasAPickearClavaud As Double = 0
            Dim vCantidadEnteraTarimasCompletasClavaud As Double = 0
            Dim vCantidadDecimalTarimasCompletasClavaud As Double = 0
            Dim BeUbicacionEnMemoria As New clsBeBodega_ubicacion()
            Dim vCantidadProductoPorTarima As Double = 0
            Dim vResultCalculoTarimaEstaCompleta As Double = 0
            Dim vCantidadEnStockEnPresentacionClavaud As Double = 0
            Dim lBeStockConPalletsCompletosClavaud As New List(Of clsBeStock)
            Dim lBeStockConPalletsInCompletosClavaud As New List(Of clsBeStock)
            Dim lBeStockZonaPicking As New List(Of clsBeStock)
            Dim lBeStockZonasNoPicking As New List(Of clsBeStock)
            Dim vCantPVConPalletsCompletosClavaud As Integer = 0 'Próximos a vencer
            Dim vCantPVConPalletsInCompletosClavaud As Integer = 0 'Próximos a vencer
            Dim vBusquedaEnUmBas As Boolean = False
            Dim vZonaNoPickingStockEnUmBas As Boolean = False
            Dim vRefCantidadReservada As Double = 0
            Dim vRestoInventarioEnUmBas As Boolean = False
            Dim BePresentacionDefecto As New clsBeProducto_Presentacion
            Dim vEncontroExistenciaEnPresentacion As Boolean = False
            Dim CantidadStockDestino As Double = 0
            Dim BePedidoDet As New clsBeTrans_pe_det
            Dim FechaMinimaVenceStock As Date = New Date(1900, 1, 1)
            Dim ExcepcionFechaVenceEsInferiorEnZonaPicking As Boolean = False
            Dim vFechaMinimaVenceZonaPicking As Date = New Date(1900, 1, 1)
            Dim vFechaMinimaVenceZonaALM As Date = New Date(1900, 1, 1)
            Dim vVenceMinimaPickingCompletoClavaud As Date = New Date(1900, 1, 1)
            Dim vVenceMinimaPickingInCompletoClavaud As Date = New Date(1900, 1, 1)
            Dim ListaEstadosDeProceso As New List(Of Integer)
            Dim vPermitirDecimales As Boolean = False
            Dim BeBodega As New clsBeBodega
            Dim vCantidadStockZonaNoPicking As Double = 0
            Dim vCantidadStockZonaPicking As Double = 0
            Dim vMensajeNoExplosionEnZonasNoPicking = ""
            Dim vCantidadTotalStock As Double = 0
            Dim vStockDispZonaPicking As Integer = 0
            Dim vFechaMinima As Date = New Date(1900, 1, 1)
            Dim Iniciar_En As Integer = 0
            Dim vNombreCasoReservaInternoWMS As String = ""
            Dim pStockResBusquedaParaExplosion As New clsBeStock_res
#End Region

            Dim vIdPropietario As Integer = clsLnPropietarios.Get_IdPropietario(pStockResSolicitud.IdBodega,
                                                                                pIdPropietarioBodega,
                                                                                lConnection,
                                                                                ltransaction)

            pStockResSolicitud.IdBodega = pBeConfigEnc.Idbodega
            BeBodega = clsLnBodega.GetSingle_By_Idbodega(pBeConfigEnc.Idbodega,
                                                         lConnection,
                                                         ltransaction)

            BePedidoDet = clsLnTrans_pe_det.Get_Single_By_IdPedidoEnc_And_IdPedidoDet(pStockResSolicitud.IdPedido,
                                                                                      pStockResSolicitud.IdPedidoDet,
                                                                                      lConnection,
                                                                                      ltransaction)

            lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                  BeProducto,
                                                  DiasVencimiento,
                                                  pBeConfigEnc,
                                                  lConnection,
                                                  ltransaction,
                                                  IIf(pTarea_Reabasto, True, False),
                                                  False,
                                                  pTarea_Reabasto)


            lBeStockExistenteZonasNoPicking = clsLnStock.lStock(pStockResSolicitud,
                                                                BeProducto,
                                                                DiasVencimiento,
                                                                pBeConfigEnc,
                                                                lConnection,
                                                                ltransaction,
                                                                True,
                                                                False,
                                                                pTarea_Reabasto)

            lBeStockExistenteZonaPicking = clsLnStock.lStock(pStockResSolicitud,
                                                             BeProducto,
                                                             DiasVencimiento,
                                                             pBeConfigEnc,
                                                             lConnection,
                                                             ltransaction,
                                                             False,
                                                             False,
                                                             pTarea_Reabasto)

            If pStockResSolicitud.IdPresentacion <> 0 Then
                If Not lBeStockExistenteZonaPicking Is Nothing Then
                    If lBeStockExistenteZonaPicking.Count > 0 Then
                        lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.FindAll(Function(x) x.UbicacionPicking = True)
                    End If
                End If
            End If

            vFechaMinimaVenceZonaPicking = New Date(1900, 1, 1)
            vFechaMinimaVenceZonaALM = New Date(1900, 1, 1)
            vVenceMinimaPickingCompletoClavaud = New Date(1900, 1, 1)
            vVenceMinimaPickingInCompletoClavaud = New Date(1900, 1, 1)

            If Not lBeStockExistente Is Nothing Then

#Region "RESTAR_STOCK_RESERVADO"

                If lBeStockExistente.Count > 0 Then

                    '#CKFK20230202 Subí esto para que se haga antes 
                    If vOrdernarListaStockSinPresentacionPrimero Then
                        lBeStockExistente = lBeStockExistente.OrderBy(Function(x) x.IdPresentacion).ToList
                    End If


                    Restar_Stock_Reservado(lBeStockExistente,
                                           pBeConfigEnc,
                                           lConnection,
                                           ltransaction)


                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()
                    If lBeStockExistente.Count > 0 Then
                        If FechaMinimaVenceStock.Date = New Date(1900, 1, 1) Then
                            FechaMinimaVenceStock = lBeStockExistente.Min(Function(x) x.Fecha_vence)
                        End If
                    End If

                    If pStockResSolicitud.IdPresentacion = 0 AndAlso Not BeBodega.Permitir_Decimales Then
                        vOrdernarListaStockSinPresentacionPrimero = True : vBusquedaEnUmBas = True
                    Else

                        If lBeStockExistente.Count > 0 Then vEncontroExistenciaEnPresentacion = True

                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = pStockResSolicitud.IdPresentacion}

                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                        If vIndicePresentacion <> -1 Then
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                        Else
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock.IdPresentacion = pStockResSolicitud.IdPresentacion
                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                            lPresentaciones.Add(BePresentacionStock.Clone())
                        End If

                        If Not BePresentacionStock Is Nothing Then

                            If BePresentacionStock.Factor > 0 Then

                                If (BePresentacionStock.CajasPorCama > 0) AndAlso (BePresentacionStock.CamasPorTarima > 0) Then

                                    vCantidadProductoPorTarima = Math.Round(BePresentacionStock.CajasPorCama * BePresentacionStock.CamasPorTarima, 2)

                                    vCantidadTarimasCompletasAPickearClavaud = Math.Round(pStockResSolicitud.Cantidad / vCantidadProductoPorTarima, 2)

                                    Split_Decimal(vCantidadTarimasCompletasAPickearClavaud,
                                                  vCantidadEnteraTarimasCompletasClavaud,
                                                  vCantidadDecimalTarimasCompletasClavaud)

                                End If

                            End If

                        End If

                    End If

                End If

                If lBeStockExistenteZonasNoPicking.Count > 0 Then

                    '#CKFK20230202 Subí esto para que se haga antes 
                    If vOrdernarListaStockSinPresentacionPrimero Then
                        lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.OrderBy(Function(x) x.IdPresentacion).ToList
                    End If


                    Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                           pBeConfigEnc,
                                           lConnection,
                                           ltransaction)

                    lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.Where(Function(x) x.Cantidad > 0).ToList()

                End If

                If lBeStockExistenteZonaPicking.Count > 0 Then

                    '#CKFK20230202 Subí esto para que se haga antes 
                    If vOrdernarListaStockSinPresentacionPrimero Then
                        lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.OrderBy(Function(x) x.IdPresentacion).ToList
                    End If


                    Restar_Stock_Reservado(lBeStockExistenteZonaPicking,
                                           pBeConfigEnc,
                                           lConnection,
                                           ltransaction)

                    lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.Where(Function(x) x.Cantidad > 0).ToList()

                End If

#End Region

#Region "OBTENER_FECHA_MINIMA_DE_INVENTARIO"

                'If Not lBeStockExistente Is Nothing Then
                '    If lBeStockExistente.Count > 0 Then
                '        FechaMinimaVenceStock = lBeStockExistente.Min(Function(x) x.Fecha_vence)
                '    End If
                'End If

                'If Not lBeStockExistenteZonasNoPicking Is Nothing Then
                '    If lBeStockExistenteZonasNoPicking.Count > 0 Then
                '        vFechaMinimaVenceZonaALM = lBeStockExistenteZonasNoPicking.Min(Function(x) x.Fecha_vence)
                '    End If
                'End If

                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                  DiasVencimiento,
                                                                                  pBeConfigEnc,
                                                                                  lConnection,
                                                                                  ltransaction,
                                                                                  BeProducto,
                                                                                  pTarea_Reabasto,
                                                                                  vFechaMinimaVenceZonaPicking,
                                                                                  vFechaMinimaVenceZonaALM,
                                                                                  lBeStockExistente,
                                                                                  BePresentacionStock)

                '#EJC202308211030:Esto quiere decir que fuera de la zona de picking hay una fecha más corta de vencimiento.
                'Entonces debería empezar por esa otra lista (la que no es de zonas de picking)
                If lBeStockExistenteZonasNoPicking.Count > 0 Then
                    If vFechaMinimaVenceZonaALM < FechaMinimaVenceStock Then
                        lBeStockExistente = lBeStockExistenteZonasNoPicking
                    End If
                End If

                If FechaMinimaVenceStock.Date = New Date(1900, 1, 1) Then
                    If Not lBeStockExistente Is Nothing Then
                        If lBeStockExistente.Count > 0 Then
                            FechaMinimaVenceStock = lBeStockExistente.Min(Function(x) x.Fecha_vence)
                        End If
                    End If
                End If

#End Region

EXPLOSIONAR_PRODUCTO:

                If (pBeConfigEnc.Explosion_Automatica OrElse pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking) AndAlso (lBeStockExistente.Count = 0 OrElse pStockResSolicitud.IdPresentacion = 0) Then

                    If IdProducto = 0 Then
                        IdProducto = clsLnProducto_bodega.Get_IdProducto_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                             lConnection,
                                                                                             ltransaction)
                    End If

                    If IdProducto <> 0 Then
                        BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                lConnection,
                                                                                                                ltransaction)

                    End If

                    If BeProducto Is Nothing Then
                        BeProducto = clsLnProducto.Get_BeProducto_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                      pBeConfigEnc.Idbodega,
                                                                                      lConnection,
                                                                                      ltransaction)
                    End If

                    If BeProducto Is Nothing Then
                        Throw New Exception("Error_202302021128: No se pudo obtener el objeto de producto asociado al IdProductoBodega: " & pStockResSolicitud.IdProductoBodega)
                    End If

                    If pStockResSolicitud.IdPresentacion = 0 Then
                        vOrdernarListaStockSinPresentacionPrimero = True : vBusquedaEnUmBas = True
                    End If

                    pStockResBusquedaParaExplosion = Nothing


                    If lBeStockExistente.Count = 0 Then '#EJC20230202: Si no se obtuvo stock.
                        If pStockResSolicitud.IdPresentacion = 0 Then '#EJC20230202: Y la primera búsqueda fue en unidades.                            
                            If Not BePresentacionStock Is Nothing Then '#EJC20230202: Entonces voy a buscar inventario en cajas (con la presentación por defecto si existe)
                                clsPublic.CopyObject(pStockResSolicitud, pStockResBusquedaParaExplosion)
                                pStockResBusquedaParaExplosion = pStockResSolicitud.Clone()
                                pStockResBusquedaParaExplosion.IdPresentacion = BePresentacionStock.IdPresentacion
                                vBusquedaEnUmBas = False
                            Else
                                Throw New Exception("ERROR_202302021127: Se está intentando reservar inventario que requiere explosión pero no está definida la presentación por defecto del producto: " & BeProducto.Codigo)
                            End If
                        Else

                            If Not vEncontroExistenciaEnPresentacion Then

                                If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                    Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                               BeProducto.Codigo,
                                                                               pStockResSolicitud.Cantidad,
                                                                               0))
                                Else

                                    If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                        '#CKFK20230324 Agregué esta condición para que busque en unidades si la primera búsqueda fue en presentación
                                        vBusquedaEnUmBas = True
                                    Else
                                        '#EJC20230724 Se agregó esta condición para que cuando el pedido sea en UMBas y ya no haya existencias en presentación busque en UMBas
                                        If Not BePedidoDet Is Nothing Then
                                            If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                                vBusquedaEnUmBas = True
                                            End If
                                        End If
                                    End If

                                End If
                            Else
                                vBusquedaEnUmBas = True
                            End If

                        End If

                    Else
                        '#EJC202310192207: Caso 6, cuando se solicitan unidades y no hay inventario, mantener la variable busquedaumbas = true
                        If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                            vBusquedaEnUmBas = True
                        Else
                            If Not BePedidoDet Is Nothing Then
                                If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                    vBusquedaEnUmBas = True
                                End If
                            End If
                        End If

                    End If

                    If vBusquedaEnUmBas Then

                        Split_Decimal(pStockResSolicitud.Cantidad,
                                      vCantidadEnteraPres,
                                      vCantidadDecimalUMBas)


                        vCantidadDecimalUMBas = Math.Ceiling(Math.Round(vCantidadDecimalUMBas * BePresentacionStock.Factor, 2))

                        If vCantidadEnteraPres > 0 Then

                            If pStockResSolicitud.IdPresentacion <> 0 Then

                                vCantidadSolicitadaPedido = vCantidadEnteraPres
                                '#CKFK20230601 Creo que esto solo aplica cuando vCantidadEnteraPres es mayor que 0 y estoy buscando en UMBas
                                vCantidadSolicitadaPedido = (vCantidadEnteraPres * BePresentacionStock.Factor)

                                '#CKFK20230815 Agregué que si no tengo cantidad en presentación voy a buscar en unidades todo lo que falta
                                If Not vEncontroExistenciaEnPresentacion Then
                                    vCantidadSolicitadaPedido = vCantidadSolicitadaPedido + vCantidadDecimalUMBas
                                    vCantidadDecimalUMBas = 0
                                End If
                            Else
                                vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad
                            End If

                        Else
                            vCantidadSolicitadaPedido = vCantidadDecimalUMBas
                        End If

                        pStockResSolicitud.Cantidad = vCantidadSolicitadaPedido
                        pStockResSolicitud.Atributo_Variante_1 = Nothing
                        pStockResSolicitud.IdPresentacion = 0

                    End If

                    If lBeStockExistente.Count = 0 Then

                        If Not vBusquedaEnUmBas AndAlso pStockResBusquedaParaExplosion Is Nothing Then
                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                           BeProducto.Codigo,
                                                                           pStockResSolicitud.Cantidad,
                                                                           0))
                            Else
                                If Not vCantidadCompletada Then
                                    Dim vMensajeError20230306 As String = String.Format("Error202303051226: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                    BeProducto.Codigo,
                                                                                    vCantidadSolicitadaPedido,
                                                                                    vCantidadStock)
                                    clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "C se realizó exit function con Reserva_Stock_From_MI3 = false")
                                    Exit Function
                                End If
                            End If
                        End If

                        '#EJC202309271639: Se busca explosionar primero de zonas de picking.
                        lBeStockExistenteZonaPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              False,
                                                              True,
                                                              pTarea_Reabasto)

                        Restar_Stock_Reservado(lBeStockExistenteZonaPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        If Not lBeStockExistenteZonaPicking Is Nothing Then

                            If lBeStockExistenteZonaPicking.Count > 0 Then
                                vFechaMinimaVenceZonaPicking = lBeStockExistenteZonaPicking.Min(Function(x) x.Fecha_vence)
                            End If

                        End If

                        lBeStockExistenteZonasNoPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              True,
                                                              True,
                                                              pTarea_Reabasto)

                        Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        If Not lBeStockExistenteZonasNoPicking Is Nothing Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                vFechaMinimaVenceZonaALM = lBeStockExistenteZonasNoPicking.Min(Function(x) x.Fecha_vence)
                            End If
                        End If

                        vRestoInventarioEnUmBas = True

                    End If

                    If vFechaMinimaVenceZonaALM > vFechaMinimaVenceZonaPicking Then
                        If Not lBeStockExistenteZonaPicking Is Nothing Then
                            If lBeStockExistenteZonaPicking.Count > 0 Then
                                lBeStockExistente = lBeStockExistenteZonaPicking
                            End If
                        End If
                    Else
                        If Not lBeStockExistenteZonasNoPicking Is Nothing Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                lBeStockExistente = lBeStockExistenteZonasNoPicking
                                Iniciar_En = 3
                            End If
                        End If
                    End If

                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                    vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                    vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)
                    vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vCantidadSolicitadaPedido = 0 Then
                        vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad
                    End If

                    If (vBusquedaEnUmBas AndAlso lBeStockExistente.Count = 0) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                        If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                            Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       pStockResSolicitud.Cantidad,
                                                                       0))
                        Else
                            If Not vCantidadCompletada Then
                                Dim vMensajeError20230306 As String = String.Format("Error202303051227: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                    BeProducto.Codigo,
                                                                                    vCantidadSolicitadaPedido,
                                                                                    vCantidadStock)

                                clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "D se realizó exit function con Reserva_Stock_From_MI3 = false")

                                Exit Function

                            End If

                        End If

                    Else

                        If lBeStockExistente.Count = 0 Then

                            If pStockResSolicitud.IdPresentacion = 0 Then vBusquedaEnUmBas = True

                            '#CKFK20231009 Puse el conmutar en false porque aqui solo quiero unidades
                            lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                                  BeProducto,
                                                                  DiasVencimiento,
                                                                  pBeConfigEnc,
                                                                  lConnection,
                                                                  ltransaction,
                                                                  True,
                                                                  False,
                                                                  pTarea_Reabasto)

                            Restar_Stock_Reservado(lBeStockExistente,
                                                   pBeConfigEnc,
                                                   lConnection,
                                                   ltransaction)

                            vRestoInventarioEnUmBas = True

                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                            If lBeStockExistente.Count > 0 Then
                                '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                 DiasVencimiento,
                                                                                                 pBeConfigEnc,
                                                                                                 lConnection,
                                                                                                 ltransaction,
                                                                                                 BeProducto,
                                                                                                 pTarea_Reabasto,
                                                                                                 vFechaMinimaVenceZonaPicking,
                                                                                                 vFechaMinimaVenceZonaALM,
                                                                                                 lBeStockExistente,
                                                                                                 BePresentacionDefecto)
                            Else
                                If Not lBeStockExistenteZonaPicking.Count = 0 Then
                                    lBeStockExistente = lBeStockExistenteZonaPicking
                                End If
                            End If

                            vZonaNoPickingStockEnUmBas = lBeStockExistente.Count > 0

                        End If

                        If lBeStockExistente.Count = 0 Then

                            If pStockResSolicitud.IdPresentacion = 0 Then vBusquedaEnUmBas = True

                            '#EJC202309121412: Buscar en zonas de picking  unidades
                            lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                                  BeProducto,
                                                                  DiasVencimiento,
                                                                  pBeConfigEnc,
                                                                  lConnection,
                                                                  ltransaction,
                                                                  False,
                                                                  True,
                                                                  pTarea_Reabasto)


                            Restar_Stock_Reservado(lBeStockExistente,
                                                   pBeConfigEnc,
                                                   lConnection,
                                                   ltransaction)

                            vRestoInventarioEnUmBas = True

                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                             DiasVencimiento,
                                                                                             pBeConfigEnc,
                                                                                             lConnection,
                                                                                             ltransaction,
                                                                                             BeProducto,
                                                                                             pTarea_Reabasto,
                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                             vFechaMinimaVenceZonaALM,
                                                                                             lBeStockExistente,
                                                                                             BePresentacionDefecto)

                        End If

                        If vBusquedaEnUmBas AndAlso lBeStockExistente.Count = 0 Then

                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       pStockResSolicitud.Cantidad,
                                                                       0))
                            Else

                                If Not vCantidadCompletada Then

                                    If Not ListaEstadosDeProceso.Contains(105) Then

                                        If (pBeConfigEnc.Explosion_Automatica) AndAlso (lBeStockExistente.Count = 0 OrElse pStockResSolicitud.IdPresentacion = 0) Then

                                            If Not BePresentacionStock Is Nothing Then '#EJC20230202: Entonces voy a buscar inventario en cajas (con la presentación por defecto si existe)
                                                clsPublic.CopyObject(pStockResSolicitud, pStockResBusquedaParaExplosion)
                                                pStockResBusquedaParaExplosion = pStockResSolicitud.Clone()
                                                pStockResBusquedaParaExplosion.IdPresentacion = BePresentacionStock.IdPresentacion
                                                vBusquedaEnUmBas = False
                                            Else
                                                Throw New Exception("ERROR_202302021127: Se está intentando reservar inventario que requiere explosión pero no está definida la presentación por defecto del producto: " & BeProducto.Codigo)
                                            End If

                                            lBeStockExistente = clsLnStock.lStock(pStockResBusquedaParaExplosion,
                                                                                  BeProducto,
                                                                                  DiasVencimiento,
                                                                                  pBeConfigEnc,
                                                                                  lConnection,
                                                                                  ltransaction,
                                                                                  True,
                                                                                  True,
                                                                                  pTarea_Reabasto)


                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                    pBeConfigEnc,
                                                                    lConnection,
                                                                    ltransaction)

                                            vRestoInventarioEnUmBas = True

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                             DiasVencimiento,
                                                                                                             pBeConfigEnc,
                                                                                                             lConnection,
                                                                                                             ltransaction,
                                                                                                             BeProducto,
                                                                                                             pTarea_Reabasto,
                                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                                             vFechaMinimaVenceZonaALM,
                                                                                                             lBeStockExistente,
                                                                                                             BePresentacionDefecto)

                                            ListaEstadosDeProceso.Add(105)

                                        Else

                                            ListaEstadosDeProceso.Add(105)

                                            Dim vMensajeError20230306 As String = String.Format("Error202303051227: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                        BeProducto.Codigo,
                                                                                        vCantidadSolicitadaPedido,
                                                                                        vCantidadStock)
                                            clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "D se realizó exit function con Reserva_Stock_From_MI3 = false")
                                            Exit Function

                                        End If

                                    Else

                                        Dim vMensajeError20230306 As String = String.Format("Error202303051227: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                                        BeProducto.Codigo,
                                                                                        vCantidadSolicitadaPedido,
                                                                                        vCantidadStock)
                                        clsLnLog_error_wms.Agregar_Error(vMensajeError20230306 & "D se realizó exit function con Reserva_Stock_From_MI3 = false")
                                        Exit Function

                                    End If

                                End If

                            End If

                        End If

                    End If

                End If

                If lBeStockExistente.Count > 0 Then

                    If pStockResSolicitud.IdPresentacion = 0 Then
                        vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad
                    Else

                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = pStockResSolicitud.IdPresentacion}

                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                        If vIndicePresentacion <> -1 Then
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                        Else
                            BePresentacionStock = New clsBeProducto_Presentacion()
                            BePresentacionStock.IdPresentacion = pStockResSolicitud.IdPresentacion
                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                            lPresentaciones.Add(BePresentacionStock.Clone())
                        End If

                        If BePresentacionStock.EsPallet Then

                            Dim vFactorPallet As Double = (BePresentacionStock.Factor * BePresentacionStock.CajasPorCama * BePresentacionStock.CamasPorTarima)

                            If vFactorPallet > 0 Then
                                vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad * vFactorPallet
                            Else
                                Throw New Exception("No se pudo reservar el stock para el tipo de producto pallet porque los factores de conversión dan un denominador = 0")
                            End If

                        Else

                            If (pBeConfigEnc.Explosion_Automatica) Then

                                Split_Decimal(pStockResSolicitud.Cantidad,
                                              vCantidadEnteraPres,
                                              vCantidadDecimalUMBas)


                                vCantidadDecimalUMBas = Math.Ceiling(Math.Round(vCantidadDecimalUMBas * BePresentacionStock.Factor, 2))

                                If vCantidadEnteraPres > 0 Then
                                    vCantidadSolicitadaPedido = vCantidadEnteraPres
                                Else
                                    vCantidadSolicitadaPedido = vCantidadDecimalUMBas
                                End If

                            Else
                                vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad * BePresentacionStock.Factor
                                vConvirtioCantidadSolicitadaEnUmBas = True
                            End If

                            If Not clsLnProducto.Tiene_Control_Por_Peso_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                            lConnection,
                                                                                            ltransaction) Then

                                If Integer.TryParse(vCantidadSolicitadaPedido, vValorEnteroCantidadSolicitadaPedido) Then
                                    vCantidadSolicitadaPedido = vValorEnteroCantidadSolicitadaPedido
                                Else
                                    vCantidadSolicitadaPedido = Math.Truncate(vCantidadSolicitadaPedido)
                                End If

                            Else
                                vCantidadSolicitadaPedido = Math.Round(vCantidadSolicitadaPedido, 6)
                            End If

                        End If

                    End If

                    If Not lBeStockExistente Is Nothing Then

                        vCantidadStock = lBeStockExistente.Sum(Function(x) x.Cantidad)
                        vDisponibleStockEnPres = lBeStockExistente.Where(Function(x) x.IdPresentacion <> 0).Sum(Function(x) x.Cantidad)
                        vPesoStock = lBeStockExistente.Sum(Function(x) x.Peso)

                        If pBeConfigEnc.Explosion_Automatica Then

                            If pStockResSolicitud.IdPresentacion = 0 Then

                                vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                                vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)

                                vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                                If (vCantidadSolicitadaPedido > vCantidadStock) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                                    BePresentacionDefecto = New clsBeProducto_Presentacion()
                                    BePresentacionDefecto = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                              lConnection,
                                                                                                                              ltransaction)

                                    Dim BeStockResUMBas As New clsBeStock_res
                                    BeStockResUMBas = pStockResSolicitud.Clone()
                                    BeStockResUMBas.IdPresentacion = BePresentacionDefecto.IdPresentacion

                                    lBeStockExistenteTmp = clsLnStock.lStock(BeStockResUMBas,
                                                                             BeProducto,
                                                                             DiasVencimiento,
                                                                             pBeConfigEnc,
                                                                             lConnection,
                                                                             ltransaction,
                                                                             IIf(pTarea_Reabasto, True, False),
                                                                             True,
                                                                             pTarea_Reabasto)

                                    Restar_Stock_Reservado(lBeStockExistenteTmp,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)


                                    lBeStockExistenteTmp = lBeStockExistenteTmp.FindAll(Function(x) x.Cantidad > 0)

                                    vCantidadStock = lBeStockExistenteTmp.Sum(Function(x) x.Cantidad)
                                    vDisponibleStockEnPres = lBeStockExistenteTmp.Where(Function(x) x.IdPresentacion <> 0).Sum(Function(x) x.Cantidad)

                                    vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                                    vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)

                                    vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                                    If (vCantidadSolicitadaPedido > vCantidadStock) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                                        If pBeConfigEnc.Rechazar_pedido_incompleto Then

                                            pCantidadDisponibleStock = vCantidadStock

                                            Throw New Exception(String.Format("Error_202212140140E:  {0} Código:  {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                               BeProducto.Codigo,
                                                                               vCantidadSolicitadaPedido,
                                                                               vCantidadTotalStock))
                                        Else

                                            If (vCantidadSolicitadaPedido > vDisponibleStockEnPres) Then
                                                If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                                    Throw New Exception(String.Format("ERROR_202212140132D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       vCantidadSolicitadaPedido,
                                                                       vCantidadTotalStock))
                                                End If
                                            Else
                                                vCantidadSolicitadaPedido = vCantidadStock
                                            End If

                                        End If

                                    End If

                                End If

                            Else

                                If Not BePresentacionStock Is Nothing Then

                                    If (BePresentacionStock.Factor > 0) Then

                                        vCantidadStockEnPres = Math.Round(vCantidadStock / BePresentacionStock.Factor, 6)

                                        vCantidadSolicitadaPedidoEnPres = vCantidadSolicitadaPedido

                                        If vCantidadSolicitadaPedidoEnPres > vCantidadStockEnPres Then

                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                                Throw New Exception(vbNewLine & String.Format("ERROR_202212140132B: {0} Código: {1} Sol: {2} Disp: {3}", clsDalEx.ErrorS0002A, BeProducto.Codigo, vCantidadSolicitadaPedido, vCantidadStockEnPres))
                                            Else
                                                vCantidadCompletada = False
                                            End If

                                        End If

                                    End If

                                End If

                            End If

                        Else

                            vCantidadStockZonaNoPicking = lBeStockExistenteZonasNoPicking.Sum(Function(x) x.Cantidad)
                            vCantidadStockZonaPicking = lBeStockExistenteZonaPicking.Sum(Function(x) x.Cantidad)
                            vCantidadTotalStock = vCantidadStockZonaNoPicking + vCantidadStockZonaPicking

                            If (vCantidadSolicitadaPedido > vCantidadStock) AndAlso (vCantidadSolicitadaPedido > vCantidadTotalStock) Then

                                If pBeConfigEnc.Rechazar_pedido_incompleto AndAlso Not pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking Then

                                    pCantidadDisponibleStock = vCantidadDispStock
                                    Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}", clsDalEx.ErrorS0002,
                                                                       BeProducto.Codigo,
                                                                       vCantidadSolicitadaPedido,
                                                                       vCantidadStock))
                                Else

                                    If vCantidadSolicitadaPedido > vDisponibleStockEnPres Then
                                        If pBeConfigEnc.Rechazar_pedido_incompleto Then
                                            Throw New Exception(String.Format("Error_202212140140C: {0} Código: {1} Sol: {2} Disp: {3}",
                                                                              clsDalEx.ErrorS0002A,
                                                                              BeProducto.Codigo,
                                                                              vCantidadSolicitadaPedido,
                                                                              vCantidadStockEnPres))
                                        Else
                                            '#CKFK20230211 Aqregué esta validación para que no me cambie la cantidad reservada
                                            If pStockResSolicitud.IdPresentacion <> 0 Then
                                                vCantidadSolicitadaPedido = vCantidadDispStockEnPres
                                            End If
                                        End If

                                    Else
                                        '#EJC202212140117: Aquí va a nacer otra condición faltante. (caso de unidades).
                                        vCantidadSolicitadaPedido = vCantidadDispStockEnPres
                                    End If

                                End If

                            End If

                        End If

                        '#EJC20180614: Cantidad total disponible en stock.
                        vCantidadDispStock = lBeStockExistente.Sum(Function(x) x.Cantidad)

                        '#CKFK20221116 Por lo que he debuggeado aquí se colocan las cantidades tal como se piden en el pedido
                        vCantidadPendiente = vCantidadSolicitadaPedido

                        If IdProducto = 0 Then
                            IdProducto = BeProducto.IdProducto
                        End If

ANALIZAR_FECHAS_DE_VENCIMIENTO:

#Region "Recalcular stocks y fechas de vencimiento"

                        '#EJC202309271639: Se busca explosionar primero de zonas de picking.
                        lBeStockExistenteZonaPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              False,
                                                              True,
                                                              pTarea_Reabasto)

                        Restar_Stock_Reservado(lBeStockExistenteZonaPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        lBeStockExistenteZonaPicking = lBeStockExistenteZonaPicking.FindAll(Function(x) x.Cantidad > 0)

                        lBeStockExistenteZonasNoPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                  pStockResSolicitud,
                                                                  pStockResBusquedaParaExplosion),
                                                              BeProducto,
                                                              DiasVencimiento,
                                                              pBeConfigEnc,
                                                              lConnection,
                                                              ltransaction,
                                                              True,
                                                              True,
                                                              pTarea_Reabasto)


                        Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.FindAll(Function(x) x.Cantidad > 0)

#End Region

                        Restar_Stock_Reservado(lBeStockExistente,
                                               pBeConfigEnc,
                                               lConnection,
                                               ltransaction)

                        If lBeStockExistente.Count > 0 Then
                            lBeStockExistente = lBeStockExistente.FindAll(Function(x) x.Cantidad > 0)
                        End If

                        vFechaMinimaVenceZonaPicking = New Date(1900, 1, 1)
                        vFechaMinimaVenceZonaALM = New Date(1900, 1, 1)
                        vVenceMinimaPickingCompletoClavaud = New Date(1900, 1, 1)
                        vVenceMinimaPickingInCompletoClavaud = New Date(1900, 1, 1)

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                          DiasVencimiento,
                                                                                          pBeConfigEnc,
                                                                                          lConnection,
                                                                                          ltransaction,
                                                                                          BeProducto,
                                                                                          pTarea_Reabasto,
                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                          vFechaMinimaVenceZonaALM,
                                                                                          lBeStockExistente,
                                                                                          BePresentacionStock)

                        vFechaMinima = FechaMinimaVenceStock

                        If vFechaMinimaVenceZonaALM > vFechaMinimaVenceZonaPicking Then

                            If Not lBeStockExistenteZonaPicking Is Nothing Then

                                If lBeStockExistenteZonaPicking.Count > 0 Then

                                    lBeStockExistente = lBeStockExistenteZonaPicking

                                    Restar_Stock_Reservado(lBeStockExistente,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)

                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                End If

                            End If

                        Else
                            If Not lBeStockExistenteZonasNoPicking Is Nothing Then
                                If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                    lBeStockExistente = lBeStockExistenteZonasNoPicking
                                    Iniciar_En = 3
                                End If
                            End If
                        End If

                        If pBeConfigEnc.Conservar_Zona_Picking_Clavaud Then

                            vCantPVConPalletsCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = True _
                                                                                           AndAlso x.UbicacionPicking = False _
                                                                                           AndAlso x.Fecha_vence <= FechaMinimaVenceStock).Count()

                            vCantPVConPalletsInCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = False _
                                                                                           AndAlso x.UbicacionPicking = False _
                                                                                           AndAlso x.Fecha_vence <= FechaMinimaVenceStock).Count()


                            'Reservo pallets completos que no están en zonas de picking (generalmente rack o piso)
                            lBeStockConPalletsCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = True _
                                                                                           AndAlso x.UbicacionPicking = False)

                            'Reservo pallets incompletos (Producidos parcialmente o por proceso) de zonas que no son de picing.
                            lBeStockConPalletsInCompletosClavaud = lBeStockExistente.FindAll(Function(x) x.Pallet_Completo = False _
                                                                                           AndAlso x.UbicacionPicking = False)

                            If lBeStockConPalletsCompletosClavaud.Count > 0 Then
                                vVenceMinimaPickingCompletoClavaud = lBeStockConPalletsCompletosClavaud.Min(Function(x) x.Fecha_vence)
                            End If

                            If lBeStockConPalletsInCompletosClavaud.Count > 0 Then
                                vVenceMinimaPickingInCompletoClavaud = lBeStockConPalletsInCompletosClavaud.Min(Function(x) x.Fecha_vence)
                            End If

                            lBeStockZonaPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = True AndAlso x.Cantidad > 0).OrderBy(Function(x) x.Fecha_vence).ToList()
                            lBeStockZonasNoPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = False AndAlso x.Cantidad > 0).OrderBy(Function(x) x.Fecha_vence).ToList()

                        End If

                        If Iniciar_En = 0 Then
                            If pBeConfigEnc.Conservar_Zona_Picking_Clavaud Then

                                If vVenceMinimaPickingCompletoClavaud > vFechaMinima AndAlso (vVenceMinimaPickingCompletoClavaud.Date > New Date(1900, 1, 1)) Then
                                    Iniciar_En = 1
                                End If

                                If vFechaMinima > vVenceMinimaPickingInCompletoClavaud And vVenceMinimaPickingInCompletoClavaud > New Date(1900, 1, 1) Then
                                    Iniciar_En = 2
                                End If

                            End If
                        End If

                        If vFechaMinimaVenceZonaPicking = New Date(1900, 1, 1) AndAlso vFechaMinimaVenceZonaALM = New Date(1900, 1, 1) Then

                            If Not lBeStockExistente Is Nothing Then

                                If lBeStockExistenteZonasNoPicking.Count = 0 Then

                                    pStockResBusquedaParaExplosion = Nothing

                                    If pStockResSolicitud.IdPresentacion = 0 Then '#EJC20230202: Y la primera búsqueda fue en unidades.
                                        If Not BePresentacionStock Is Nothing Then '#EJC20230202: Entonces voy a buscar inventario en cajas (con la presentación por defecto si existe)
                                            clsPublic.CopyObject(pStockResSolicitud, pStockResBusquedaParaExplosion)
                                            pStockResBusquedaParaExplosion = pStockResSolicitud.Clone()
                                            pStockResBusquedaParaExplosion.IdPresentacion = BePresentacionStock.IdPresentacion
                                            vBusquedaEnUmBas = False
                                        Else
                                            Throw New Exception("ERROR_202302021127: Se está intentando reservar inventario que requiere explosión pero no está definida la presentación por defecto del producto: " & BeProducto.Codigo)
                                        End If
                                    Else

                                        If Not vEncontroExistenciaEnPresentacion Then

                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then
                                                Throw New Exception(String.Format("Error_202212140140D: {0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                               BeProducto.Codigo,
                                                                               pStockResSolicitud.Cantidad,
                                                                               0))
                                            Else

                                                If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                                    '#CKFK20230324 Agregué esta condición para que busque en unidades si la primera búsqueda fue en presentación
                                                    vBusquedaEnUmBas = True
                                                Else
                                                    '#EJC20230724 Se agregó esta condición para que cuando el pedido sea en UMBas y ya no haya existencias en presentación busque en UMBas
                                                    If Not BePedidoDet Is Nothing Then
                                                        If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                                            vBusquedaEnUmBas = True
                                                        End If
                                                    End If
                                                End If

                                            End If
                                        Else
                                            vBusquedaEnUmBas = True
                                        End If
                                    End If

                                    lBeStockExistenteZonasNoPicking = clsLnStock.lStock(IIf(vBusquedaEnUmBas,
                                                                                                      pStockResSolicitud,
                                                                                                      pStockResBusquedaParaExplosion),
                                                                                                  BeProducto,
                                                                                                  DiasVencimiento,
                                                                                                  pBeConfigEnc,
                                                                                                  lConnection,
                                                                                                  ltransaction,
                                                                                                  True,
                                                                                                  True,
                                                                                                  pTarea_Reabasto)

                                    Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)

                                    lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.FindAll(Function(x) x.Cantidad > 0)

                                    If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                        vFechaMinimaVenceZonaALM = lBeStockExistenteZonasNoPicking.Min(Function(x) x.Fecha_vence)
                                        If FechaMinimaVenceStock = New Date(1900, 1, 1) OrElse FechaMinimaVenceStock > vFechaMinimaVenceZonaALM Then
                                            vFechaMinima = vFechaMinimaVenceZonaALM
                                            Iniciar_En = 4
                                        End If
                                    End If

                                End If

                            End If

                        End If

                        If Iniciar_En = 0 Then
                            If vFechaMinima > vFechaMinimaVenceZonaPicking And vFechaMinimaVenceZonaPicking > New Date(1900, 1, 1) Then
                                Iniciar_En = 3
                            End If

                            If vFechaMinima > vFechaMinimaVenceZonaALM And vFechaMinimaVenceZonaALM > New Date(1900, 1, 1) Then
                                Iniciar_En = 3
                            End If

                            If vFechaMinima > FechaMinimaVenceStock And FechaMinimaVenceStock > New Date(1900, 1, 1) Then
                                Iniciar_En = 3
                            End If
                        End If

                        If Iniciar_En = 4 Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                lBeStockExistente = lBeStockExistenteZonasNoPicking
                                Iniciar_En = 0
                            End If
                        End If


                        Select Case Iniciar_En
                            Case 1
                                GoTo INICIAR_EN_1 'Tomar pallets completos lBeStockConPalletsCompletosClavaud
                            Case 2
                                GoTo INICIAR_EN_2 'Tomar de pallets incompletos lBeStockConPalletsInCompletosClavaud
                            Case 3
                                GoTo INICIAR_EN_3 'Tomar producto de la zona de picking.
                            Case Else
                                GoTo EJC_202308081248_RESERVAR_DESDE_ULITIMA_LISTA 'Tomar de la lista como la devolvió lStock
                        End Select

INICIAR_EN_1:
                        If Not ListaEstadosDeProceso.Contains(100) Then

                            If pBeConfigEnc.Conservar_Zona_Picking_Clavaud Then

                                For Each vStockOrigen As clsBeStock In lBeStockConPalletsCompletosClavaud

                                    BeStockDestino = New clsBeStock()
                                    clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                    vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                    If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                        ListaEstadosDeProceso.Add(100)
                                        GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                    ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                        ListaEstadosDeProceso.Add(100)
                                        Exit For
                                    Else
                                        ListaEstadosDeProceso.Add(100)
                                    End If

                                    BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                    vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                    If vIndiceUbicacion <> -1 Then
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                    Else
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                        lUbicaciones.Add(BeUbicacionStock.Clone())
                                    End If

                                    If vCantidadDispStock < 0 Then
                                        Throw New Exception("ERROR_202302061300E: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                    End If

                                    If vCantidadDispStock > 0 Then

                                        If pStockResSolicitud.IdPresentacion = 0 Then

                                            If pBeConfigEnc.Explosion_Automatica Then

                                                If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                    If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                        If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                            Continue For

                                                        End If

                                                    End If

                                                Else

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then
                                                        Continue For
                                                    End If

                                                End If

                                            End If

                                        End If

                                        If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                            BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                            vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If

                                            Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                            vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                            vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                            If BeStockRes.Indicador = "" Then BeStockRes.Indicador = "PED"
                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                            ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    vCantidadPendiente -= vCantidadPendiente
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                    BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion
                                                Else

                                                    BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                    BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                    BeStockDestino.Fec_agr = Now
                                                    BeStockDestino.IdPresentacion = 0
                                                    BeStockDestino.Presentacion.IdPresentacion = 0
                                                    BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                    BeStockRes.IdStock = BeStockDestino.IdStock
                                                    BeStockDestino.No_bulto = 1989
                                                    CantidadStockDestino = BeStockDestino.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockDestino.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    clsLnStock.Insertar(BeStockDestino,
                                                                        lConnection,
                                                                        ltransaction)

                                                    If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                    Else
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    End If

                                                    vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                    If vStockOrigen.Cantidad > 0 Then
                                                        clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                    Else
                                                        clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                    End If

                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                    BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220525
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#1_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                                    End If

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                        'Reservar el remanente en cajas completas.
                                                        vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                        BeStockRes = New clsBeStock_res
                                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                        If BeStockRes.Indicador = "" Then
                                                            BeStockRes.Indicador = "PED"
                                                        End If
                                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                        BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                        BeStockRes.Lote = vStockOrigen.Lote
                                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                        BeStockRes.Peso = vStockOrigen.Peso
                                                        BeStockRes.Estado = "UNCOMMITED"
                                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                        BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.IdPicking = 0
                                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                        BeStockRes.IdDespacho = 0
                                                        BeStockRes.añada = vStockOrigen.Añada
                                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.Host = MaquinaQueSolicita

                                                        If BeStockRes.Cantidad = 0 Then
                                                            Throw New Exception("Error_202302061305G: La cantidad a reservar no puede ser 0")
                                                        End If

                                                        CantidadStockDestino = BeStockRes.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                        Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                        vNombreCasoReservaInternoWMS = "CASO_#2_EJC202310090957"
                                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                        Dim vMensajeError20230301ABC As String = String.Format("Error_202303011301A: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                                       BeProducto.Codigo,
                                                                                                       vCantidadSolicitadaPedido,
                                                                                                       BeStockRes.Cantidad)

                                                        clsLnLog_error_wms.Agregar_Error(vMensajeError20230301ABC)

                                                        If Not pBeTrasladoDet Is Nothing Then
                                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                        End If


                                                        Restar_Stock_Reservado(lBeStockConPalletsCompletosClavaud,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                        lBeStockAReservar.Add(BeStockRes)

                                                    End If

                                                    vCantidadCompletada = (vCantidadPendiente = 0)

                                                    vCantidadEnteraTarimasCompletasClavaud -= 1

                                                    If vCantidadCompletada OrElse vCantidadEnteraTarimasCompletasClavaud = 0 Then Exit For

                                                End If

                                            ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)


                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                Else
                                                    Continue For
                                                End If

                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita

                                            If BeStockRes.Cantidad = 0 Then
                                                Throw New Exception("Error_202302061305G: La cantidad a reservar no puede ser 0")
                                            End If

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            If Math.Abs(CantidadStockDestino - Fix(CantidadStockDestino)) Then
                                                Throw New Exception("Error_202303101448C: El valor a insertar en stock sería un valor decimal no válido, se prevendrá continuar para evitar inconvenientes en reserva.")
                                            End If

                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#3_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                            End If

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            vCantidadEnteraTarimasCompletasClavaud -= 1


                                            Restar_Stock_Reservado(lBeStockConPalletsCompletosClavaud,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            If vCantidadCompletada OrElse vCantidadEnteraTarimasCompletasClavaud = 0 Then Exit For

                                        Else

                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                       lConnection,
                                                                                                                                       ltransaction)

                                                If Not BePresentacionStock Is Nothing Then

                                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                    If vIndicePresentacion <> -1 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                    Else
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If

                                                    vSolicitudEsEnUMBas = True

                                                End If

                                            ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                    clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                    If Not BePresentacionStock Is Nothing Then
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If
                                                End If

                                                vSolicitudEsEnUMBas = False

                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If


                                            Split_Decimal(pStockResSolicitud.Cantidad, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            If Not BePresentacionStock Is Nothing Then

                                                vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                            Else

                                                vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                            End If

                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                vCantidadPendienteEnPres = vCantidadPendiente
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                            Else

                                                vCantidadPendienteEnPres = vCantidadPendiente

                                                If pStockResSolicitud.IdPresentacion = 0 Then
                                                    vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                                Else
                                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                                End If

                                                If Not (vStockOrigen.IdPresentacion = 0) Then
                                                    If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                        vConvirtioCantidadSolicitadaEnUmBas = True
                                                    End If
                                                Else
                                                    vCantidadPendiente = vCantidadPendiente
                                                End If

                                            End If

                                            If vSolicitudEsEnUMBas Then

                                                If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                    If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                        clsLnLog_error_wms.Agregar_Error("#EJC202302081729A: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                    End If
                                                End If

                                            End If

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If Not vSolicitudEsEnUMBas Then
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            End If

                                            If vCantidadPendiente = vCantidadDispStock Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            ElseIf vCantidadPendiente < vCantidadDispStock Then
                                                Exit For 'No seguir buscando porque se infiere que no se logrará reservar nada que sea una tarima completa.
                                            ElseIf vCantidadPendiente > vCantidadDispStock Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)


                                            vNombreCasoReservaInternoWMS = "CASO_#4_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                            End If

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            vCantidadEnteraTarimasCompletasClavaud -= 1


                                            Restar_Stock_Reservado(lBeStockConPalletsCompletosClavaud,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            If vCantidadCompletada OrElse vCantidadEnteraTarimasCompletasClavaud = 0 Then Exit For

                                        End If

                                    End If

                                Next

INICIAR_EN_2:
                                If Not vCantidadCompletada Then

                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                      DiasVencimiento,
                                                                                                      pBeConfigEnc,
                                                                                                      lConnection,
                                                                                                      ltransaction,
                                                                                                      BeProducto,
                                                                                                      pTarea_Reabasto,
                                                                                                      vFechaMinimaVenceZonaPicking,
                                                                                                      vFechaMinimaVenceZonaALM,
                                                                                                      lBeStockExistente,
                                                                                                      BePresentacionStock)

                                    '#EJC202303031732: Condición y parametrizacióin solicitada por Carolina.
                                    If pTarea_Reabasto Then

                                        If pBeConfigEnc.considerar_paletizado_en_reabasto Then

                                            Dim vMensajeNoRellenado As String = "Error_202303031731: La tarea de reabasto para: " & pStockResSolicitud.Codigo_Producto & " no se generará porque no hay tarimas completas y la configuración está activa."

                                            Dim vMsgError As String = String.Format("{0} {1}", MethodBase.GetCurrentMethod.Name(), vMensajeNoRellenado)
                                            clsLnLog_error_wms.Agregar_Error(vMsgError)

                                            XtraMessageBox.Show(vMensajeNoRellenado,
                                                            "Reabasto",
                                                            MessageBoxButtons.OK,
                                                            MessageBoxIcon.Error)

                                            Exit Function

                                        End If

                                    End If

                                    For Each vStockOrigen As clsBeStock In lBeStockConPalletsInCompletosClavaud

                                        BeStockDestino = New clsBeStock()

                                        clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                        vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                        If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) AndAlso Not ListaEstadosDeProceso.Contains(101) AndAlso ListaEstadosDeProceso.Contains(100) Then
                                            ListaEstadosDeProceso.Add(101)
                                            GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                        ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                            ListaEstadosDeProceso.Add(101)
                                            Exit For
                                        Else
                                            ListaEstadosDeProceso.Add(101)
                                        End If

                                        BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                        vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                        If vIndiceUbicacion <> -1 Then
                                            BeUbicacionStock = New clsBeBodega_ubicacion()
                                            BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                        Else
                                            BeUbicacionStock = New clsBeBodega_ubicacion()
                                            BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                            lUbicaciones.Add(BeUbicacionStock.Clone())

                                        End If

                                        If vCantidadDispStock < 0 Then
                                            Throw New Exception("ERROR_202302061300F: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                        End If

                                        '#EJC20180620: Si la cantidad de un IdStock es 0, es porque la cantidad reservada es igual a lo disponible, por eso se valida aquí.
                                        If vCantidadDispStock > 0 Then

                                            If pStockResSolicitud.IdPresentacion = 0 Then

                                                If pBeConfigEnc.Explosion_Automatica Then

                                                    If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                        If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                            If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                                Continue For

                                                            End If

                                                        End If

                                                    Else

                                                        If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                            Continue For

                                                        End If

                                                    End If

                                                End If

                                            End If

                                            If (pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0) OrElse vBusquedaEnUmBas Then

                                                BePresentacionStock = Nothing
                                                vIndicePresentacion = -1

                                                If vStockOrigen.IdPresentacion <> 0 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}
                                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)
                                                End If

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    If Not vStockOrigen.IdPresentacion = 0 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                        clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                        If Not BePresentacionStock Is Nothing Then
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If
                                                    Else
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                            lConnection,
                                                                                                                                            ltransaction)

                                                        If Not BePresentacionStock Is Nothing Then
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If
                                                    End If
                                                End If

                                                If Not BePresentacionStock Is Nothing And Not vBusquedaEnUmBas Then
                                                    If Not BePresentacionStock.Factor = 0 Then
                                                        vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                                    End If
                                                End If

                                                Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                                Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                                If vCantidadDecimalStockUMBas = 0 AndAlso vBusquedaEnUmBas Then
                                                    vCantidadDecimalStockUMBas = pStockResSolicitud.Cantidad
                                                End If

                                                If Not vBusquedaEnUmBas Then

                                                    If BePresentacionStock.Factor > 0 Then
                                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                                    End If

                                                    vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                                End If

                                                BeStockRes = New clsBeStock_res
                                                BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                BeStockRes.Indicador = IIf(BeStockRes.Indicador = "", "PED", BeStockRes.Indicador)
                                                BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                BeStockRes.IdStock = vStockOrigen.IdStock
                                                BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                    Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                    If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                                        vCantidadPendiente -= vCantidadPendiente
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                        vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                        BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                                    Else

                                                        BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                        BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                        BeStockDestino.Fec_agr = Now
                                                        BeStockDestino.IdPresentacion = 0
                                                        BeStockDestino.Presentacion.IdPresentacion = 0
                                                        BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                        BeStockRes.IdStock = BeStockDestino.IdStock
                                                        BeStockDestino.No_bulto = 1989

                                                        CantidadStockDestino = BeStockDestino.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        clsLnStock.Insertar(BeStockDestino,
                                                                            lConnection,
                                                                            ltransaction)


                                                        If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                            vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                        Else
                                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                                        End If

                                                        vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                        If vStockOrigen.Cantidad > 0 Then
                                                            clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                        Else
                                                            clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                        End If

                                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                        vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                        BeStockRes.IdPresentacion = IIf(BeStockRes.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                        BeStockRes.Lote = vStockOrigen.Lote
                                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                        BeStockRes.Peso = vStockOrigen.Peso
                                                        BeStockRes.Estado = "UNCOMMITED"
                                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                        BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.IdPicking = 0
                                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                        BeStockRes.IdDespacho = 0
                                                        BeStockRes.añada = vStockOrigen.Añada
                                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.Host = MaquinaQueSolicita
                                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                        CantidadStockDestino = BeStockRes.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                        vNombreCasoReservaInternoWMS = "CASO_#5_EJC202310090957"
                                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                        If Not pBeTrasladoDet Is Nothing Then
                                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                         BeProducto,
                                                                                                                         lConnection,
                                                                                                                         ltransaction)
                                                        End If

                                                        lBeStockAReservar.Add(BeStockRes)


                                                        Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                        vCantidadDecimalTarimasCompletasClavaud -= 1

                                                        If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                            vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                            BeStockRes = New clsBeStock_res
                                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                            BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                            BeStockRes.Lote = vStockOrigen.Lote
                                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                            BeStockRes.Peso = vStockOrigen.Peso
                                                            BeStockRes.Estado = "UNCOMMITED"
                                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                            BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                            BeStockRes.IdPicking = 0
                                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                            BeStockRes.IdDespacho = 0
                                                            BeStockRes.añada = vStockOrigen.Añada
                                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                            BeStockRes.Host = MaquinaQueSolicita
                                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                            If BeStockRes.Cantidad = 0 Then
                                                                Throw New Exception("Error_202302061305A: La cantidad a reservar no puede ser 0")
                                                            End If

                                                            CantidadStockDestino = BeStockRes.Cantidad

                                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                            Insertar(BeStockRes,
                                                                     lConnection,
                                                                     ltransaction)

                                                            vNombreCasoReservaInternoWMS = "CASO_#6_EJC202310090957"
                                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                            If Not pBeTrasladoDet Is Nothing Then
                                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                             BeProducto,
                                                                                                                             lConnection,
                                                                                                                             ltransaction)
                                                            End If

                                                            lBeStockAReservar.Add(BeStockRes)


                                                            Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                            vCantidadDecimalTarimasCompletasClavaud -= 1

                                                        End If

                                                        vCantidadCompletada = (vCantidadPendiente = 0)

                                                        If vCantidadCompletada Then Exit For

                                                    End If

                                                ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                    Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                    If Not vBusquedaEnUmBas Then
                                                        If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                                            vCantidadPendiente -= vCantidadDispStock
                                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                        Else
                                                            Continue For
                                                        End If
                                                    Else
                                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                                        vCantidadPendiente -= vCantidadDispStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                        vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                                    End If

                                                End If
                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                If BeStockRes.Cantidad = 0 Then
                                                    Throw New Exception("Error_202302061305A: La cantidad a reservar no puede ser 0")
                                                End If

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#7_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)

                                                lBeStockAReservar.Add(BeStockRes)


                                                Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                                vCantidadDecimalTarimasCompletasClavaud -= 1

                                                If vCantidadCompletada Then Exit For

                                            Else

                                                'Se pidió en UMBAS y el stock está en UMBAS
                                                If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                       lConnection,
                                                                                                                                       ltransaction)

                                                    If Not BePresentacionStock Is Nothing Then

                                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                        If vIndicePresentacion <> -1 Then
                                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                        Else
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If

                                                        vSolicitudEsEnUMBas = True

                                                    End If


                                                ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                                    If vIndicePresentacion <> -1 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                    Else
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                        clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                        If Not BePresentacionStock Is Nothing Then
                                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                                        End If
                                                    End If

                                                    vSolicitudEsEnUMBas = False

                                                End If

                                                If Not BePresentacionStock Is Nothing Then
                                                    vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                                End If

                                                If Not (pStockResSolicitud.IdPresentacion = 0) Then
                                                    Split_Decimal(pStockResSolicitud.Cantidad, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                                    Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)
                                                Else
                                                    vCantidadDecimalStockUMBas = pStockResSolicitud.Cantidad
                                                End If

                                                If Not BePresentacionStock Is Nothing Then
                                                    If Not (pStockResSolicitud.IdPresentacion = 0) Then
                                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                                    End If
                                                Else
                                                    vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                                End If


                                                If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                    vCantidadPendienteEnPres = vCantidadPendiente
                                                    vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                                Else

                                                    vCantidadPendienteEnPres = vCantidadPendiente

                                                    If pStockResSolicitud.IdPresentacion = 0 Then
                                                        vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                                    Else
                                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                                    End If

                                                    If Not (vStockOrigen.IdPresentacion = 0) Then
                                                        If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                            vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                            vConvirtioCantidadSolicitadaEnUmBas = True
                                                        End If
                                                    Else
                                                        vCantidadPendiente = vCantidadPendiente
                                                    End If

                                                End If

                                                If vSolicitudEsEnUMBas Then

                                                    If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                        If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso (vCantidadDispStockEnPres < BePresentacionStock.Factor)) OrElse (vCantidadPendienteEnPres < vCantidadDispStockEnPres) Then
                                                            Continue For
                                                        End If
                                                    End If

                                                End If

                                                BeStockRes = New clsBeStock_res
                                                BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                BeStockRes.IdStock = vStockOrigen.IdStock
                                                BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                                If Not vSolicitudEsEnUMBas Then
                                                    BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                End If

                                                If vCantidadPendiente = vCantidadDispStock Then

                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                ElseIf vCantidadPendiente < vCantidadDispStock Then

                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                End If

                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                If BeStockRes.Cantidad = 0 Then
                                                    Throw New Exception("Error_202302061305B: La cantidad a reservar no puede ser 0")
                                                End If

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#8_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)
                                                lBeStockAReservar.Add(BeStockRes)


                                                Restar_Stock_Reservado(lBeStockConPalletsInCompletosClavaud,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                                If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then
                                                    vCantidadDecimalUMBas = vCantidadPendiente
                                                Else
                                                    If vCantidadPendiente = 0 AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                                        vCantidadDecimalUMBas = 0
                                                    Else
                                                        If lBeStockConPalletsInCompletosClavaud.Count = 1 AndAlso
                                                        lBeStockConPalletsInCompletosClavaud.Item(0).Cantidad = 0 AndAlso
                                                        vCantidadPendiente > 0 AndAlso vBusquedaEnUmBas Then
                                                            vCantidadDecimalUMBas = vCantidadPendiente
                                                        End If
                                                    End If
                                                End If

                                                vCantidadDecimalTarimasCompletasClavaud -= 1

                                                If vCantidadCompletada Then
                                                    Exit For
                                                End If

                                            End If

                                        End If

                                    Next

                                End If

                            End If

                        End If

                    End If
INICIAR_EN_3:
                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                          DiasVencimiento,
                                                                                          pBeConfigEnc,
                                                                                          lConnection,
                                                                                          ltransaction,
                                                                                          BeProducto,
                                                                                          pTarea_Reabasto,
                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                          vFechaMinimaVenceZonaALM,
                                                                                          lBeStockExistente,
                                                                                          BePresentacionStock)

                        '#EJC202308081023: Tomar producto de la zona de picking.
                        If lBeStockZonaPicking.Count = 0 Then
                            If lBeStockExistente.Count > 0 Then
                                lBeStockZonaPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = True AndAlso x.Cantidad > 0).ToList()
                            End If
                        End If

                        '#EJC202308081023: Tomar producto de las zonas de NO picking.
                        lBeStockZonasNoPicking = lBeStockExistente.Where(Function(x) x.UbicacionPicking = False AndAlso x.Cantidad > 0).ToList()

                    End If


EJC_202308081248_RESERVAR_DESDE_ZONA_PICKING:
#Region "Reservar stock de zona de picking"

                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                         DiasVencimiento,
                                                                                         pBeConfigEnc,
                                                                                         lConnection,
                                                                                         ltransaction,
                                                                                         BeProducto,
                                                                                         pTarea_Reabasto,
                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                         vFechaMinimaVenceZonaALM,
                                                                                         lBeStockExistente,
                                                                                         BePresentacionStock)

                        If Not ExcepcionFechaVenceEsInferiorEnZonaPicking Then

                            If pStockResSolicitud.IdPresentacion = 0 Then
                                '#EJC: Verificar que en ALM, no existan unidades antes de llevar de PICK.
                                lBeStockExistenteZonasNoPicking = clsLnStock.lStock(pStockResSolicitud,
                                                                                    BeProducto,
                                                                                    DiasVencimiento,
                                                                                    pBeConfigEnc,
                                                                                    lConnection,
                                                                                    ltransaction,
                                                                                    True,
                                                                                    False,
                                                                                    pTarea_Reabasto)

                                Restar_Stock_Reservado(lBeStockExistenteZonasNoPicking,
                                                       pBeConfigEnc,
                                                       lConnection,
                                                       ltransaction)

                                lBeStockExistenteZonasNoPicking = lBeStockExistenteZonasNoPicking.Where(Function(x) x.Cantidad > 0).ToList()

                            End If

                            For Each vStockOrigen As clsBeStock In lBeStockZonaPicking

                                BeStockDestino = New clsBeStock()
                                clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) AndAlso Not ListaEstadosDeProceso.Contains(100) AndAlso Not ListaEstadosDeProceso.Contains(101) AndAlso Not ListaEstadosDeProceso.Contains(102) Then
                                    ListaEstadosDeProceso.Add(102)
                                    GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                    If Not ListaEstadosDeProceso.Contains(102) Then
                                        ListaEstadosDeProceso.Add(102)
                                    End If
                                    GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                Else
                                    If Not ListaEstadosDeProceso.Contains(102) Then
                                        ListaEstadosDeProceso.Add(102)
                                    End If
                                End If

                                BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                If vIndiceUbicacion <> -1 Then
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                Else
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                    If Not BeUbicacionStock Is Nothing Then
                                        lUbicaciones.Add(BeUbicacionStock.Clone())
                                    End If
                                End If

                                If vCantidadDispStock < 0 Then
                                    Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                End If

                                If vCantidadDispStock > 0 Then

                                    If pStockResSolicitud.IdPresentacion = 0 Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                        Continue For

                                                    End If

                                                End If

                                            Else

                                                If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                    Continue For

                                                End If

                                            End If

                                        End If


                                    End If

                                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                            Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                                vCantidadPendiente -= vCantidadPendiente
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                            Else

                                                BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                BeStockDestino.Fec_agr = Now
                                                BeStockDestino.IdPresentacion = 0
                                                BeStockDestino.Presentacion.IdPresentacion = 0
                                                BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                BeStockRes.IdStock = BeStockDestino.IdStock
                                                BeStockDestino.No_bulto = 1989

                                                CantidadStockDestino = BeStockDestino.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                clsLnStock.Insertar(BeStockDestino,
                                                                        lConnection,
                                                                        ltransaction)

                                                If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                Else
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                End If

                                                '#EJC20220510: Quitar al stock en cajas, las unidades.
                                                vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                If vStockOrigen.Cantidad > 0 Then
                                                    clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                Else
                                                    clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                End If

                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#9_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                End If


                                                Restar_Stock_Reservado(lBeStockExistente,
                                                                           pBeConfigEnc,
                                                                           lConnection,
                                                                           ltransaction)

                                                lBeStockAReservar.Add(BeStockRes)

                                                lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                 DiasVencimiento,
                                                                                                                 pBeConfigEnc,
                                                                                                                 lConnection,
                                                                                                                 ltransaction,
                                                                                                                 BeProducto,
                                                                                                                 pTarea_Reabasto,
                                                                                                                 vFechaMinimaVenceZonaPicking,
                                                                                                                 vFechaMinimaVenceZonaALM,
                                                                                                                 lBeStockExistente,
                                                                                                                 BePresentacionDefecto)

                                                If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                    'Reservar el remanente en cajas completas.
                                                    vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                    BeStockRes = New clsBeStock_res
                                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                    BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#10_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                         BeProducto,
                                                                                                                         lConnection,
                                                                                                                         ltransaction)
                                                    End If

                                                    Restar_Stock_Reservado(lBeStockExistente,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionDefecto)

                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)

                                                If vCantidadCompletada Then
                                                    Exit For
                                                End If

                                            End If

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                            Else
                                                Continue For
                                            End If

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#11_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                        End If

                                        Restar_Stock_Reservado(lBeStockExistente,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                         DiasVencimiento,
                                                                                                         pBeConfigEnc,
                                                                                                         lConnection,
                                                                                                         ltransaction,
                                                                                                         BeProducto,
                                                                                                         pTarea_Reabasto,
                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                         lBeStockExistente,
                                                                                                         BePresentacionDefecto)
                                        If vCantidadCompletada Then
                                            Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                              BeProducto.Codigo,
                                                                                              vCantidadSolicitadaPedido,
                                                                                              BeStockRes.Cantidad)
                                            clsLnLog_error_wms.Agregar_Error(Log_20230301_N)
                                            Exit For
                                        End If

                                    Else
                                        'Se pidió en UMBAS y el stock está en UMBAS
                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                        lConnection,
                                                                                                                                        ltransaction)

                                            If Not BePresentacionStock Is Nothing Then

                                                vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If

                                                vSolicitudEsEnUMBas = True

                                            End If


                                        ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            vSolicitudEsEnUMBas = False

                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        Else
                                            vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                        End If

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            vCantidadPendienteEnPres = vCantidadPendiente
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                        Else

                                            vCantidadPendienteEnPres = vCantidadPendiente

                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                            Else
                                                vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                            End If

                                            If Not (vStockOrigen.IdPresentacion = 0) Then
                                                If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                    vConvirtioCantidadSolicitadaEnUmBas = True
                                                End If
                                            Else
                                                vCantidadPendiente = vCantidadPendiente
                                            End If

                                        End If

                                        If vSolicitudEsEnUMBas Then
                                            If vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                            ElseIf vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                    clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                End If
                                            End If
                                        End If

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If Not vSolicitudEsEnUMBas Then
                                            BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                        End If

                                        If vCantidadPendiente = vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente < vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#12_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                        End If

                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                          DiasVencimiento,
                                                                                                          pBeConfigEnc,
                                                                                                          lConnection,
                                                                                                          ltransaction,
                                                                                                          BeProducto,
                                                                                                          pTarea_Reabasto,
                                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                                          vFechaMinimaVenceZonaALM,
                                                                                                          lBeStockExistente,
                                                                                                          BePresentacionStock)

                                        If vCantidadCompletada Then
                                            Exit For
                                        End If

                                    End If

                                End If

                            Next

                        Else

#Region "Reserverar stock de zona NO Picking"

                            If Not vCantidadCompletada Then

                                For Each vStockOrigen As clsBeStock In lBeStockZonasNoPicking

                                    BeStockDestino = New clsBeStock()
                                    clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                    vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                    If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(100) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(101) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(102) _
                                        AndAlso Not ListaEstadosDeProceso.Contains(103) Then
                                        ListaEstadosDeProceso.Add(103)
                                        Exit For
                                    ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                        ListaEstadosDeProceso.Add(103)
                                        Exit For
                                    Else
                                        ListaEstadosDeProceso.Add(103)
                                    End If

                                    BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                    vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                              AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                    If vIndiceUbicacion <> -1 Then
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                    Else
                                        BeUbicacionStock = New clsBeBodega_ubicacion()
                                        BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                        vStockOrigen.IdBodega,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)
                                        If Not BeUbicacionStock Is Nothing Then
                                            lUbicaciones.Add(BeUbicacionStock.Clone())
                                        End If
                                    End If


                                    If vCantidadDispStock < 0 Then
                                        Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                    End If

                                    '#EJC20180620: Si la cantidad de un IdStock es 0, es porque la cantidad reservada es igual a lo disponible, por eso se valida aquí.
                                    If vCantidadDispStock > 0 Then

                                        If pStockResSolicitud.IdPresentacion = 0 Then

                                            If pBeConfigEnc.Explosion_Automatica Then

                                                If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                    If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                        If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                            Continue For

                                                        End If

                                                    End If

                                                Else

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                        Continue For

                                                    End If

                                                End If

                                            End If


                                        End If

                                        If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                            BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                            vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If

                                            Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))

                                            vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                            vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion

                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)

                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                            ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    vCantidadPendiente -= vCantidadPendiente
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                    BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                                Else


                                                    BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)

                                                    BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                    BeStockDestino.Fec_agr = Now
                                                    BeStockDestino.IdPresentacion = 0
                                                    BeStockDestino.Presentacion.IdPresentacion = 0
                                                    BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                    BeStockRes.IdStock = BeStockDestino.IdStock
                                                    BeStockDestino.No_bulto = 1989

                                                    CantidadStockDestino = BeStockDestino.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    clsLnStock.Insertar(BeStockDestino,
                                                                        lConnection,
                                                                        ltransaction)

                                                    If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                    Else
                                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                                    End If

                                                    vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                    If vStockOrigen.Cantidad > 0 Then
                                                        clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                    Else
                                                        clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                    End If

                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado

                                                    BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#13_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                    End If

                                                    Restar_Stock_Reservado(lBeStockExistente,
                                                                           pBeConfigEnc,
                                                                           lConnection,
                                                                           ltransaction)

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionDefecto)

                                                    If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                        vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                        BeStockRes = New clsBeStock_res
                                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion

                                                        If pStockResSolicitud.Indicador = "" Then
                                                            BeStockRes.Indicador = "PED"
                                                        Else
                                                            BeStockRes.Indicador = pStockResSolicitud.Indicador
                                                        End If

                                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                        BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                        BeStockRes.Lote = vStockOrigen.Lote
                                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                        BeStockRes.Peso = vStockOrigen.Peso
                                                        BeStockRes.Estado = "UNCOMMITED"
                                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                        BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.IdPicking = 0
                                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                        BeStockRes.IdDespacho = 0
                                                        BeStockRes.añada = vStockOrigen.Añada
                                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                        BeStockRes.Host = MaquinaQueSolicita
                                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1
                                                        CantidadStockDestino = BeStockRes.Cantidad

                                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                        vNombreCasoReservaInternoWMS = "CASO_#14_EJC202310090957"
                                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                        Insertar(BeStockRes,
                                                                 lConnection,
                                                                 ltransaction)

                                                        If Not pBeTrasladoDet Is Nothing Then
                                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                         BeProducto,
                                                                                                                         lConnection,
                                                                                                                         ltransaction)
                                                        End If


                                                        Restar_Stock_Reservado(lBeStockExistente,
                                                                               pBeConfigEnc,
                                                                               lConnection,
                                                                               ltransaction)

                                                        lBeStockAReservar.Add(BeStockRes)

                                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                         DiasVencimiento,
                                                                                                                         pBeConfigEnc,
                                                                                                                         lConnection,
                                                                                                                         ltransaction,
                                                                                                                         BeProducto,
                                                                                                                         pTarea_Reabasto,
                                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                                         lBeStockExistente,
                                                                                                                         BePresentacionDefecto)

                                                    End If

                                                    vCantidadCompletada = (vCantidadPendiente = 0)

                                                    If vCantidadCompletada Then
                                                        Exit For
                                                    End If

                                                End If

                                            ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                Split_Decimal(vCantidadPendienteEnPres,
                                                              vCantidadEnteraSolicitadaPedidoEnPres,
                                                              vCantidadDecimalSolicitadaPedidoEnPres)

                                                If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                    vCantidadAReservarPorIdStock = vCantidadDispStock
                                                    vCantidadPendiente -= vCantidadDispStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                    vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                                Else
                                                    Continue For
                                                End If

                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#15_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                            End If

                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                              DiasVencimiento,
                                                                                                              pBeConfigEnc,
                                                                                                              lConnection,
                                                                                                              ltransaction,
                                                                                                              BeProducto,
                                                                                                              pTarea_Reabasto,
                                                                                                              vFechaMinimaVenceZonaPicking,
                                                                                                              vFechaMinimaVenceZonaALM,
                                                                                                              lBeStockExistente,
                                                                                                              BePresentacionStock)

                                            If vCantidadCompletada Then
                                                Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                              BeProducto.Codigo,
                                                                                              vCantidadSolicitadaPedido,
                                                                                              BeStockRes.Cantidad)
                                                clsLnLog_error_wms.Agregar_Error(Log_20230301_N)
                                                Exit For
                                            End If

                                        Else
                                            'Se pidió en UMBAS y el stock está en UMBAS
                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                        lConnection,
                                                                                                                                        ltransaction)

                                                If Not BePresentacionStock Is Nothing Then

                                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                    If vIndicePresentacion <> -1 Then
                                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                    Else
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If

                                                    vSolicitudEsEnUMBas = True

                                                End If


                                            ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                    clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                    If Not BePresentacionStock Is Nothing Then
                                                        lPresentaciones.Add(BePresentacionStock.Clone())
                                                    End If
                                                End If

                                                vSolicitudEsEnUMBas = False

                                            End If

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                            End If

                                            Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                            Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                            If Not BePresentacionStock Is Nothing Then
                                                vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                            Else
                                                vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                            End If

                                            If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                                vCantidadPendienteEnPres = vCantidadPendiente
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                            Else

                                                vCantidadPendienteEnPres = vCantidadPendiente

                                                If pStockResSolicitud.IdPresentacion = 0 Then
                                                    vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                                Else
                                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                                End If

                                                If Not (vStockOrigen.IdPresentacion = 0) Then
                                                    If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                        vConvirtioCantidadSolicitadaEnUmBas = True
                                                    End If
                                                Else
                                                    vCantidadPendiente = vCantidadPendiente
                                                End If

                                            End If

                                            If vSolicitudEsEnUMBas Then
                                                If vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                                ElseIf vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                    If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                        clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                    End If
                                                End If
                                            End If

                                            BeStockRes = New clsBeStock_res
                                            BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                            BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                            BeStockRes.IdBodega = vStockOrigen.IdBodega
                                            BeStockRes.IdStock = vStockOrigen.IdStock
                                            BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                            BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                            If Not vSolicitudEsEnUMBas Then
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            End If

                                            If vCantidadPendiente = vCantidadDispStock Then

                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            ElseIf vCantidadPendiente < vCantidadDispStock Then

                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            ElseIf vCantidadPendiente > vCantidadDispStock Then

                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            End If

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#16_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                             BeProducto,
                                                                                                             lConnection,
                                                                                                             ltransaction)
                                            End If


                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            vCantidadCompletada = (vCantidadPendiente = 0)
                                            lBeStockAReservar.Add(BeStockRes)

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                              DiasVencimiento,
                                                                                                              pBeConfigEnc,
                                                                                                              lConnection,
                                                                                                              ltransaction,
                                                                                                              BeProducto,
                                                                                                              pTarea_Reabasto,
                                                                                                              vFechaMinimaVenceZonaPicking,
                                                                                                              vFechaMinimaVenceZonaALM,
                                                                                                              lBeStockExistente,
                                                                                                              BePresentacionStock)

                                            If vCantidadCompletada Then
                                                Exit For
                                            End If

                                        End If

                                    End If

                                Next

                            End If
#End Region

                        End If

                    End If

#End Region

EJC_202308081248_RESERVAR_DESDE_ZONA_NO_PICKING:
#Region "Reservar stock de zona NO Picking"

                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                          DiasVencimiento,
                                                                                          pBeConfigEnc,
                                                                                          lConnection,
                                                                                          ltransaction,
                                                                                          BeProducto,
                                                                                          pTarea_Reabasto,
                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                          vFechaMinimaVenceZonaALM,
                                                                                          lBeStockExistente,
                                                                                          BePresentacionStock)

                        If lBeStockZonasNoPicking.Count = 0 Then
                            If lBeStockExistenteZonasNoPicking.Count > 0 Then
                                lBeStockZonasNoPicking = lBeStockExistenteZonasNoPicking
                                Restar_Stock_Reservado(lBeStockZonasNoPicking,
                                                       pBeConfigEnc,
                                                       lConnection,
                                                       ltransaction)

                                If Not lBeStockZonasNoPicking Is Nothing Then
                                    If lBeStockZonasNoPicking.Count > 0 Then
                                        lBeStockZonasNoPicking = lBeStockZonasNoPicking.Where(Function(x) x.UbicacionPicking = False _
                                                                                              AndAlso x.Cantidad > 0).OrderBy(Function(x) x.Fecha_vence).ToList()
                                    End If
                                End If
                            End If
                        End If

                        For Each vStockOrigen As clsBeStock In lBeStockZonasNoPicking

                            BeStockDestino = New clsBeStock()
                            clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                            vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                            If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(100) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(101) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(102) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(103) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(104) Then
                                If Not ListaEstadosDeProceso.Contains(104) Then
                                    ListaEstadosDeProceso.Add(104)
                                End If
                                GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                            ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                If Not ListaEstadosDeProceso.Contains(104) Then
                                    ListaEstadosDeProceso.Add(104)
                                End If
                                GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                            Else
                                If Not ListaEstadosDeProceso.Contains(104) Then
                                    ListaEstadosDeProceso.Add(104)
                                End If
                            End If

                            BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                            vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                          AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                            If vIndiceUbicacion <> -1 Then
                                BeUbicacionStock = New clsBeBodega_ubicacion()
                                BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                            Else
                                BeUbicacionStock = New clsBeBodega_ubicacion()
                                BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                    vStockOrigen.IdBodega,
                                                                                                                    lConnection,
                                                                                                                    ltransaction)
                                If Not BeUbicacionStock Is Nothing Then
                                    lUbicaciones.Add(BeUbicacionStock.Clone())
                                End If
                            End If

                            If vCantidadDispStock < 0 Then
                                Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                            End If

                            '#EJC20180620: Si la cantidad de un IdStock es 0, es porque la cantidad reservada es igual a lo disponible, por eso se valida aquí.
                            If vCantidadDispStock > 0 Then

                                If pStockResSolicitud.IdPresentacion = 0 Then

                                    If pBeConfigEnc.Explosion_Automatica Then

                                        If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                            If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then
                                                Continue For
                                            End If

                                        End If

                                    End If

                                End If

                                If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                    BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                    vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                    If vIndicePresentacion <> -1 Then
                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                        BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                    Else
                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                        BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                        clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                        If Not BePresentacionStock Is Nothing Then
                                            lPresentaciones.Add(BePresentacionStock.Clone())
                                        End If
                                    End If

                                    If Not BePresentacionStock Is Nothing Then
                                        vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                    End If

                                    Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                    Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                    vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                    vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                    vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                    '#EJC202309121310: Revisión escensario explosión de cajas por solicitud de unidades, solo en niveles de picking.
                                    If (vStockOrigen.IdPresentacion <> 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If Not BeUbicacionStock.Ubicacion_picking Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    Dim BeUnidadMedida As New clsBeUnidad_medida
                                                    BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                    If Not BeUnidadMedida Is Nothing Then

                                                        '#CKFK20230918 Agregué esta funcionalidad para obtener el disponible en zona de picking
                                                        pStockResSolicitud.IdPresentacion = 0
                                                        lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                        vStockDispZonaPicking = 0

                                                        If lBeStockDisponible IsNot Nothing Then
                                                            If lBeStockDisponible.Count > 0 Then
                                                                Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                                lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                                vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                            End If
                                                        End If

                                                        vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159E: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona no picking: " & vStockDispZonaPicking
                                                        Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                        clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                    End If

                                                End If

                                            Else
                                                Dim BeUnidadMedida As New clsBeUnidad_medida
                                                BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                If Not BeUnidadMedida Is Nothing Then

                                                    '#CKFK20230918 Agregué esta funcionalidad para obtener el disponible en zona de picking
                                                    pStockResSolicitud.IdPresentacion = 0
                                                    lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                           BeProducto,
                                                                                           DiasVencimiento,
                                                                                           pBeConfigEnc,
                                                                                           lConnection,
                                                                                           ltransaction,
                                                                                           False,
                                                                                           False,
                                                                                           pTarea_Reabasto)

                                                    vStockDispZonaPicking = 0

                                                    If lBeStockDisponible IsNot Nothing Then
                                                        If lBeStockDisponible.Count > 0 Then
                                                            Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                            lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                            vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                        End If
                                                    End If

                                                    vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159F: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp: " & vStockDispZonaPicking
                                                    Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                    clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)
                                                End If
                                            End If

                                        End If

                                    End If

                                    BeStockRes = New clsBeStock_res
                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                    If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                        vCantidadPendiente -= vCantidadDispStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                        vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                    ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then


                                        Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)


                                        If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadPendiente
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                            BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                        Else


                                            BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                            BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                            BeStockDestino.Fec_agr = Now
                                            BeStockDestino.IdPresentacion = 0
                                            BeStockDestino.Presentacion.IdPresentacion = 0
                                            BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                            BeStockRes.IdStock = BeStockDestino.IdStock
                                            BeStockDestino.No_bulto = 1989

                                            CantidadStockDestino = BeStockDestino.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            clsLnStock.Insertar(BeStockDestino,
                                                                lConnection,
                                                                ltransaction)

                                            If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                            Else
                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                            End If

                                            vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                            If vStockOrigen.Cantidad > 0 Then
                                                clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                            Else
                                                clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                            End If

                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#17_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                            End If

                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                   pBeConfigEnc,
                                                                   lConnection,
                                                                   ltransaction)

                                            lBeStockAReservar.Add(BeStockRes)

                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                              DiasVencimiento,
                                                                                                              pBeConfigEnc,
                                                                                                              lConnection,
                                                                                                              ltransaction,
                                                                                                              BeProducto,
                                                                                                              pTarea_Reabasto,
                                                                                                              vFechaMinimaVenceZonaPicking,
                                                                                                              vFechaMinimaVenceZonaALM,
                                                                                                              lBeStockExistente,
                                                                                                              BePresentacionStock)

                                            If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                BeStockRes = New clsBeStock_res
                                                BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                BeStockRes.IdStock = vStockOrigen.IdStock
                                                BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#18_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                                End If


                                                Restar_Stock_Reservado(lBeStockExistente,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                                lBeStockAReservar.Add(BeStockRes)

                                                lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                  DiasVencimiento,
                                                                                                                  pBeConfigEnc,
                                                                                                                  lConnection,
                                                                                                                  ltransaction,
                                                                                                                  BeProducto,
                                                                                                                  pTarea_Reabasto,
                                                                                                                  vFechaMinimaVenceZonaPicking,
                                                                                                                  vFechaMinimaVenceZonaALM,
                                                                                                                  lBeStockExistente,
                                                                                                                  BePresentacionStock)

                                            End If

                                            vCantidadCompletada = (vCantidadPendiente = 0)

                                            If vCantidadCompletada Then
                                                Exit For
                                            End If

                                        End If

                                    ElseIf vCantidadPendiente > vCantidadDispStock Then


                                        Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                        If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        Else
                                            Continue For
                                        End If

                                    End If

                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                    BeStockRes.Lote = vStockOrigen.Lote
                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                    BeStockRes.Peso = vStockOrigen.Peso
                                    BeStockRes.Estado = "UNCOMMITED"
                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                    BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.IdPicking = 0
                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                    BeStockRes.IdDespacho = 0
                                    BeStockRes.añada = vStockOrigen.Añada
                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.Host = MaquinaQueSolicita
                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                    CantidadStockDestino = BeStockRes.Cantidad

                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                    Insertar(BeStockRes,
                                             lConnection,
                                             ltransaction)

                                    vNombreCasoReservaInternoWMS = "CASO_#19_EJC202310090957"
                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                    If Not pBeTrasladoDet Is Nothing Then
                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                     BeProducto,
                                                                                                     lConnection,
                                                                                                     ltransaction)
                                    End If

                                    Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                    vCantidadCompletada = (vCantidadPendiente = 0)
                                    lBeStockAReservar.Add(BeStockRes)

                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                    DiasVencimiento,
                                                                                                    pBeConfigEnc,
                                                                                                    lConnection,
                                                                                                    ltransaction,
                                                                                                    BeProducto,
                                                                                                    pTarea_Reabasto,
                                                                                                    vFechaMinimaVenceZonaPicking,
                                                                                                    vFechaMinimaVenceZonaALM,
                                                                                                    lBeStockExistente,
                                                                                                    BePresentacionStock)

                                    If vCantidadCompletada Then
                                        Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                          BeProducto.Codigo,
                                                                                          vCantidadSolicitadaPedido,
                                                                                          BeStockRes.Cantidad)
                                        clsLnLog_error_wms.Agregar_Error(Log_20230301_N)
                                        Exit For
                                    End If

                                Else

                                    If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        BePresentacionStock = New clsBeProducto_Presentacion()
                                        BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                    lConnection,
                                                                                                                                    ltransaction)

                                        If Not BePresentacionStock Is Nothing Then

                                            vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If

                                            vSolicitudEsEnUMBas = True

                                        End If


                                    ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        vSolicitudEsEnUMBas = False

                                    End If

                                    If Not BePresentacionStock Is Nothing Then
                                        vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                    End If

                                    Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                    Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                    If Not BePresentacionStock Is Nothing Then
                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                    Else
                                        vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                    End If

                                    If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        vCantidadPendienteEnPres = vCantidadPendiente
                                        vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                    Else

                                        vCantidadPendienteEnPres = vCantidadPendiente

                                        If pStockResSolicitud.IdPresentacion = 0 Then
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                        Else
                                            vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                        End If

                                        If Not (vStockOrigen.IdPresentacion = 0) Then
                                            If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                vConvirtioCantidadSolicitadaEnUmBas = True
                                            End If
                                        Else
                                            vCantidadPendiente = vCantidadPendiente
                                        End If

                                    End If

                                    If vSolicitudEsEnUMBas Then
                                        If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                            If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                            End If
                                        End If
                                    End If

                                    If (vStockOrigen.IdPresentacion <> 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If Not BeUbicacionStock.Ubicacion_picking Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    Dim BeUnidadMedida As New clsBeUnidad_medida
                                                    BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                    If Not BeUnidadMedida Is Nothing Then

                                                        pStockResSolicitud.IdPresentacion = 0
                                                        lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                        vStockDispZonaPicking = 0

                                                        If lBeStockDisponible IsNot Nothing Then
                                                            If lBeStockDisponible.Count > 0 Then
                                                                Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                                lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                                vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                            End If
                                                        End If

                                                        vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159C: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                        Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                        clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)
                                                    End If

                                                End If

                                            Else

                                                Dim BeUnidadMedida As New clsBeUnidad_medida
                                                BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                If Not BeUnidadMedida Is Nothing Then

                                                    pStockResSolicitud.IdPresentacion = 0
                                                    lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                    vStockDispZonaPicking = 0

                                                    If lBeStockDisponible IsNot Nothing Then
                                                        If lBeStockDisponible.Count > 0 Then
                                                            Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                            lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                            vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                        End If
                                                    End If

                                                    vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159D: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                    Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                    clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                End If

                                            End If

                                        End If

                                    End If

                                    BeStockRes = New clsBeStock_res
                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                    If Not vSolicitudEsEnUMBas Then
                                        BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                    End If

                                    If vCantidadPendiente = vCantidadDispStock Then

                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                        vCantidadPendiente -= vCantidadDispStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                    ElseIf vCantidadPendiente < vCantidadDispStock Then

                                        vCantidadAReservarPorIdStock = vCantidadPendiente
                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                    ElseIf vCantidadPendiente > vCantidadDispStock Then

                                        vCantidadAReservarPorIdStock = vCantidadDispStock
                                        vCantidadPendiente -= vCantidadAReservarPorIdStock
                                        vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                    End If

                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                    BeStockRes.Lote = vStockOrigen.Lote
                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                    BeStockRes.Peso = vStockOrigen.Peso
                                    BeStockRes.Estado = "UNCOMMITED"
                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                    BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.IdPicking = 0
                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                    BeStockRes.IdDespacho = 0
                                    BeStockRes.añada = vStockOrigen.Añada
                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                    BeStockRes.Host = MaquinaQueSolicita
                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                    CantidadStockDestino = BeStockRes.Cantidad

                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                    Insertar(BeStockRes,
                                             lConnection,
                                             ltransaction)

                                    vNombreCasoReservaInternoWMS = "CASO_#20_EJC202310090957"
                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                    If Not pBeTrasladoDet Is Nothing Then
                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                     BeProducto,
                                                                                                     lConnection,
                                                                                                     ltransaction)
                                    End If


                                    Restar_Stock_Reservado(lBeStockExistente,
                                                           pBeConfigEnc,
                                                           lConnection,
                                                           ltransaction)

                                    vCantidadCompletada = (vCantidadPendiente = 0)
                                    lBeStockAReservar.Add(BeStockRes)

                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                    '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                      DiasVencimiento,
                                                                                                      pBeConfigEnc,
                                                                                                      lConnection,
                                                                                                      ltransaction,
                                                                                                      BeProducto,
                                                                                                      pTarea_Reabasto,
                                                                                                      vFechaMinimaVenceZonaPicking,
                                                                                                      vFechaMinimaVenceZonaALM,
                                                                                                      lBeStockExistente,
                                                                                                      BePresentacionStock)

                                    If vCantidadCompletada Then
                                        Exit For
                                    End If

                                End If

                            End If

                        Next

                        '#EJC202309120404: Identificar si la reserva se hizo o se está buscando umbas (si quedó cantidad pendiente de reserva)
                        If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                            vBusquedaEnUmBas = True
                        Else
                            If Not vCantidadCompletada Then
                                If Not BePedidoDet Is Nothing Then
                                    If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                        vBusquedaEnUmBas = True
                                    End If
                                End If
                            Else
                                Reserva_Stock_From_MI3 = True
                                Exit Function
                            End If
                        End If

                    End If

#End Region


EJC_202308081248_RESERVAR_DESDE_ULITIMA_LISTA:

                    If Not vCantidadCompletada Then

                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                          DiasVencimiento,
                                                                                          pBeConfigEnc,
                                                                                          lConnection,
                                                                                          ltransaction,
                                                                                          BeProducto,
                                                                                          pTarea_Reabasto,
                                                                                          vFechaMinimaVenceZonaPicking,
                                                                                          vFechaMinimaVenceZonaALM,
                                                                                          lBeStockExistente,
                                                                                          BePresentacionStock)

                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                        If lBeStockExistente.Count = 0 Then
                            If Not lBeStockExistenteZonaPicking.Count = 0 AndAlso vBusquedaEnUmBas Then
                                lBeStockExistente = lBeStockExistenteZonaPicking
                                lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()
                            End If
                        End If

                        If lBeStockExistente.Count > 0 Then

                            If FechaMinimaVenceStock.Date = New Date(1900, 1, 1) Then
                                FechaMinimaVenceStock = lBeStockExistente.Min(Function(x) x.Fecha_vence)
                            End If

                            If Not vCantidadCompletada AndAlso pStockResSolicitud.IdPresentacion = 0 Then
                                vBusquedaEnUmBas = True
                            Else
                                If Not BePedidoDet Is Nothing Then
                                    If Not vCantidadCompletada AndAlso BePedidoDet.IdPresentacion = 0 Then
                                        vBusquedaEnUmBas = True
                                    End If
                                End If
                            End If

                            For Each vStockOrigen As clsBeStock In lBeStockExistente

                                BeStockDestino = New clsBeStock()
                                clsPublic.CopyObject(vStockOrigen, BeStockDestino)

                                vCantidadDispStock = Math.Round(vStockOrigen.Cantidad, 6)

                                If (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(100) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(101) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(102) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(103) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(104) _
                                    AndAlso Not ListaEstadosDeProceso.Contains(105) Then
                                    ListaEstadosDeProceso.Add(105)
                                    Exit For
                                ElseIf (vStockOrigen.Fecha_vence > FechaMinimaVenceStock) Then
                                    ListaEstadosDeProceso.Add(105)
                                    GoTo ANALIZAR_FECHAS_DE_VENCIMIENTO
                                Else
                                    ListaEstadosDeProceso.Add(105)
                                End If

                                BeUbicacionEnMemoria = New clsBeBodega_ubicacion With {.IdUbicacion = vStockOrigen.IdUbicacion, .IdBodega = vStockOrigen.IdBodega}

                                vIndiceUbicacion = lUbicaciones.FindIndex(Function(x) x.IdUbicacion = BeUbicacionEnMemoria.IdUbicacion _
                                                                          AndAlso x.IdBodega = BeUbicacionEnMemoria.IdBodega)

                                If vIndiceUbicacion <> -1 Then
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = lUbicaciones(vIndiceUbicacion).Clone()
                                Else
                                    BeUbicacionStock = New clsBeBodega_ubicacion()
                                    BeUbicacionStock = clsLnBodega_ubicacion.Get_Single_By_IdUbicacion_And_IdBodega(vStockOrigen.IdUbicacion,
                                                                                                                    vStockOrigen.IdBodega,
                                                                                                                    lConnection,
                                                                                                                    ltransaction)
                                    If Not BeUbicacionStock Is Nothing Then
                                        lUbicaciones.Add(BeUbicacionStock.Clone())
                                    End If
                                End If


                                If vCantidadDispStock < 0 Then
                                    Throw New Exception("ERROR_202302061300G: La cantidad disponible en stock, reflejó un resultado negativo y no hay fundamento técncio para que eso ocurra (aún), reportar a dsearrollo.")
                                End If

                                If vCantidadDispStock > 0 AndAlso Not BeBodega.Permitir_Decimales Then

                                    If pStockResSolicitud.IdPresentacion = 0 Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If pBeConfigEnc.Explosion_Automatica_Nivel_Max > 0 Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then

                                                        Continue For

                                                    End If

                                                End If

                                            Else

                                                If Not (pBeConfigEnc.Explosion_Automatica_Desde_Ubicacion_Picking AndAlso BeUbicacionStock.Ubicacion_picking) Then
                                                    If Not vBusquedaEnUmBas Then
                                                        Continue For
                                                    End If
                                                End If

                                            End If

                                        End If


                                    End If

                                    If (vStockOrigen.IdPresentacion <> 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                        If pBeConfigEnc.Explosion_Automatica Then

                                            If Not BeUbicacionStock.Ubicacion_picking Then

                                                If Not pBeConfigEnc.Explosion_Automatica_Nivel_Max >= BeUbicacionStock.Nivel Then

                                                    Dim BeUnidadMedida As New clsBeUnidad_medida
                                                    BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                    If Not BeUnidadMedida Is Nothing Then

                                                        pStockResSolicitud.IdPresentacion = 0
                                                        lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                              BeProducto,
                                                                                              DiasVencimiento,
                                                                                              pBeConfigEnc,
                                                                                              lConnection,
                                                                                              ltransaction,
                                                                                              False,
                                                                                              False,
                                                                                              pTarea_Reabasto)

                                                        vStockDispZonaPicking = 0

                                                        If lBeStockDisponible IsNot Nothing Then
                                                            If lBeStockDisponible.Count > 0 Then
                                                                Restar_Stock_Reservado(lBeStockDisponible,
                                                                                       pBeConfigEnc,
                                                                                       lConnection,
                                                                                       ltransaction)

                                                                lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                                vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                            End If
                                                        End If

                                                        'FIN #CKFK20230202
                                                        vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159A: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                        Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                        clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                    End If

                                                End If

                                            Else

                                                Dim BeUnidadMedida As New clsBeUnidad_medida
                                                BeUnidadMedida = clsLnUnidad_medida.GetSingle(pStockResSolicitud.IdUnidadMedida, lConnection, ltransaction)

                                                If Not BeUnidadMedida Is Nothing Then

                                                    pStockResSolicitud.IdPresentacion = 0
                                                    lBeStockDisponible = clsLnStock.lStock(pStockResSolicitud,
                                                                                           BeProducto,
                                                                                           DiasVencimiento,
                                                                                           pBeConfigEnc,
                                                                                           lConnection,
                                                                                           ltransaction,
                                                                                           False,
                                                                                           False,
                                                                                           pTarea_Reabasto)

                                                    vStockDispZonaPicking = 0

                                                    If lBeStockDisponible IsNot Nothing Then

                                                        If lBeStockDisponible.Count > 0 Then

                                                            Restar_Stock_Reservado(lBeStockDisponible,
                                                                                   pBeConfigEnc,
                                                                                   lConnection,
                                                                                   ltransaction)

                                                            lBeStockDisponible = lBeStockDisponible.Where(Function(x) x.Cantidad > 0).ToList()
                                                            vStockDispZonaPicking = lBeStockDisponible.Sum(Function(x) x.Cantidad)

                                                        End If

                                                    End If

                                                    If Not vStockOrigen.UbicacionPicking Then

                                                        If Not Iniciar_En = 0 Then

                                                            vMensajeNoExplosionEnZonasNoPicking = "#ERROR_202309120159B: No se puede explosionar producto en zonas de no picking para el producto: " & BeProducto.Codigo & " Linea: " & No_Linea & " Cantidad: " & vCantidadPendiente & " UM: " & BeUnidadMedida.Nombre & " Disp. zona picking: " & vStockDispZonaPicking
                                                            Throw New Exception(vMensajeNoExplosionEnZonasNoPicking)
                                                            clsLnLog_error_wms.Agregar_Error(vMensajeNoExplosionEnZonasNoPicking)

                                                        End If

                                                    End If

                                                End If

                                            End If

                                        End If

                                    End If

                                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then


                                            Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then

                                                vCantidadAReservarPorIdStock = vCantidadPendiente
                                                vCantidadPendiente -= vCantidadPendiente
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion

                                            Else

                                                BeStockOriginal = clsLnStock.Get_Single_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                BeStockDestino.Cantidad = (1 * BePresentacionStock.Factor)
                                                BeStockDestino.Fec_agr = Now
                                                BeStockDestino.IdPresentacion = 0
                                                BeStockDestino.Presentacion.IdPresentacion = 0
                                                BeStockDestino.IdStock = clsLnStock.MaxID(lConnection, ltransaction) + 1
                                                BeStockRes.IdStock = BeStockDestino.IdStock
                                                BeStockDestino.No_bulto = 1989

                                                CantidadStockDestino = BeStockDestino.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                clsLnStock.Insertar(BeStockDestino,
                                                                    lConnection,
                                                                    ltransaction)


                                                If vCantidadPendiente > BeStockDestino.Cantidad Then
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente - BeStockDestino.Cantidad
                                                Else
                                                    vCantidadAReservarPorIdStock = vCantidadPendiente
                                                End If

                                                vStockOrigen.Cantidad = BeStockOriginal.Cantidad - (1 * BePresentacionStock.Factor)

                                                If vStockOrigen.Cantidad > 0 Then
                                                    clsLnStock.Actualizar_Cantidad(vStockOrigen, lConnection, ltransaction)
                                                Else
                                                    clsLnStock.Eliminar_By_IdStock(vStockOrigen.IdStock, lConnection, ltransaction)
                                                End If

                                                vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)

                                                BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                                BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                BeStockRes.Lote = vStockOrigen.Lote
                                                BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                BeStockRes.Peso = vStockOrigen.Peso
                                                BeStockRes.Estado = "UNCOMMITED"
                                                BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                BeStockRes.Uds_lic_plate = 20220525 'Marcar el stock reservado para indicar que se tomó a partir de una caja explosionada.
                                                BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.IdPicking = 0
                                                BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                BeStockRes.IdDespacho = 0
                                                BeStockRes.añada = vStockOrigen.Añada
                                                BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                BeStockRes.Host = MaquinaQueSolicita
                                                BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                CantidadStockDestino = BeStockRes.Cantidad

                                                vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                Insertar(BeStockRes,
                                                         lConnection,
                                                         ltransaction)

                                                vNombreCasoReservaInternoWMS = "CASO_#21_EJC202310090957"
                                                clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                If Not pBeTrasladoDet Is Nothing Then
                                                    pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                    clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                                End If


                                                Restar_Stock_Reservado(lBeStockExistente,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                                lBeStockAReservar.Add(BeStockRes)


                                                lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                If lBeStockExistente.Count > 0 Then
                                                    '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionDefecto)
                                                End If

                                                If vCantidadEnteraSolicitadaPedidoEnPres > 0 Then

                                                    'Reservar el remanente en cajas completas.
                                                    vCantidadAReservarPorIdStock = Math.Round(vCantidadEnteraSolicitadaPedidoEnPres * BePresentacionStock.Factor, 6)
                                                    vCantidadPendiente -= vCantidadAReservarPorIdStock
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                                    BeStockRes = New clsBeStock_res
                                                    BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                                    BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                                    BeStockRes.IdBodega = vStockOrigen.IdBodega
                                                    BeStockRes.IdStock = vStockOrigen.IdStock
                                                    BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                                    BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega
                                                    BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                                    BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                                    BeStockRes.IdPresentacion = BePresentacionStock.IdPresentacion
                                                    BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                                    BeStockRes.Lote = vStockOrigen.Lote
                                                    BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                                    BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                                    BeStockRes.Peso = vStockOrigen.Peso
                                                    BeStockRes.Estado = "UNCOMMITED"
                                                    BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                                    BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                                    BeStockRes.Uds_lic_plate = 20220526 'Marcar el stock reservado para indicar que se tomó a partir de cajas de una solicitud en unidades.
                                                    BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                                    BeStockRes.No_bulto = vStockOrigen.No_bulto
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.IdPicking = 0
                                                    BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                                    BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                                    BeStockRes.IdDespacho = 0
                                                    BeStockRes.añada = vStockOrigen.Añada
                                                    BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                                    BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                                    BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                                    BeStockRes.Host = MaquinaQueSolicita
                                                    BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                                    CantidadStockDestino = BeStockRes.Cantidad

                                                    vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                                    clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                                    Insertar(BeStockRes,
                                                             lConnection,
                                                             ltransaction)

                                                    vNombreCasoReservaInternoWMS = "CASO_#22_EJC202310090957"
                                                    clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                                    If Not pBeTrasladoDet Is Nothing Then
                                                        pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                        clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                     BeProducto,
                                                                                                                     lConnection,
                                                                                                                     ltransaction)
                                                    End If


                                                    Restar_Stock_Reservado(lBeStockExistente,
                                                                           pBeConfigEnc,
                                                                           lConnection,
                                                                           ltransaction)

                                                    lBeStockAReservar.Add(BeStockRes)

                                                    lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                                    FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                                     DiasVencimiento,
                                                                                                                     pBeConfigEnc,
                                                                                                                     lConnection,
                                                                                                                     ltransaction,
                                                                                                                     BeProducto,
                                                                                                                     pTarea_Reabasto,
                                                                                                                     vFechaMinimaVenceZonaPicking,
                                                                                                                     vFechaMinimaVenceZonaALM,
                                                                                                                     lBeStockExistente,
                                                                                                                     BePresentacionStock)

                                                End If

                                                vCantidadCompletada = (vCantidadPendiente = 0)

                                                If vCantidadCompletada Then
                                                    Exit For
                                                End If

                                            End If

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            Split_Decimal(vCantidadPendienteEnPres,
                                                          vCantidadEnteraSolicitadaPedidoEnPres,
                                                          vCantidadDecimalSolicitadaPedidoEnPres)

                                            If vCantidadDecimalSolicitadaPedidoEnPres = 0 Then
                                                vCantidadAReservarPorIdStock = vCantidadDispStock
                                                vCantidadPendiente -= vCantidadDispStock
                                                vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                            Else
                                                Continue For
                                            End If

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#23_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If


                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        If lBeStockExistente.Count > 0 Then
                                            '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3                                            
                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                             DiasVencimiento,
                                                                                                             pBeConfigEnc,
                                                                                                             lConnection,
                                                                                                             ltransaction,
                                                                                                             BeProducto,
                                                                                                             pTarea_Reabasto,
                                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                                             vFechaMinimaVenceZonaALM,
                                                                                                             lBeStockExistente,
                                                                                                             BePresentacionDefecto)
                                        End If

                                        If vCantidadCompletada Then
                                            Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                          BeProducto.Codigo,
                                                                                          vCantidadSolicitadaPedido,
                                                                                          BeStockRes.Cantidad)

                                            clsLnLog_error_wms.Agregar_Error(Log_20230301_N)

                                            Exit For

                                        End If

                                    Else

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                    lConnection,
                                                                                                                                    ltransaction)

                                            If Not BePresentacionStock Is Nothing Then

                                                vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If

                                                vSolicitudEsEnUMBas = True

                                            End If


                                        ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            vSolicitudEsEnUMBas = False

                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        Else
                                            vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                        End If

                                        '#EJC20231019: CASO 15 Se agregó NOT vOrdernarListaStockSinPresentacionPrimero
                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso Not vOrdernarListaStockSinPresentacionPrimero Then

                                            vCantidadPendienteEnPres = vCantidadPendiente
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                        Else

                                            vCantidadPendienteEnPres = vCantidadPendiente

                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                            Else
                                                vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                            End If

                                            If Not (vStockOrigen.IdPresentacion = 0) Then
                                                If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                    If Not vOrdernarListaStockSinPresentacionPrimero Then
                                                        '#EJC20231019: CASO 15 En vCantidadPendienteEnPres el valor asignado corresponde a las unidades.
                                                        vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                        vConvirtioCantidadSolicitadaEnUmBas = True
                                                    Else

                                                    End If
                                                End If
                                            Else
                                                vCantidadPendiente = vCantidadPendiente
                                            End If

                                        End If

                                        If vSolicitudEsEnUMBas Then

                                            If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                    clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                End If
                                            End If

                                        End If

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If Not vSolicitudEsEnUMBas Then
                                            If Not vOrdernarListaStockSinPresentacionPrimero Then
                                                BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                            Else
                                                BeStockRes.IdPresentacion = 0
                                            End If
                                        End If

                                        If vCantidadPendiente = vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente < vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1
                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#24_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If


                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)


                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                         DiasVencimiento,
                                                                                                         pBeConfigEnc,
                                                                                                         lConnection,
                                                                                                         ltransaction,
                                                                                                         BeProducto,
                                                                                                         pTarea_Reabasto,
                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                         lBeStockExistente,
                                                                                                         BePresentacionDefecto)
                                        If vCantidadCompletada Then
                                            Exit For
                                        End If

                                    End If

                                Else

                                    If pStockResSolicitud.IdPresentacion = 0 AndAlso vStockOrigen.IdPresentacion <> 0 Then

                                        BePresentacionStock = New clsBeProducto_Presentacion With {.IdPresentacion = vStockOrigen.IdPresentacion}

                                        vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                        If vIndicePresentacion <> -1 Then
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                        Else
                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                            clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                            If Not BePresentacionStock Is Nothing Then
                                                lPresentaciones.Add(BePresentacionStock.Clone())
                                            End If
                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If

                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        vCantidadPendienteEnPres = Math.Round(vCantidadPendiente / BePresentacionStock.Factor, 6)
                                        vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If vCantidadPendienteEnPres = vCantidadDispStockEnPres Then
                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)
                                        ElseIf vCantidadPendienteEnPres < vCantidadDispStockEnPres Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadPendiente
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                            If vCantidadPendiente = 0 Then
                                                vCantidadPendienteEnPres = 0
                                            Else
                                                vCantidadPendienteEnPres -= Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                            End If

                                            BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion
                                            BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                            BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                BeStockRes.IdPresentacion = 0
                                            Else
                                                BeStockRes.IdPresentacion = vStockOrigen.Presentacion.IdPresentacion
                                            End If
                                            BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                            BeStockRes.Lote = vStockOrigen.Lote
                                            BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                            BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                            BeStockRes.Peso = vStockOrigen.Peso
                                            BeStockRes.Estado = "UNCOMMITED"
                                            BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                            BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                            BeStockRes.Uds_lic_plate = 0
                                            BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                            BeStockRes.No_bulto = vStockOrigen.No_bulto
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.IdPicking = 0
                                            BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                            BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                            BeStockRes.IdDespacho = 0
                                            BeStockRes.añada = vStockOrigen.Añada
                                            BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                            BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                            BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                            BeStockRes.Host = MaquinaQueSolicita
                                            BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                            CantidadStockDestino = BeStockRes.Cantidad

                                            clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), BeBodega.Permitir_Decimales)

                                            Insertar(BeStockRes,
                                                     lConnection,
                                                     ltransaction)

                                            vNombreCasoReservaInternoWMS = "CASO_#25_EJC202310090957"
                                            clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                            If Not pBeTrasladoDet Is Nothing Then
                                                pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                                clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                                 BeProducto,
                                                                                                                 lConnection,
                                                                                                                 ltransaction)
                                            End If


                                            Restar_Stock_Reservado(lBeStockExistente,
                                                                       pBeConfigEnc,
                                                                       lConnection,
                                                                       ltransaction)

                                            lBeStockAReservar.Add(BeStockRes)


                                            lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                            FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                            DiasVencimiento,
                                                                                                            pBeConfigEnc,
                                                                                                            lConnection,
                                                                                                            ltransaction,
                                                                                                            BeProducto,
                                                                                                            pTarea_Reabasto,
                                                                                                            vFechaMinimaVenceZonaPicking,
                                                                                                            vFechaMinimaVenceZonaALM,
                                                                                                            lBeStockExistente,
                                                                                                            BePresentacionStock)

                                            vCantidadCompletada = (vCantidadPendiente = 0)

                                            If vCantidadCompletada Then
                                                Exit For
                                            End If

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)
                                            vCantidadPendienteEnPres -= Math.Round(vCantidadDispStock * BePresentacionStock.Factor, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#26_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If


                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                            DiasVencimiento,
                                                                                                            pBeConfigEnc,
                                                                                                            lConnection,
                                                                                                            ltransaction,
                                                                                                            BeProducto,
                                                                                                            pTarea_Reabasto,
                                                                                                            vFechaMinimaVenceZonaPicking,
                                                                                                            vFechaMinimaVenceZonaALM,
                                                                                                            lBeStockExistente,
                                                                                                            BePresentacionStock)

                                        If vCantidadCompletada Then
                                            Dim Log_20230301_N As String = String.Format("Log_202303011308N: Cantidad_Comletada_202303011301L: Código: {0} Sol: {1} Reservado: {2}. " & vbNewLine,
                                                                                          BeProducto.Codigo,
                                                                                          vCantidadSolicitadaPedido,
                                                                                          BeStockRes.Cantidad)
                                            clsLnLog_error_wms.Agregar_Error(Log_20230301_N)
                                            Exit For
                                        End If

                                    Else

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            BePresentacionStock = New clsBeProducto_Presentacion()
                                            BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                                    lConnection,
                                                                                                                                    ltransaction)

                                            If Not BePresentacionStock Is Nothing Then

                                                vIndicePresentacion = lPresentaciones.FindIndex(Function(x) x.IdPresentacion = BePresentacionStock.IdPresentacion)

                                                If vIndicePresentacion <> -1 Then
                                                    BePresentacionStock = New clsBeProducto_Presentacion()
                                                    BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                                Else
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If

                                                vSolicitudEsEnUMBas = True

                                            End If


                                        ElseIf vStockOrigen.IdPresentacion <> 0 Then

                                            If vIndicePresentacion <> -1 Then
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock = lPresentaciones(vIndicePresentacion).Clone()
                                            Else
                                                BePresentacionStock = New clsBeProducto_Presentacion()
                                                BePresentacionStock.IdPresentacion = vStockOrigen.IdPresentacion
                                                clsLnProducto_presentacion.GetSingle(BePresentacionStock, lConnection, ltransaction)
                                                If Not BePresentacionStock Is Nothing Then
                                                    lPresentaciones.Add(BePresentacionStock.Clone())
                                                End If
                                            End If

                                            vSolicitudEsEnUMBas = False

                                        End If

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadEnStockEnPres = Math.Round(vCantidadDispStock / BePresentacionStock.Factor, 6)
                                        End If


                                        Split_Decimal(vCantidadEnStockEnPres, vCantidadEnteraStockPres, vCantidadDecimalStockUMBas)
                                        Split_Decimal(pStockResSolicitud.Peso, vPesoEnteroPresStock, vPesoDecimalStockUMBas)

                                        If Not BePresentacionStock Is Nothing Then
                                            vCantidadDecimalUMBasStock = Math.Ceiling(Math.Round(vCantidadDecimalStockUMBas * BePresentacionStock.Factor, 2))
                                        Else

                                            vCantidadDecimalUMBasStock = vCantidadDecimalStockUMBas
                                        End If

                                        If (vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) Then

                                            vCantidadPendienteEnPres = vCantidadPendiente
                                            vCantidadDispStockEnPres = vStockOrigen.Cantidad

                                        Else

                                            vCantidadPendienteEnPres = vCantidadPendiente

                                            If pStockResSolicitud.IdPresentacion = 0 Then
                                                vCantidadDispStockEnPres = vStockOrigen.Cantidad
                                            Else
                                                vCantidadDispStockEnPres = Math.Round(vStockOrigen.Cantidad / BePresentacionStock.Factor, 6)
                                            End If

                                            If Not (vStockOrigen.IdPresentacion = 0) Then
                                                If Not vConvirtioCantidadSolicitadaEnUmBas Then
                                                    vCantidadPendiente = Math.Round(vCantidadPendiente * BePresentacionStock.Factor, 6)
                                                    vConvirtioCantidadSolicitadaEnUmBas = True
                                                End If
                                            Else
                                                vCantidadPendiente = vCantidadPendiente
                                            End If

                                        End If

                                        If vSolicitudEsEnUMBas Then
                                            If vCantidadPendienteEnPres > vCantidadDispStockEnPres Then
                                                If Not ((vStockOrigen.IdPresentacion = 0 AndAlso pStockResSolicitud.IdPresentacion = 0) AndAlso vCantidadDispStockEnPres < BePresentacionStock.Factor) Then
                                                    clsLnLog_error_wms.Agregar_Error("#EJC202302081729: Condición para reserva de unidades alcanzada, impacto desconocido.")
                                                End If
                                            End If
                                        End If

                                        BeStockRes = New clsBeStock_res
                                        BeStockRes.IdTransaccion = pStockResSolicitud.IdTransaccion
                                        BeStockRes.Indicador = IIf(pStockResSolicitud.Indicador = "", "PED", pStockResSolicitud.Indicador)
                                        BeStockRes.IdBodega = vStockOrigen.IdBodega
                                        BeStockRes.IdStock = vStockOrigen.IdStock
                                        BeStockRes.IdPropietarioBodega = vStockOrigen.IdPropietarioBodega
                                        BeStockRes.IdProductoBodega = vStockOrigen.IdProductoBodega

                                        If Not vSolicitudEsEnUMBas Then
                                            BeStockRes.IdPresentacion = IIf(pStockResSolicitud.IdPresentacion = 0, 0, vStockOrigen.Presentacion.IdPresentacion)
                                        End If

                                        If vCantidadPendiente = vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadDispStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente < vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadPendiente
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        ElseIf vCantidadPendiente > vCantidadDispStock Then

                                            vCantidadAReservarPorIdStock = vCantidadDispStock
                                            vCantidadPendiente -= vCantidadAReservarPorIdStock
                                            vCantidadPendiente = Math.Round(vCantidadPendiente, 6)

                                        End If

                                        BeStockRes.IdUbicacion = vStockOrigen.IdUbicacion
                                        BeStockRes.IdProductoEstado = vStockOrigen.ProductoEstado.IdEstado
                                        BeStockRes.IdUnidadMedida = vStockOrigen.IdUnidadMedida
                                        BeStockRes.Lote = vStockOrigen.Lote
                                        BeStockRes.Lic_plate = vStockOrigen.Lic_plate
                                        BeStockRes.Serial = IIf(No_Linea <> 0, No_Linea, vStockOrigen.Serial)
                                        BeStockRes.Peso = vStockOrigen.Peso
                                        BeStockRes.Estado = "UNCOMMITED"
                                        BeStockRes.Fecha_ingreso = vStockOrigen.Fecha_Ingreso
                                        BeStockRes.Fecha_vence = vStockOrigen.Fecha_vence
                                        BeStockRes.Uds_lic_plate = vStockOrigen.Uds_lic_plate
                                        BeStockRes.Ubicacion_ant = vStockOrigen.IdUbicacion_anterior
                                        BeStockRes.No_bulto = vStockOrigen.No_bulto
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.IdPicking = 0
                                        BeStockRes.IdPedido = pStockResSolicitud.IdPedido
                                        BeStockRes.IdPedidoDet = pStockResSolicitud.IdPedidoDet
                                        BeStockRes.IdDespacho = 0
                                        BeStockRes.añada = vStockOrigen.Añada
                                        BeStockRes.Fecha_manufactura = vStockOrigen.Fecha_Manufactura
                                        BeStockRes.Cantidad = Math.Round(vCantidadAReservarPorIdStock, 6)
                                        BeStockRes.IdRecepcion = vStockOrigen.IdRecepcionEnc
                                        BeStockRes.Host = MaquinaQueSolicita
                                        BeStockRes.IdStockRes = MaxID(lConnection, ltransaction) + 1

                                        CantidadStockDestino = BeStockRes.Cantidad

                                        vPermitirDecimales = clsLnBodega.Get_Permitir_Decimales(BeStockRes.IdBodega, lConnection, ltransaction)
                                        clsPublic.Abs(CantidadStockDestino - Fix(CantidadStockDestino), vPermitirDecimales)

                                        Insertar(BeStockRes,
                                                 lConnection,
                                                 ltransaction)

                                        vNombreCasoReservaInternoWMS = "CASO_#27_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not pBeTrasladoDet Is Nothing Then
                                            pBeTrasladoDet.Quantity_Reserved_WMS = BeStockRes.Cantidad
                                            clsLnI_nav_ped_traslado_det.Actualizar_Quantity_Reserved_WMS(pBeTrasladoDet,
                                                                                                         BeProducto,
                                                                                                         lConnection,
                                                                                                         ltransaction)
                                        End If


                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vCantidadCompletada = (vCantidadPendiente = 0)
                                        lBeStockAReservar.Add(BeStockRes)

                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                             DiasVencimiento,
                                                                                                             pBeConfigEnc,
                                                                                                             lConnection,
                                                                                                             ltransaction,
                                                                                                             BeProducto,
                                                                                                             pTarea_Reabasto,
                                                                                                             vFechaMinimaVenceZonaPicking,
                                                                                                             vFechaMinimaVenceZonaALM,
                                                                                                             lBeStockExistente,
                                                                                                             BePresentacionDefecto)

                                        If vCantidadCompletada Then
                                            Exit For
                                        End If

                                    End If

                                End If

                            Next

                        End If

                    End If

                    If lBeStockAReservar.Count > 0 Then

                        If Inserta_Stock_Reservado(lBeStockAReservar,
                                                   lConnection,
                                                   ltransaction) Then

                            pListStockResOUT.AddRange(lBeStockAReservar)

                            If Not (vCantidadCompletada AndAlso vCantidadPendiente > 0) AndAlso (pStockResSolicitud.IdPresentacion = 0 AndAlso vCantidadDecimalUMBas = 0) Then
                                vCantidadDecimalUMBas = vCantidadPendiente
                            ElseIf Not (vCantidadCompletada AndAlso vCantidadPendiente > 0) AndAlso (pStockResSolicitud.IdPresentacion <> 0 AndAlso vCantidadDecimalUMBas = 0 AndAlso pBeConfigEnc.Explosion_Automatica) Then
                                vCantidadDecimalUMBas = vCantidadPendiente
                            End If

                            If (pBeConfigEnc.Explosion_Automatica) AndAlso (vCantidadDecimalUMBas > 0) Then

                                If vCantidadDecimalUMBas > 0 Then

                                    Dim BeStockResUMBas As New clsBeStock_res
                                    BeStockResUMBas = BeStockRes.Clone()

                                    If vCantidadPendiente > 0 AndAlso Not (vCantidadDecimalUMBas = vCantidadPendiente) Then
                                        vCantidadDecimalUMBas += vCantidadPendiente
                                    End If

                                    BeStockResUMBas.Cantidad = vCantidadDecimalUMBas
                                    BeStockResUMBas.IdPresentacion = 0
                                    BeStockResUMBas.Serial = No_Linea

                                    If pStockResSolicitud.IdUbicacionAbastecerCon <> 0 Then
                                        BeStockResUMBas.IdUbicacionAbastecerCon = pStockResSolicitud.IdUbicacionAbastecerCon
                                    End If

                                    Dim vCantDisRef As Double = 0

                                    Dim ExcluirUbicacionesPicking As Boolean

                                    ExcluirUbicacionesPicking = pTarea_Reabasto

                                    If lBeStockExistente.Count = 0 Then

                                        If pStockResSolicitud.IdPresentacion = 0 Then vBusquedaEnUmBas = True

                                        lBeStockExistente = clsLnStock.lStock(pStockResSolicitud,
                                                                              BeProducto,
                                                                              DiasVencimiento,
                                                                              pBeConfigEnc,
                                                                              lConnection,
                                                                              ltransaction,
                                                                              True,
                                                                              True,
                                                                              pTarea_Reabasto)

                                        Restar_Stock_Reservado(lBeStockExistente,
                                                               pBeConfigEnc,
                                                               lConnection,
                                                               ltransaction)

                                        vRestoInventarioEnUmBas = True


                                        lBeStockExistente = lBeStockExistente.Where(Function(x) x.Cantidad > 0).ToList()

                                        '#EJC20231019_Get_Fecha_Vence_Minima_Stock_Reserva_MI3
                                        FechaMinimaVenceStock = Get_Fecha_Vence_Minima_Stock_Reserva_MI3(pStockResSolicitud,
                                                                                                         DiasVencimiento,
                                                                                                         pBeConfigEnc,
                                                                                                         lConnection,
                                                                                                         ltransaction,
                                                                                                         BeProducto,
                                                                                                         pTarea_Reabasto,
                                                                                                         vFechaMinimaVenceZonaPicking,
                                                                                                         vFechaMinimaVenceZonaALM,
                                                                                                         lBeStockExistente,
                                                                                                         BePresentacionDefecto)

                                        If pStockResSolicitud.IdPresentacion = 0 Then
                                            vZonaNoPickingStockEnUmBas = lBeStockExistente.Count > 0
                                        Else
                                            Debug.WriteLine("vZonaNoPickingStockEnUmBas = false")
                                        End If

                                    End If

                                    If pStockResSolicitud.IdPresentacion = 0 And Not pTarea_Reabasto And vZonaNoPickingStockEnUmBas Then
                                        ExcluirUbicacionesPicking = True
                                    End If

                                    'No tengo unidades en almacenaje.
                                    If vZonaNoPickingStockEnUmBas Then

                                        vNombreCasoReservaInternoWMS += "__LLR_CASO_#28_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                      DiasVencimiento,
                                                                      MaquinaQueSolicita,
                                                                      pBeConfigEnc,
                                                                      vCantDisRef,
                                                                      pIdPropietarioBodega,
                                                                      vlBeStockAReservarUMBas,
                                                                      lConnection,
                                                                      ltransaction,
                                                                      No_Linea,
                                                                      ExcluirUbicacionesPicking,
                                                                      pBeTrasladoDet) Then


                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                                pCantidadDisponibleStock = vCantidadDispStock
                                                Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                          BeProducto.Codigo,
                                                                          vCantidadSolicitadaPedido,
                                                                          vCantidadStock))

                                            Else
                                                Reserva_Stock_From_MI3 = False
                                            End If

                                        End If

                                    Else

                                        vNombreCasoReservaInternoWMS += "__LLR_CASO_#29_EJC202310090957"
                                        clsLnTrans_pe_det_log_reserva.Agregar_Log_Reserva(BeStockRes, vNombreCasoReservaInternoWMS)

                                        If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                      DiasVencimiento,
                                                                      MaquinaQueSolicita,
                                                                      pBeConfigEnc,
                                                                      vCantDisRef,
                                                                      pIdPropietarioBodega,
                                                                      vlBeStockAReservarUMBas,
                                                                      lConnection,
                                                                      ltransaction,
                                                                      No_Linea,
                                                                      False,
                                                                      pBeTrasladoDet) Then

                                            If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                                pCantidadDisponibleStock = vCantidadDispStock
                                                Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                              BeProducto.Codigo,
                                                                              vCantidadSolicitadaPedido,
                                                                              vCantidadStock))
                                            Else
                                                Exit Function
                                            End If

                                        End If

                                    End If

                                End If

                            End If

                            pStockResSolicitud = BeStockRes

                            If Not vlBeStockAReservarUMBas Is Nothing Then
                                If vlBeStockAReservarUMBas.Count > 0 Then
                                    lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                End If
                            End If

                            pListStockResOUT = lBeStockAReservar

                            Reserva_Stock_From_MI3 = True

                        Else
                            If Not vOrdernarListaStockSinPresentacionPrimero Then
                                Throw New Exception(String.Format("{0} IdProductoBodegaSol: {1}", clsDalEx.ErrorS0006, pStockResSolicitud.IdProductoBodega))
                            Else
                                Throw New Exception(vbNewLine & String.Format("{0} IdProductoBodegaSol: {1}", clsDalEx.ErrorS0002, pStockResSolicitud.IdProductoBodega))
                            End If
                        End If

                    Else
                        Throw New Exception(String.Format("{0} IdProductoBodegaSol: {1}", clsDalEx.ErrorS0005, pStockResSolicitud.IdProductoBodega))
                    End If

                Else

                    If pStockResSolicitud.IdPresentacion <> 0 Then

                        If (pBeConfigEnc.Explosion_Automatica) Then

                            Split_Decimal(pStockResSolicitud.Cantidad,
                                              vCantidadEnteraPres,
                                              vCantidadDecimalUMBas)

                            If IdProducto = 0 Then
                                IdProducto = clsLnProducto_bodega.Get_IdProducto_By_IdProductoBodega(pStockResSolicitud.IdProductoBodega,
                                                                                                     lConnection,
                                                                                                     ltransaction)
                            End If

                            If IdProducto <> 0 Then
                                BePresentacionStock = clsLnProducto_presentacion.Get_Presentacion_Defecto_By_IdProducto(IdProducto,
                                                                                                                        lConnection,
                                                                                                                        ltransaction)

                            End If

                            If Not BePresentacionStock Is Nothing Then
                                If Not BePresentacionStock.Factor = 0 Then

                                    vCantidadDecimalUMBas = Math.Ceiling(Math.Round(vCantidadDecimalUMBas * BePresentacionStock.Factor, 2))

                                    If vCantidadEnteraPres > 0 Then
                                        vCantidadSolicitadaPedido = vCantidadEnteraPres
                                    Else
                                        vCantidadSolicitadaPedido = vCantidadDecimalUMBas
                                    End If
                                End If
                            End If


                        Else
                            vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad * BePresentacionStock.Factor
                            vConvirtioCantidadSolicitadaEnUmBas = True
                        End If

                        If vCantidadDecimalUMBas > 0 Then

                            If (pBeConfigEnc.Explosion_Automatica) AndAlso (vCantidadDecimalUMBas > 0) Then

                                'IDENTIFICACIÓN B DE RECURSIVIDAD.
                                '#EJC20190602: Si existe cantidad en fracción se reserva en unidad de medida básica en base a: ('#EJC20190602_0137AM_REF20190602-0848)
                                If vCantidadDecimalUMBas > 0 Then

                                    Dim BeStockResUMBas As New clsBeStock_res
                                    BeStockResUMBas = pStockResSolicitud.Clone()

                                    If BeStockResUMBas.No_bulto = 0 Then

                                        BeStockResUMBas.Cantidad = vCantidadDecimalUMBas
                                        BeStockResUMBas.Atributo_Variante_1 = Nothing
                                        BeStockResUMBas.IdPresentacion = 0
                                        BeStockResUMBas.Serial = No_Linea
                                        BeStockResUMBas.No_bulto = 1965 'Identificación para solicitud recursiva.

                                        If pStockResSolicitud.IdUbicacionAbastecerCon <> 0 Then
                                            BeStockResUMBas.IdUbicacionAbastecerCon = pStockResSolicitud.IdUbicacionAbastecerCon
                                        End If

                                        Dim vCantDisRef As Double = 0

                                        If Inserta_Stock_Reservado(lBeStockAReservar, lConnection, ltransaction) Then

                                            If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                          DiasVencimiento,
                                                                          MaquinaQueSolicita,
                                                                          pBeConfigEnc,
                                                                          vCantDisRef,
                                                                          pIdPropietarioBodega,
                                                                          vlBeStockAReservarUMBas,
                                                                          lConnection,
                                                                          ltransaction,
                                                                          No_Linea,
                                                                          False,
                                                                          pBeTrasladoDet) Then

                                                If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                                    pCantidadDisponibleStock = vCantidadDispStock
                                                    Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                          BeProducto.Codigo,
                                                                          vCantidadSolicitadaPedido,
                                                                          vCantidadStock))
                                                Else
                                                    Exit Function
                                                End If

                                            End If

                                            '#CKFK20230207 Agregué esto porque no se agrega a la respuesta
                                            pStockResSolicitud = BeStockResUMBas

                                            If Not vlBeStockAReservarUMBas Is Nothing Then
                                                If vlBeStockAReservarUMBas.Count > 0 Then
                                                    lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                                End If
                                            End If

                                            pListStockResOUT = lBeStockAReservar
                                            Reserva_Stock_From_MI3 = True

                                        End If

                                        '#EJC20210707: Igualar el stock reservador con la solicitud.
                                        pStockResSolicitud = BeStockRes

                                        If Not vlBeStockAReservarUMBas Is Nothing Then
                                            If vlBeStockAReservarUMBas.Count > 0 Then
                                                lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                            End If
                                        End If

                                        '#EJC20220627_0927:Devolver la lista de stock reservado para adicionar en picking existente.
                                        pListStockResOUT = lBeStockAReservar
                                        Reserva_Stock_From_MI3 = True

                                    Else
                                        Exit Function
                                    End If

                                End If

                            End If

                        Else

                            If pBeConfigEnc.Despachar_existencia_parcial = tDespacharExistenciaParcial.No Then

                                If pStockResSolicitud.IdPresentacion = 0 Then
                                    Throw New Exception(String.Format("{0} Código:{1} UMBas={2} Pres='Sin pres' Cant={3} (Verifique si tiene existencia en UMBas en WMS) ", clsDalEx.ErrorS0004,
                                                                                                                                                                    BeProducto.Codigo,
                                                                                                                                                                    BeProducto.UnidadMedida.Nombre,
                                                                                                                                                                    pStockResSolicitud.Cantidad))
                                Else
                                    Throw New Exception(String.Format("{0} Código:{1} UMBas={2} Pres={3} Cant={4} (Verifique si tiene existencia en Pres. en WMS) ", clsDalEx.ErrorS0004,
                                                                                                                                                             BeProducto.Codigo,
                                                                                                                                                             BeProducto.UnidadMedida.Nombre,
                                                                                                                                                             pStockResSolicitud.IdPresentacion,
                                                                                                                                                             pStockResSolicitud.Cantidad))
                                End If

                            End If

                        End If

                    Else

                        'IDENTIFICACIÓN A DE RECURSIVIDAD.
                        '#CKFK20230202 No llega la cantidad pendiente solo se sabe que no está completo
                        vCantidadSolicitadaPedido = pStockResSolicitud.Cantidad

                        '#CKFK20230202 Aquí necesitamos mandar a explosionar el producto
                        If (pBeConfigEnc.Explosion_Automatica) AndAlso (vCantidadSolicitadaPedido > 0) AndAlso lBeStockExistente.Count > 0 Then

                            Dim BeStockResUMBas As New clsBeStock_res
                            BeStockResUMBas = pStockResSolicitud.Clone()

                            If BeStockResUMBas.No_bulto = 0 Then

                                BeStockResUMBas.Cantidad = vCantidadSolicitadaPedido
                                BeStockResUMBas.IdPresentacion = 0
                                BeStockResUMBas.Serial = No_Linea
                                BeStockResUMBas.No_bulto = 1965 'Identificación para solicitud recursiva.

                                If pStockResSolicitud.IdUbicacionAbastecerCon <> 0 Then
                                    BeStockResUMBas.IdUbicacionAbastecerCon = pStockResSolicitud.IdUbicacionAbastecerCon
                                End If

                                Dim vCantDisRef As Double = 0

                                If Inserta_Stock_Reservado(lBeStockAReservar,
                                                           lConnection,
                                                           ltransaction) Then

                                    If Not Reserva_Stock_From_MI3(BeStockResUMBas,
                                                                  DiasVencimiento,
                                                                  MaquinaQueSolicita,
                                                                  pBeConfigEnc,
                                                                  vCantDisRef,
                                                                  pIdPropietarioBodega,
                                                                  vlBeStockAReservarUMBas,
                                                                  lConnection,
                                                                  ltransaction,
                                                                  No_Linea,
                                                                  False,
                                                                  pBeTrasladoDet) Then

                                        If pBeConfigEnc.Rechazar_pedido_incompleto = tRechazarPedidoIncompleto.Si Then

                                            pCantidadDisponibleStock = vCantidadDispStock
                                            Throw New Exception(String.Format("{0} Código: {1} Sol: {2} Disp: {3}. " & vbNewLine, clsDalEx.ErrorS0002,
                                                                          BeProducto.Codigo,
                                                                          vCantidadSolicitadaPedido,
                                                                          vCantidadStock))
                                        Else
                                            Exit Function
                                        End If

                                    End If

                                End If

                                '#EJC20210707: Igualar el stock reservador con la solicitud.
                                pStockResSolicitud = BeStockRes

                                If Not vlBeStockAReservarUMBas Is Nothing Then
                                    If vlBeStockAReservarUMBas.Count > 0 Then
                                        lBeStockAReservar.AddRange(vlBeStockAReservarUMBas)
                                    End If
                                End If

                                '#EJC20220627_0927:Devolver la lista de stock reservado para adicionar en picking existente.
                                pListStockResOUT = lBeStockAReservar

                            Else
                                Exit Function
                            End If

                        End If

                    End If

                End If

            End If

        Catch ex As Exception
            Throw ex
        End Try

    End Function
