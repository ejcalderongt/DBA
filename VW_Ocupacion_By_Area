CREATE VIEW [dbo].[VW_Ocupacion_By_Area] AS
SELECT isnull(dbo.bodega_area.Descripcion,'ND') Area,
       dbo.bodega_ubicacion.IdUbicacion, 
       dbo.bodega.nombre as Tipo, 
	   max(ISNULL(dbo.stock.IdStock, 0)) AS IdStock,
       dbo.Nombre_Completo_Ubicacion(bodega_ubicacion.IdUbicacion, bodega_ubicacion.idbodega) Ubicacion
FROM   dbo.stock INNER JOIN dbo.producto_bodega ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega AND
	   dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega RIGHT OUTER JOIN 
	   dbo.bodega INNER JOIN
	   dbo.bodega_area ON dbo.bodega.IdBodega = dbo.bodega_area.IdBodega INNER JOIN
	   dbo.bodega_sector ON dbo.bodega_area.IdArea = dbo.bodega_sector.IdArea AND 
       dbo.bodega_area.IdBodega = dbo.bodega_sector.IdBodega INNER JOIN
	   dbo.bodega_tramo ON dbo.bodega_sector.IdSector = dbo.bodega_tramo.IdSector AND 
	   dbo.bodega_sector.IdBodega = dbo.bodega_tramo.IdBodega INNER JOIN
	   dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND 
	   dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
	   dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
	   dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion AND dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega
where dbo.stock.IdBodega = 1 and ISNULL(dbo.stock.IdStock, 0)>0
group by isnull(dbo.bodega_area.Descripcion,'ND'),
       dbo.bodega_ubicacion.IdUbicacion, 
       dbo.bodega.nombre, 
       bodega_ubicacion.IdUbicacion, bodega_ubicacion.idbodega
union
SELECT isnull(dbo.bodega_area.Descripcion,'ND') Area,
       dbo.bodega_ubicacion.IdUbicacion, 
       dbo.bodega.nombre as Tipo, 
	   max(ISNULL(dbo.stock.IdStock, 0)) AS IdStock,
       dbo.Nombre_Completo_Ubicacion(bodega_ubicacion.IdUbicacion, bodega_ubicacion.idbodega) Ubicacion
FROM   dbo.stock INNER JOIN dbo.producto_bodega ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega AND
	   dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega RIGHT OUTER JOIN 
	   dbo.bodega INNER JOIN
	   dbo.bodega_area ON dbo.bodega.IdBodega = dbo.bodega_area.IdBodega INNER JOIN
	   dbo.bodega_sector ON dbo.bodega_area.IdArea = dbo.bodega_sector.IdArea AND 
       dbo.bodega_area.IdBodega = dbo.bodega_sector.IdBodega INNER JOIN
	   dbo.bodega_tramo ON dbo.bodega_sector.IdSector = dbo.bodega_tramo.IdSector AND 
	   dbo.bodega_sector.IdBodega = dbo.bodega_tramo.IdBodega INNER JOIN
	   dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND 
	   dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
	   dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
	   dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion AND dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega
where dbo.stock.IdBodega = 2 and ISNULL(dbo.stock.IdStock, 0)>0
group by isnull(dbo.bodega_area.Descripcion,'ND'),
       dbo.bodega_ubicacion.IdUbicacion, 
       dbo.bodega.nombre, 
       bodega_ubicacion.IdUbicacion, bodega_ubicacion.idbodega
union
SELECT isnull(dbo.bodega_area.Descripcion,'ND') Area,
       dbo.bodega_ubicacion.IdUbicacion, 
       'N/D' as Tipo, 
	   ISNULL(dbo.stock.IdStock, 0) AS IdStock,
       dbo.Nombre_Completo_Ubicacion(bodega_ubicacion.IdUbicacion, bodega_ubicacion.idbodega) Ubicacion
FROM   dbo.stock INNER JOIN dbo.producto_bodega ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega AND
	   dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega RIGHT OUTER JOIN 
	   dbo.bodega INNER JOIN
	   dbo.bodega_area ON dbo.bodega.IdBodega = dbo.bodega_area.IdBodega INNER JOIN
	   dbo.bodega_sector ON dbo.bodega_area.IdArea = dbo.bodega_sector.IdArea AND 
       dbo.bodega_area.IdBodega = dbo.bodega_sector.IdBodega INNER JOIN
	   dbo.bodega_tramo ON dbo.bodega_sector.IdSector = dbo.bodega_tramo.IdSector AND 
	   dbo.bodega_sector.IdBodega = dbo.bodega_tramo.IdBodega INNER JOIN
	   dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND 
	   dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
	   dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
	   dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion AND dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega
where ISNULL(dbo.stock.IdStock, 0)=0 and bodega_ubicacion.IdUbicacion not in (
SELECT IdUbicacion
FROM   dbo.stock 
where dbo.stock.IdBodega = 1 and ISNULL(dbo.stock.IdStock, 0)>0
union
SELECT IdUbicacion
FROM   dbo.stock 
where dbo.stock.IdBodega = 2 and ISNULL(dbo.stock.IdStock, 0)>0)
