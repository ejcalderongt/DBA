create View VW_Stock_res_jornada_merca as

SELECT        IdBodega, IdStock, IdPropietarioBodega, IdPropietario, Fecha, fecha_ingreso, fecha_ingreso_ticket_tms, activo, Regimen, Proveedor AS razon_social, Propietario AS nombre_comercial, IdClasificacion, Clasificacion, 
                         codigo_producto, nombre_producto, cantidad, existencia, IdPresentacion, no_poliza, valor_aduana, valor_fob, valor_iva, valor_dai, valor_seguro, valor_flete, es_retroactivo
FROM            dbo.stock_jornada AS vw
WHERE        (activo = 1)



/******** GT 07102021 Se asocia con tabla bodega para conversion del tipo bodega *******************************/

ALTER VIEW [dbo].[VW_Stock_res_jornada_merca]
AS
SELECT        vw.IdBodega, dbo.bodega.codigo_barra, vw.IdStock, vw.IdPropietarioBodega, vw.IdPropietario, vw.Fecha, vw.fecha_ingreso, vw.fecha_ingreso_ticket_tms, vw.activo, vw.Regimen, vw.Proveedor AS razon_social, 
                         vw.Propietario AS nombre_comercial, vw.IdClasificacion, vw.Clasificacion, vw.codigo_producto, vw.nombre_producto, vw.cantidad, vw.existencia, vw.IdPresentacion, vw.no_poliza, vw.valor_aduana, vw.valor_fob, vw.valor_iva, 
                         vw.valor_dai, vw.valor_seguro, vw.valor_flete, vw.es_retroactivo
FROM            dbo.stock_jornada AS vw INNER JOIN
                         dbo.bodega ON vw.IdBodega = dbo.bodega.IdBodega
WHERE        (vw.activo = 1)
GO

/************* EJC07102021 Query de cÃ³digo a vista  **************************/

Alter view VW_Stock_res_jornada as
select codigo_barra as codigobodega,
'3' codigomercaderia,
'' certificadodeposito,
'' bonoprenda,
round(sum(valor_aduana),2) as saldosincertificado, 
CAST(CAST(CAST(convert(nvarchar(50),floor(round(sum(valor_aduana),2))) AS FLOAT) AS NUMERIC) AS NVARCHAR)
 + '' + RIGHT('00' + REPLACE(round(sum(valor_aduana)- floor(round(sum(valor_aduana),2)),2),'.',''),2) as saldo_sin_certificado_fromat,

'' saldocertificado,''saldobono,'' nombreacreedor,nombre_producto descripcionmercaderia,'' fechaemisioncertificado,
'' fechavencimientocertificado,'' fechaemisionbono,'' fechavencimientobono,
FORMAT (fecha_ingreso_ticket_tms, 'ddMMyyyy') fechaemisionds,FORMAT (DATEADD(year, 1, fecha_ingreso_ticket_tms), 'ddMMyyyy') fechavencimientods,
valor_fob+valor_flete+valor_seguro as cif,
case Regimen when 'Fiscal' then valor_dai + valor_iva else 0 end  impuestos,
'' seguros,'' seguros2,'' primerapellido,'' segundoapellido,'' apellidocasada,'' primernombre,'' segundonombre,
'' tercernombre, Proveedor as razon_social,nombre_comercial nombrecomercial, '>' terminacion 
from   dbo.stock_jornada INNER JOIN
dbo.bodega ON stock_jornada.IdBodega = dbo.bodega.IdBodega 
where stock_jornada.activo =1
group by Regimen,nombre_producto,fecha_ingreso_ticket_tms,nombre_comercial,
valor_fob,valor_flete,valor_seguro,valor_dai,valor_iva,codigo_barra,Proveedor
GO

