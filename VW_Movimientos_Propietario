/******#GT17012023 vista para reporte Movimientos por Doc CEALSA Object:  View [dbo].[VW_Movimientos_Propietario]    Script Date: 17/01/2023 21:17:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[VW_Movimientos_Propietario] as
select 
trans_despacho_enc.IdBodega,
trans_despacho_enc.IdPropietarioBodega,
trans_despacho_enc.fecha,
trans_despacho_enc.observacion,
oc.Referencia,
oc_pol.codigo_poliza as poliza,
oc_pol.numero_orden,
trans_despacho_enc.activo,
trans_despacho_det.IdDespachoDet,
trans_despacho_det.Codigo,
pr.codigo_barra,
trans_despacho_det.NombreProducto as producto,
prb.IdProductoBodega,
trans_despacho_det.CantidadDespachada as cantidad,
trans_despacho_det.Fecha fecha_salida,
trans_picking_ubic.lic_plate as licencia
,re_det.cantidad_recibida saldo_inicial,
tarea.IdTipoTarea,
tarea.Nombre as TipoTarea,
tarea.Contabilizar,
trans_picking_ubic.IdPresentacion,pres.factor,pres.nombre as presentacion,
oc_det.valor_aduana,oc_det.valor_dai,oc_det.valor_iva,
re_det.IdRecepcionDet,
cast(re_det.fecha_ingreso as date) fecha_ingreso_rec,cast(tms.Fecha_Ingreso as date)fecha_ingreso_ticket,
case when oc.no_ticket_tms ='' then null
else oc.no_ticket_tms
end no_ticket_tms,
trans_despacho_det.IdPedidoEnc,
trans_despacho_enc.IdDespachoEnc,
pe_pol.numero_orden numero_orden_salida,pe_pol.codigo_poliza codigo_poliza_salida,
trans_picking_ubic.IdStock
from trans_despacho_enc  inner join  
     trans_despacho_det on trans_despacho_enc.IdDespachoEnc = trans_despacho_det.IdDespachoEnc inner join 
     trans_picking_ubic on trans_despacho_det.IdPedidoDet = trans_picking_ubic.IdPedidoDet inner join 
     producto pr on trans_despacho_det.Codigo = pr.codigo inner join 
     producto_bodega prb on prb.IdProducto = pr.IdProducto and prb.IdBodega= trans_despacho_enc.IdBodega left outer join 
     producto_presentacion pres on pr.IdProducto =pres.IdProducto
                               and trans_picking_ubic.IdPresentacion = pres.IdPresentacion inner join 
    trans_pe_det pe_det on trans_despacho_det.IdPedidoEnc = pe_det.IdPedidoEnc
                        and trans_despacho_det.IdPedidoDet = pe_det.IdPedidoDet 
    /*inner join i_nav_transacciones_out on i_nav_transacciones_out.iddespachoenc = trans_despacho_enc.IdDespachoEnc
                            and i_nav_transacciones_out.idpedidoenc = trans_despacho_det.IdPedidoEnc*/
                             inner join trans_re_det re_det on trans_picking_ubic.IdRecepcion= re_det.IdRecepcionEnc
                                                          and trans_picking_ubic.lic_plate = re_det.lic_plate 
                           inner join trans_oc_enc oc on re_det.IdOrdenCompraEnc = oc.IdOrdenCompraEnc
                           inner join trans_oc_det oc_det on re_det.IdOrdenCompraEnc=oc_det.IdOrdenCompraEnc
                                                           and re_det.IdOrdenCompraDet=oc_det.IdOrdenCompraDet
                           left outer join trans_oc_pol oc_pol on oc.IdOrdenCompraEnc= oc_pol.IdOrdenCompraEnc
                           inner join trans_movimientos mov on trans_picking_ubic.lic_plate collate SQL_Latin1_General_CP1_CI_AS = mov.barra_pallet
                                                            and trans_despacho_enc.IdDespachoEnc = mov.IdTransaccion
                                                            and mov.IdTipoTarea = 5
                            inner join sis_tipo_tarea tarea on mov.IdTipoTarea = tarea.IdTipoTarea
							left outer join tms_ticket tms on oc.no_ticket_tms = tms.IdTicket
							left outer join trans_pe_pol pe_pol on trans_despacho_det.IdPedidoEnc=pe_pol.IdOrdenPedidoEnc
							
------trans_picking_ubic.lic_plate = '445851' and 
--trans_despacho_enc.IdPropietarioBodega=2082 and 
--trans_despacho_enc.IdBodega=2 and cast(trans_despacho_enc.Fecha as date) between '20220102' and '20230109' and trans_picking_ubic.lic_plate='EF00487'
---- and re_det.lic_plate = '445851'
GO




/**** GT06022023: se ajusta aduana, fob y dai segÃºn la cantidad despachada.



/****** Object:  View [dbo].[VW_Movimientos_Propietario]    Script Date: 06/02/2023 9:30:40 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER view [dbo].[VW_Movimientos_Propietario] as

SELECT					m.IdTransaccion,stt.Nombre AS TipoTarea,
						nav.idpedidoenc,nav.iddespachoenc,nav.IdDespachoDet,
						despacho_enc.activo,
						despacho_enc.observacion,
						isnull(enc.ticket,0) AS no_ticket_tms,
						enc.codigo_poliza as poliza,
					    enc.numero_orden,
						oc_enc.Referencia referencia,
						m.IdRecepcion,
						--re_det.idrecepcionenc,
						--re_det.IdRecepcionDet,
						CASE
							WHEN oc_det.valor_aduana >0 THEN oc_det.valor_aduana/m.cantidad
												ELSE 0
						END AS valor_aduana,
						CASE
							WHEN oc_det.valor_dai >0 THEN oc_det.valor_dai/m.cantidad
												ELSE 0
						END AS valor_dai,
						CASE
							WHEN oc_det.valor_iva >0 THEN oc_det.valor_iva/m.cantidad
												ELSE 0
						END AS valor_iva,
						--oc_det.valor_aduana,oc_det.valor_dai,oc_det.valor_iva,
						pr.nombre_comercial AS Propietario, p.nombre AS Producto,
						pp.nombre AS presentacion, 
						--pe1.nombre AS EstadoOrigen, pe2.nombre AS EstadoDestino, 
						u.Nombre AS UMBas, 
						 m.cantidad,
						 --m.peso,
                         --m.lote, 
						 --dbo.Nombre_Completo_Ubicacion(u1.IdUbicacion, u1.IdBodega) AS UbicOrigen, dbo.Nombre_Completo_Ubicacion(u2.IdUbicacion, u2.IdBodega) AS UbicDestino,  
						 m.fecha, p.IdProducto, p.codigo,
                         p.codigo_barra AS codigo_barra, stt.IdTipoTarea, stt.Contabilizar, m.fecha_vence, 
						 --pr.IdTipoActualizacionCosto, 
						 m.IdPresentacion, m.IdUnidadMedida, 
						 --m.IdEstadoOrigen, m.IdProductoBodega, 
						 prb.IdPropietarioBodega,
                         prb.IdBodega, m.barra_pallet licencia, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_familia.nombre AS Familia, 
						 --m.IdBodegaOrigen, m.IdBodegaDestino, bodega_1.codigo AS Codigo_Bodega_Destino,
                         --bodega_1.nombre AS Nombre_Bodega_Destino, 
						 m.IdMovimiento, dbo.bodega.codigo AS Codigo_Bodega_Origen, dbo.bodega.nombre AS Nombre_Bodega_Origen, dbo.Nombre_Area(u1.IdArea, m.IdBodegaOrigen)
                         AS NombreArea, pp.factor,
						 cast(re_det.fecha_ingreso as date) fecha_ingreso_rec,cast(tms.Fecha_Ingreso as date)fecha_ingreso_ticket,
						 pe_pol.numero_orden numero_orden_salida,pe_pol.codigo_poliza codigo_poliza_salida
			
FROM            dbo.trans_movimientos AS m LEFT OUTER JOIN
                         dbo.propietario_bodega AS prb ON m.IdPropietarioBodega = prb.IdPropietarioBodega INNER JOIN
                         dbo.propietarios AS pr ON prb.IdPropietario = pr.IdPropietario LEFT OUTER JOIN
                         dbo.producto_bodega AS pb ON m.IdProductoBodega = pb.IdProductoBodega INNER JOIN
                         dbo.producto AS p ON pb.IdProducto = p.IdProducto LEFT OUTER JOIN
                         dbo.producto_clasificacion ON p.IdClasificacion = dbo.producto_clasificacion.IdClasificacion LEFT OUTER JOIN
                         dbo.producto_familia ON p.IdFamilia = dbo.producto_familia.IdFamilia LEFT OUTER JOIN
                         dbo.bodega ON m.IdBodegaOrigen = dbo.bodega.IdBodega AND m.IdEmpresa = dbo.bodega.IdEmpresa LEFT OUTER JOIN
                         dbo.bodega AS bodega_1 ON m.IdEmpresa = bodega_1.IdEmpresa AND m.IdBodegaDestino = bodega_1.IdBodega LEFT OUTER JOIN
                         dbo.bodega_ubicacion AS u2 ON m.IdUbicacionDestino = u2.IdUbicacion AND u2.IdBodega = m.IdBodegaDestino LEFT OUTER JOIN
                         dbo.bodega_ubicacion AS u1 ON m.IdUbicacionOrigen = u1.IdUbicacion AND u1.IdBodega = m.IdBodegaOrigen LEFT OUTER JOIN
                         dbo.producto_presentacion AS pp ON m.IdPresentacion = pp.IdPresentacion LEFT OUTER JOIN
                         dbo.producto_estado AS pe1 ON m.IdEstadoOrigen = pe1.IdEstado LEFT OUTER JOIN
                         dbo.producto_estado AS pe2 ON m.IdEstadoDestino = pe2.IdEstado LEFT OUTER JOIN
                         dbo.unidad_medida AS u ON m.IdUnidadMedida = u.IdUnidadMedida LEFT OUTER JOIN
                         dbo.sis_tipo_tarea AS stt ON m.IdTipoTarea = stt.IdTipoTarea LEFT OUTER JOIN
                         dbo.trans_re_oc AS re ON m.IdRecepcion = re.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_oc_pol AS enc ON re.IdOrdenCompraEnc = enc.IdOrdenCompraEnc 
						 LEFT OUTER JOIN
						 i_nav_transacciones_out nav on nav.iddespachoenc= m.IdTransaccion 
														and m.IdTipoTarea=5 and nav.lic_plate=m.barra_pallet collate Modern_Spanish_CI_AS
						 LEFT OUTER JOIN dbo.trans_despacho_enc despacho_enc on nav.iddespachoenc = despacho_enc.IdDespachoEnc
						 INNER JOIN trans_re_det re_det on m.IdRecepcion = re_det.IdRecepcionEnc and re_det.lic_plate= m.barra_pallet collate Modern_Spanish_CI_AS
						 LEFT OUTER JOIN  trans_pe_pol pe_pol on pe_pol.IdOrdenPedidoEnc=nav.idpedidoenc 								
						 INNER JOIN dbo.trans_oc_det  oc_det on re_det.IdOrdenCompraEnc = oc_det.IdOrdenCompraEnc
															 and re_det.IdOrdenCompraDet = oc_det.IdOrdenCompraDet
						 INNER JOIN dbo.trans_oc_enc oc_enc on oc_det.IdOrdenCompraEnc = oc_enc.IdOrdenCompraEnc
						 LEFT OUTER JOIN dbo.tms_ticket tms on oc_enc.no_ticket_tms = tms.IdTicket


GO


/****************#GT10022023: se distribuye el valor aduana dentro del total de la OC, y luego se multiplica por la cantidad recibida/despachada.


ALTER view [dbo].[VW_Movimientos_Propietario] as
SELECT					m.IdTransaccion,stt.Nombre AS TipoTarea,
						nav.idpedidoenc,nav.iddespachoenc,nav.IdDespachoDet,
						despacho_enc.activo,
						despacho_enc.observacion,
						isnull(enc.ticket,0) AS no_ticket_tms,
						enc.codigo_poliza as poliza,
					    enc.numero_orden,
						oc_enc.Referencia referencia,
						m.IdRecepcion,
						--re_det.idrecepcionenc,
						--re_det.IdRecepcionDet,
						CASE
							WHEN oc_det.valor_aduana >0 THEN 
							(oc_det.valor_aduana/oc_det.cantidad)*m.cantidad

												ELSE 0
						END AS valor_aduana,
						CASE
							WHEN oc_det.valor_dai >0 THEN 
							(oc_det.valor_dai/oc_det.cantidad)*m.cantidad
												ELSE 0
						END AS valor_dai,
						CASE
							WHEN oc_det.valor_iva >0 THEN 
							(oc_det.valor_iva/oc_det.cantidad)*m.cantidad
												ELSE 0
						END AS valor_iva,
						--oc_det.valor_aduana,oc_det.valor_dai,oc_det.valor_iva,
						pr.nombre_comercial AS Propietario, p.nombre AS Producto,
						pp.nombre AS presentacion, 
						--pe1.nombre AS EstadoOrigen, pe2.nombre AS EstadoDestino, 
						u.Nombre AS UMBas, 
						 m.cantidad,
						 --m.peso,
                         --m.lote, 
						 --dbo.Nombre_Completo_Ubicacion(u1.IdUbicacion, u1.IdBodega) AS UbicOrigen, dbo.Nombre_Completo_Ubicacion(u2.IdUbicacion, u2.IdBodega) AS UbicDestino,  
						 m.fecha, p.IdProducto, p.codigo,
                         p.codigo_barra AS codigo_barra, stt.IdTipoTarea, stt.Contabilizar, m.fecha_vence, 
						 --pr.IdTipoActualizacionCosto, 
						 m.IdPresentacion, m.IdUnidadMedida, 
						 --m.IdEstadoOrigen, m.IdProductoBodega, 
						 prb.IdPropietarioBodega,
                         prb.IdBodega, m.barra_pallet licencia, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_familia.nombre AS Familia, 
						 --m.IdBodegaOrigen, m.IdBodegaDestino, bodega_1.codigo AS Codigo_Bodega_Destino,
                         --bodega_1.nombre AS Nombre_Bodega_Destino, 
						 m.IdMovimiento, dbo.bodega.codigo AS Codigo_Bodega_Origen, dbo.bodega.nombre AS Nombre_Bodega_Origen, dbo.Nombre_Area(u1.IdArea, m.IdBodegaOrigen)
                         AS NombreArea, pp.factor,
						 cast(re_det.fecha_ingreso as date) fecha_ingreso_rec,cast(tms.Fecha_Ingreso as date)fecha_ingreso_ticket,
						 pe_pol.numero_orden numero_orden_salida,pe_pol.codigo_poliza codigo_poliza_salida
			
FROM            dbo.trans_movimientos AS m LEFT OUTER JOIN
                         dbo.propietario_bodega AS prb ON m.IdPropietarioBodega = prb.IdPropietarioBodega INNER JOIN
                         dbo.propietarios AS pr ON prb.IdPropietario = pr.IdPropietario LEFT OUTER JOIN
                         dbo.producto_bodega AS pb ON m.IdProductoBodega = pb.IdProductoBodega INNER JOIN
                         dbo.producto AS p ON pb.IdProducto = p.IdProducto LEFT OUTER JOIN
                         dbo.producto_clasificacion ON p.IdClasificacion = dbo.producto_clasificacion.IdClasificacion LEFT OUTER JOIN
                         dbo.producto_familia ON p.IdFamilia = dbo.producto_familia.IdFamilia LEFT OUTER JOIN
                         dbo.bodega ON m.IdBodegaOrigen = dbo.bodega.IdBodega AND m.IdEmpresa = dbo.bodega.IdEmpresa LEFT OUTER JOIN
                         dbo.bodega AS bodega_1 ON m.IdEmpresa = bodega_1.IdEmpresa AND m.IdBodegaDestino = bodega_1.IdBodega LEFT OUTER JOIN
                         dbo.bodega_ubicacion AS u2 ON m.IdUbicacionDestino = u2.IdUbicacion AND u2.IdBodega = m.IdBodegaDestino LEFT OUTER JOIN
                         dbo.bodega_ubicacion AS u1 ON m.IdUbicacionOrigen = u1.IdUbicacion AND u1.IdBodega = m.IdBodegaOrigen LEFT OUTER JOIN
                         dbo.producto_presentacion AS pp ON m.IdPresentacion = pp.IdPresentacion LEFT OUTER JOIN
                         dbo.producto_estado AS pe1 ON m.IdEstadoOrigen = pe1.IdEstado LEFT OUTER JOIN
                         dbo.producto_estado AS pe2 ON m.IdEstadoDestino = pe2.IdEstado LEFT OUTER JOIN
                         dbo.unidad_medida AS u ON m.IdUnidadMedida = u.IdUnidadMedida LEFT OUTER JOIN
                         dbo.sis_tipo_tarea AS stt ON m.IdTipoTarea = stt.IdTipoTarea LEFT OUTER JOIN
                         dbo.trans_re_oc AS re ON m.IdRecepcion = re.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_oc_pol AS enc ON re.IdOrdenCompraEnc = enc.IdOrdenCompraEnc 
						 LEFT OUTER JOIN
						 i_nav_transacciones_out nav on nav.iddespachoenc= m.IdTransaccion 
														and m.IdTipoTarea=5 and nav.lic_plate=m.barra_pallet collate Modern_Spanish_CI_AS
						 LEFT OUTER JOIN dbo.trans_despacho_enc despacho_enc on nav.iddespachoenc = despacho_enc.IdDespachoEnc
						 INNER JOIN trans_re_det re_det on m.IdRecepcion = re_det.IdRecepcionEnc and re_det.lic_plate= m.barra_pallet collate Modern_Spanish_CI_AS
						 LEFT OUTER JOIN  trans_pe_pol pe_pol on pe_pol.IdOrdenPedidoEnc=nav.idpedidoenc 								
						 INNER JOIN dbo.trans_oc_det  oc_det on re_det.IdOrdenCompraEnc = oc_det.IdOrdenCompraEnc
															 and re_det.IdOrdenCompraDet = oc_det.IdOrdenCompraDet
						 INNER JOIN dbo.trans_oc_enc oc_enc on oc_det.IdOrdenCompraEnc = oc_enc.IdOrdenCompraEnc
						 LEFT OUTER JOIN dbo.tms_ticket tms on oc_enc.no_ticket_tms = tms.IdTicket
						
GO









