SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:        Carolina Fuentes
-- Create date:   06-09-2022
-- Description:   Obtener los registros que no existen en Stock Jornada
-- =============================================
CREATE PROCEDURE SP_STOCK_JORNADA_DESFASE
    -- Add the parameters for the stored procedure here
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON;



   IF EXISTS (SELECT * FROM sys.objects WHERE name = 'stock_jornada_consecutivo' AND type = 'U') DROP TABLE stock_jornada_consecutivo
    IF EXISTS (SELECT * FROM sys.objects WHERE name = 'stock_jornada_desface' AND type = 'U') DROP TABLE stock_jornada_desface



   select ROW_NUMBER() OVER(PARTITION BY lic_plate ORDER BY fecha ASC)  AS consecutivo, lic_plate, fecha, IdStock, IdJornadaSistema, IdBodega, IdTicketTMS
    into  stock_jornada_consecutivo
    from stock_jornada order by lic_plate,Fecha



   select *, DATEADD(day, consecutivo-1,
     (select Min(fecha) from stock_jornada_consecutivo s where  s.lic_plate = stock_jornada_consecutivo.lic_plate)) as fecha_consecutiva,
     (select Min(fecha) from stock_jornada_consecutivo s where  s.lic_plate = stock_jornada_consecutivo.lic_plate) as min_fecha,
     (select Max(fecha) from stock_jornada_consecutivo s where  s.lic_plate = stock_jornada_consecutivo.lic_plate) as max_fecha
    into  stock_jornada_desface
    from stock_jornada_consecutivo
    where datediff(day,DATEADD(day, consecutivo-1, fecha), fecha)<>0
    order by lic_plate, consecutivo, fecha
END
GO


select df.* from stock_jornada_desface df
where not exists (select * from stock_jornada d WHERE d.lic_plate = df.lic_plate and d.fecha = df.fecha_consecutiva)
and df.max_fecha >=df.fecha_consecutiva
order by lic_plate, fecha_consecutiva
