/****** Object:  StoredProcedure [dbo].[SP_STOCK_JORNADA_DESFASE]    Script Date: 7/09/2022 08:04:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:        Carolina Fuentes
-- Create date:   06-09-2022
-- Description:   Obtener los registros que no existen en Stock Jornada
-- =============================================
ALTER PROCEDURE [dbo].[SP_STOCK_JORNADA_DESFASE]

-- Add the parameters for the stored procedure here
AS

DECLARE @RegistosARevisar AS INT

BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.

   IF EXISTS (SELECT * FROM sys.objects WHERE name = 'stock_jornada_consecutivo' AND type = 'U') DROP TABLE stock_jornada_consecutivo
   IF EXISTS (SELECT * FROM sys.objects WHERE name = 'stock_jornada_desface' AND type = 'U') DROP TABLE stock_jornada_desface

  SELECT ROW_NUMBER() OVER(PARTITION BY LIC_PLATE ORDER BY FECHA ASC)  AS CONSECUTIVO, LIC_PLATE, FECHA, IDSTOCK, IDJORNADASISTEMA, IDBODEGA, IDTICKETTMS
   INTO  STOCK_JORNADA_CONSECUTIVO
   FROM STOCK_JORNADA ORDER BY LIC_PLATE,FECHA

  SELECT *, DATEADD(DAY, CONSECUTIVO-1,
   (SELECT MIN(FECHA) FROM STOCK_JORNADA_CONSECUTIVO S WHERE  S.LIC_PLATE = STOCK_JORNADA_CONSECUTIVO.LIC_PLATE)) AS FECHA_CONSECUTIVA,
   (SELECT MIN(FECHA) FROM STOCK_JORNADA_CONSECUTIVO S WHERE  S.LIC_PLATE = STOCK_JORNADA_CONSECUTIVO.LIC_PLATE) AS MIN_FECHA,
   (SELECT MAX(FECHA) FROM STOCK_JORNADA_CONSECUTIVO S WHERE  S.LIC_PLATE = STOCK_JORNADA_CONSECUTIVO.LIC_PLATE) AS MAX_FECHA
    INTO  STOCK_JORNADA_DESFACE
    FROM STOCK_JORNADA_CONSECUTIVO
    WHERE DATEDIFF(DAY,DATEADD(DAY, CONSECUTIVO-1, FECHA), FECHA)<>0
    ORDER BY LIC_PLATE, CONSECUTIVO, FECHA

   SELECT @RegistosARevisar=(SELECT COUNT(*) FROM STOCK_JORNADA_CONSECUTIVO)

   RETURN @RegistosARevisar

COMMIT

END

GO


select df.* from stock_jornada_desface df
where not exists (select * from stock_jornada d WHERE d.lic_plate = df.lic_plate and d.fecha = df.fecha_consecutiva)
and df.max_fecha >=df.fecha_consecutiva
order by lic_plate, fecha_consecutiva
