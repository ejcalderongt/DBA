/******#CKFK 29-05-24 11:57 PM Se agregaron campos ,trans_oc_enc.Referencia,trans_re_oc.No_Docto, dbo.trans_re_enc.No_Contenedor ******/
ALTER VIEW [dbo].[VW_Stock_Res]
AS

SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet,ISNULL(trans_oc_ti.Nombre,'ND') Ingreso, ISNULL(trans_oc_ti.es_devolucion,0) es_devolucion,
		  ISNULL(trans_re_det.No_Linea,0) No_Linea, ISNULL(bodega_ubicacion.IdArea,0) IdArea,trans_oc_enc.Referencia,trans_re_oc.No_Docto, dbo.trans_re_enc.No_Contenedor
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  LEFT outer join trans_oc_ti on dbo.trans_oc_enc.IdTipoIngresoOC = trans_oc_ti.IdTipoIngresoOC
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet,trans_oc_ti.Nombre, trans_oc_ti.es_devolucion,trans_re_det.No_Linea, bodega_ubicacion.IdArea,trans_oc_enc.Referencia,trans_re_oc.No_Docto, dbo.trans_re_enc.No_Contenedor
GO

/******#CKFK 19-Apr-24 11:26:56 PM Se agrega campo IdArea ******/
ALTER VIEW [dbo].[VW_Stock_Res]
AS

SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet,ISNULL(trans_oc_ti.Nombre,'ND') Ingreso, ISNULL(trans_oc_ti.es_devolucion,0) es_devolucion,
				  ISNULL(trans_re_det.No_Linea,0) No_Linea, ISNULL(bodega_ubicacion.IdArea,0) IdArea,Referencia,No_Docto
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  LEFT outer join trans_oc_ti on dbo.trans_oc_enc.IdTipoIngresoOC = trans_oc_ti.IdTipoIngresoOC
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet,trans_oc_ti.Nombre, trans_oc_ti.es_devolucion,trans_re_det.No_Linea, bodega_ubicacion.IdArea
GO

/--#GT12032024: se agerga el no_linea de la recepcion para saber de que linea despachar en fiscal
----------- tomar en cuenta antes de ejecutar si entra en conflicto con la versión DEMO PARA RESERVA.
/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 12/03/2024 11:32:36 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.stock.idbodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet, dbo.trans_oc_ti.Nombre AS Ingreso, dbo.trans_oc_ti.es_devolucion, 
                  dbo.trans_re_det.No_Linea
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.idbodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.idbodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket INNER JOIN
                  dbo.trans_oc_ti ON dbo.trans_oc_enc.IdTipoIngresoOC = dbo.trans_oc_ti.IdTipoIngresoOC
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.idbodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet, dbo.trans_oc_ti.Nombre, dbo.trans_oc_ti.es_devolucion, dbo.trans_re_det.No_Linea
GO

-----------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------


/#EJC202307100930 VERSION DEMO PARA RESERVA, NO USAR AÚN ******/
/#EJC Script Date: 12/09/2023 04:44:52 AGREGUE Estado_Reserva ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet,ISNULL(trans_oc_ti.Nombre,'ND') Ingreso, ISNULL(trans_oc_ti.es_devolucion,0) es_devolucion,
				  stock_res.estado 'Estado_Reserva'
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  LEFT outer join trans_oc_ti on dbo.trans_oc_enc.IdTipoIngresoOC = trans_oc_ti.IdTipoIngresoOC
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet,trans_oc_ti.Nombre, trans_oc_ti.es_devolucion,stock_res.estado 
GO




/#EJC202307100930 Agruegué los campos IdPickingEnc, IdPedidoEnc, IdPedidoDet ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet, ISNULL(dbo.trans_oc_ti.Nombre, 'ND') AS Ingreso, 
                  ISNULL(dbo.trans_oc_ti.es_devolucion, 0) AS es_devolucion, dbo.stock.IdPedidoEnc, dbo.stock.IdPickingEnc, dbo.stock.IdDespachoEnc, dbo.stock.IdPickingUbicStock, dbo.stock.IdPickingUbic, dbo.stock.IdPedidoDet
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket LEFT OUTER JOIN
                  dbo.trans_oc_ti ON dbo.trans_oc_enc.IdTipoIngresoOC = dbo.trans_oc_ti.IdTipoIngresoOC
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet, dbo.trans_oc_ti.Nombre, dbo.trans_oc_ti.es_devolucion, dbo.stock.IdPedidoEnc, dbo.stock.IdPickingEnc, dbo.stock.IdDespachoEnc, dbo.stock.IdPickingUbicStock, dbo.stock.IdPickingUbic, dbo.stock.IdPedidoDet
GO


--#CKFK20230626 Tuve que quitar campos para diferenciar al stock asociado a un picking y pedido y el inner join con la trans_oc_ti lo cambie por un left outer join
--porque en Idealsa se hacen recepciones ciegas.
/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 26/06/2023 11:54:38 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet,ISNULL(trans_oc_ti.Nombre,'ND') Ingreso, ISNULL(trans_oc_ti.es_devolucion,0) es_devolucion
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  LEFT outer join trans_oc_ti on dbo.trans_oc_enc.IdTipoIngresoOC = trans_oc_ti.IdTipoIngresoOC
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet,trans_oc_ti.Nombre, trans_oc_ti.es_devolucion
GO

--#GT12062023 campos para diferenciar al stock asociado a un picking y pedido

/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 12/06/2023 23:54:15 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet
				  ,trans_oc_ti.Nombre Ingreso, trans_oc_ti.es_devolucion
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  inner join trans_oc_ti on dbo.trans_oc_enc.IdTipoIngresoOC = trans_oc_ti.IdTipoIngresoOC
WHERE dbo.stock.IdPedidoEnc IS NULL AND dbo.stock.IdPickingEnc IS NULL
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet,trans_oc_ti.Nombre, trans_oc_ti.es_devolucion
GO






--GT24052023 se agregan campos del tipo ingreso y si es tipo devolución--

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet
				  ,trans_oc_ti.Nombre Ingreso, trans_oc_ti.es_devolucion
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  inner join trans_oc_ti on dbo.trans_oc_enc.IdTipoIngresoOC = trans_oc_ti.IdTipoIngresoOC
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet,trans_oc_ti.Nombre, trans_oc_ti.es_devolucion
GO





--#EJC202302212145: Agregué campo: IdRecepcionDet
/****** Object:  View [dbo].[VW_Stock_Res]  EJC ADD IdRecepcionDet  Script Date: 21/02/2023 14:01:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.stock.IdBodega, dbo.bodega.nombre AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.IdProducto, 
                  dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.producto.codigo, 
                  dbo.producto.codigo_barra, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                  dbo.stock.cantidad AS Cantidad_UMBas, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, dbo.producto_presentacion.factor, 
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) 
                  ELSE 0 END AS Cantidad_Reservada_Pres, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) 
                  - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, dbo.stock.peso, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, 
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, 
                  dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, 
                  dbo.producto.existencia_max AS Existencia_max_umbas, dbo.trans_oc_det.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                  dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
                  ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.NoPoliza AS NoTO, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, dbo.producto_parametro_a.IdProductoParametroA, 
                  dbo.producto_parametro_b.IdProductoParametroB, dbo.stock.atributo_variante_1, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, 
                  dbo.p_parametro.descripcion AS parametro_personalizado, CASE WHEN p_parametro.tipo = 'Númerico' THEN CAST(dbo.stock_parametro.valor_numerico AS nvarchar) 
                  WHEN p_parametro.tipo = 'Texto' THEN dbo.stock_parametro.valor_texto WHEN p_parametro.tipo = 'Fecha' THEN CONVERT(varchar, dbo.stock_parametro.valor_fecha, 101) 
                  WHEN p_parametro.tipo = 'Lógico' THEN CAST(dbo.stock_parametro.valor_logico AS nvarchar) END AS parametro_valor, dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto AS tipo, dbo.producto_marca.IdMarca, 
                  dbo.producto_marca.nombre AS marca, dbo.stock.cantidad, dbo.trans_oc_enc.IdOrdenCompraEnc AS doc_ingreso, ISNULL(dbo.stock_det.posiciones, 1) AS posiciones, 
                  CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END AS valor_unitario, CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  > 0 THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END END AS valor_total, ISNULL(dbo.trans_oc_det.IdEmbarcador, 0) AS IdEmbarcador, 
                  ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Shipper, dbo.bodega.nombre AS Regimen, ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' ' + CONVERT(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14), '') 
                  AS ingreso_ticket, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, MAX(dbo.stock_res.IdPedido) 
                  AS IdPedido, dbo.stock.pallet_no_estandar, ISNULL(dbo.trans_oc_embarcador.Nombre, 'N/D') AS Embarcador, ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, SUM(ISNULL(dbo.stock_res.cantidad, 0)) 
                  AS CantidadReservada, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.bodega_tramo.es_rack, ISNULL(dbo.trans_oc_enc.Referencia, '') AS ReferenciaOCEnc, 
                  dbo.producto.precio AS precio_producto, dbo.producto.costo AS costo_producto, dbo.trans_re_det.costo AS costo_ingreso, dbo.stock.IdRecepcionDet
FROM     dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON 
                  dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON 
                  dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON 
                  dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND 
                  dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.producto_marca ON dbo.producto.IdMarca = dbo.producto_marca.IdMarca AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto AND dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc ON dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_det ON dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet LEFT OUTER JOIN
                  dbo.trans_oc_det ON dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet AND dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador INNER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, 
                  dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, 
                  dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, 
                  dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, 
                  dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, 
                  dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, 
                  dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, dbo.producto_tipo.IdTipoProducto, dbo.producto_marca.IdMarca, dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto, 
                  dbo.bodega_ubicacion.activo, dbo.bodega_ubicacion.bloqueada, dbo.bodega_ubicacion.ubicacion_merma, dbo.trans_oc_enc.IdOrdenCompraEnc, dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, 
                  dbo.trans_oc_det.IdEmbarcador, dbo.trans_oc_embarcador.Nombre, dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack, dbo.producto.precio, dbo.producto.costo, dbo.trans_re_det.costo, 
                  dbo.stock.IdRecepcionDet
GO


--#EJC202211022145: Agregué campos, bodega_ubicacion.activo, bloqueada, ubicacion_merma
ALTER VIEW [dbo].[VW_Stock_Res] AS
SELECT     dbo.stock.IdBodega, 
		   dbo.bodega.nombre Bodega, 
           dbo.propietarios.IdPropietario, 
		   dbo.propietario_bodega.IdPropietarioBodega, 
		   dbo.propietarios.nombre_comercial AS Propietario,  
		   dbo.producto.IdProducto, 
		   dbo.producto_bodega.IdProductoBodega, 
		   dbo.stock.IdStock, 
		   dbo.stock.IdUbicacion_anterior, 
		   dbo.unidad_medida.IdUnidadMedida,
		   dbo.stock.IdProductoEstado, 
		   dbo.stock.IdPresentacion, 
		   dbo.stock.IdRecepcionEnc,
		   dbo.producto.codigo,
		   dbo.producto.codigo_barra,
		   dbo.producto.nombre, 
		   dbo.unidad_medida.Nombre AS UnidadMedida,
           dbo.producto_presentacion.nombre AS Presentacion, 
		   dbo.stock.lote, 
		   dbo.stock.fecha_ingreso, 
		   dbo.stock.fecha_vence, 
		   dbo.stock.cantidad AS Cantidad_UMBas, 
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, 
		   dbo.producto_presentacion.factor, 
		   SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, 
		   CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0))/ dbo.producto_presentacion.factor, 6) ELSE 0 END AS Cantidad_Reservada_Pres, 
		   dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, 
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, 
		   dbo.stock.peso, dbo.producto_estado.nombre AS NomEstado,
		   dbo.producto_estado.dañado, 
		   dbo.producto_estado.utilizable AS EstadoUtilizable, 
		   dbo.stock.IdUbicacion, 
		   dbo.stock.lic_plate,
           dbo.stock.serial, dbo.stock.añada, 
		   dbo.producto.IdIndiceRotacion, 
		   dbo.producto_presentacion.alto, 
		   dbo.producto_presentacion.largo, 
		   dbo.producto_presentacion.ancho, 
		   dbo.bodega_ubicacion.IdTramo, 
		   dbo.bodega_ubicacion.ancho AS Ancho_ubicacion,
           dbo.bodega_ubicacion.largo AS Largo_ubicacion, 
		   dbo.bodega_ubicacion.alto AS Alto_ubicacion, 
		   dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
		   dbo.producto.existencia_min AS Existencia_min_umbas, 
		   dbo.producto.existencia_max AS Existencia_max_umbas,
           dbo.trans_oc_det.costo, 
		   dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, 
		   dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
		   dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual,
           dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
		   dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, 
		   dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
		   dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, 
		   dbo.bodega_ubicacion.activo,
		   dbo.bodega_ubicacion.bloqueada,
		   dbo.bodega_ubicacion.ubicacion_merma,		   
		   ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
		   ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, 
		   ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, 
		   --numero_orden, 
		   dbo.producto_familia.nombre AS Familia, 
		   dbo.trans_oc_pol.NoPoliza AS NoTO, 
		   dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, 
		   dbo.producto_clasificacion.nombre AS Clasificacion, 
		   dbo.producto_parametro_a.IdProductoParametroA, 
		   dbo.producto_parametro_b.IdProductoParametroB, 
		   stock.atributo_variante_1,
           dbo.producto_parametro_a.Nombre AS parametro_a, 
		   dbo.producto_parametro_b.Nombre AS parametro_b,
           dbo.p_parametro.descripcion AS parametro_personalizado,
           case
            when p_parametro.tipo = 'Númerico' then dbo.stock_parametro.valor_numerico
            when p_parametro.tipo = 'Texto' then dbo.stock_parametro.valor_texto
            when p_parametro.tipo = 'Fecha' then  convert(varchar, dbo.stock_parametro.valor_fecha, 101)   
            when p_parametro.tipo = 'Lógico' then dbo.stock_parametro.valor_logico end as parametro_valor,
           dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto as tipo,
		   dbo.producto_marca.IdMarca,dbo.producto_marca.nombre as marca,
		   dbo.stock.cantidad,
		   dbo.trans_oc_enc.IdOrdenCompraEnc as doc_ingreso,
		   ISNULL(dbo.stock_det.posiciones, 1) posiciones,
		   CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END valor_unitario, 
		   CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN 
				CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) > 0 
			THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo 
						ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END 
			END valor_total,
			ISNULL(dbo.trans_oc_det.IdEmbarcador,'') IdEmbarcador, ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D') as Shipper,
			dbo.bodega.nombre as Regimen,
			ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' '  + convert(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14),'') as ingreso_ticket,
			dbo.bodega.IdEmpresa, 
			IdTipoEtiqueta, 
			ubicacion_picking, 
			dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
			MAX(dbo.stock_res.IdPedido) AS IdPedido, 
			dbo.stock.pallet_no_estandar,
			ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D')  Embarcador, 
			ISNULL(trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso,
			SUM(ISNULL(dbo.stock_res.cantidad, 0)) CantidadReservada,
			ISNULL(dbo.stock.cantidad, 0) AS CantidadSF,
			dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion,dbo.bodega_ubicacion.IdBodega) as Nombre_Completo,
			dbo.bodega_tramo.es_rack, 
          ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc
FROM        dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON
                  dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND
                  dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON
                  dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON
                  dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro
				  LEFT OUTER JOIN dbo.producto_marca on dbo.producto.IdMarca = dbo.producto_marca.IdMarca
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario
				  LEFT OUTER JOIN dbo.producto_tipo on dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario

				  LEFT OUTER JOIN dbo.stock_det on dbo.stock.IdStock = dbo.stock_det.IdStock
				 left outer join dbo.trans_re_enc on dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc
				 left outer join dbo.trans_re_det on dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc 
				 and dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepciondet
				 left outer join  dbo.trans_oc_det on dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet 
				 and dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc
				 
				 LEFT OUTER JOIN dbo.trans_oc_embarcador on dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador
				 INNER JOIN dbo.bodega on dbo.stock.IdBodega = dbo.bodega.IdBodega
				 LEFT OUTER JOIN dbo.tms_ticket on dbo.trans_oc_enc.no_ticket_tms= dbo.tms_ticket.IdTicket
				
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto_bodega.IdProductoBodega,
                  dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada,
                  dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso,
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo,
                  dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia,
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion,
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, dbo.trans_oc_enc.Referencia,
                  dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega,
                  p_parametro.descripcion,p_parametro.tipo,stock_parametro.valor_numerico,stock_parametro.valor_texto,stock_parametro.valor_fecha,stock_parametro.valor_logico,
				  dbo.producto_tipo.IdTipoProducto,dbo.producto_marca.IdMarca,
				  dbo.producto_marca.nombre,dbo.producto_tipo.NombreTipoProducto,
				  dbo.bodega_ubicacion.activo,
				  dbo.bodega_ubicacion.bloqueada,
				  dbo.bodega_ubicacion.ubicacion_merma,
				  dbo.trans_oc_enc.IdOrdenCompraEnc,dbo.stock_det.posiciones,
				  dbo.trans_oc_det.costo,
				  dbo.trans_oc_det.cantidad_recibida,
				  dbo.trans_oc_det.IdEmbarcador,dbo.trans_oc_embarcador.Nombre,
				  dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso
				  , dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta,
				  dbo.bodega_ubicacion.ubicacion_picking,  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
				  dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT        dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, 
                         dbo.stock.IdStock,dbo.stock.pallet_no_estandar,ISNULL(stock_det.posiciones,1) AS Posiciones ,dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, 
                         dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                         dbo.stock.cantidad AS CantidadSF, dbo.stock.peso, dbo.stock.cantidad / dbo.producto_presentacion.factor AS Cantidad, dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, 
                         dbo.producto_presentacion.factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, 
                         dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, dbo.bodega_ubicacion.IdTramo, 
                         dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
                         dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, 
                         dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, 
                         dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                         dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa
FROM            dbo.producto_estado INNER JOIN
                         dbo.unidad_medida INNER JOIN
                         dbo.propietarios INNER JOIN
                         dbo.stock INNER JOIN
                         dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                         dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                         dbo.bodega_tramo INNER JOIN
                         dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
                         dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_bodega INNER JOIN
                         dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                         dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                         dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                         dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                         dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion
						 LEFT OUTER JOIN stock_det ON stock.IdStock = stock_det.IdStock
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                         dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                         dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                         dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                         dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, 
                         dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, 
                         dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, 
                         dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, dbo.bodega.IdEmpresa,
						 stock_det.posiciones,dbo.stock.pallet_no_estandar
GO

--CKFK 20210716 Agregué el campo IdTipoEtiqueta
/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 16/07/2021 18:59:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT        dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, 
                         dbo.stock.IdStock,dbo.stock.pallet_no_estandar,ISNULL(stock_det.posiciones,1) AS Posiciones ,dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, 
                         dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, 
                         dbo.stock.cantidad AS CantidadSF, dbo.stock.peso, dbo.stock.cantidad / dbo.producto_presentacion.factor AS Cantidad, dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, 
                         dbo.producto_presentacion.factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, 
                         dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, dbo.bodega_ubicacion.IdTramo, 
                         dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
                         dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, 
                         dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, 
                         dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                         dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, producto.IdTipoEtiqueta
FROM            dbo.producto_estado INNER JOIN
                         dbo.unidad_medida INNER JOIN
                         dbo.propietarios INNER JOIN
                         dbo.stock INNER JOIN
                         dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                         dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                         dbo.bodega_tramo INNER JOIN
                         dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
                         dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_bodega INNER JOIN
                         dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                         dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                         dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                         dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                         dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion
						 LEFT OUTER JOIN stock_det ON stock.IdStock = stock_det.IdStock
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                         dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                         dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                         dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                         dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, 
                         dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, 
                         dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, 
                         dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, dbo.bodega.IdEmpresa,
						 stock_det.posiciones,dbo.stock.pallet_no_estandar, producto.IdTipoEtiqueta
GO


/**********************GT 23072021 campos numero_poliza, codigo_poliza y doc ingreso *****************************************/

Alter view VW_Stock_Res as
SELECT        dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, 
                         dbo.stock.IdStock, dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion,
                          dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, dbo.stock.cantidad AS CantidadSF, dbo.stock.peso, dbo.stock.cantidad / dbo.producto_presentacion.factor AS Cantidad, 
                         dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, dbo.producto_presentacion.factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, 
                         dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                         dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, 
                         dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, 
                         dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, 
                         dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                         dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta,
						 isnull(oc_pol.numero_orden,'ND')AS numero_orden,ISNULL(oc_pol.codigo_poliza,'ND')AS codigo_poliza,ISNULL(re_oc.IdOrdenCompraEnc,0) as Documento_Ingreso
FROM            dbo.producto_estado INNER JOIN
                         dbo.unidad_medida INNER JOIN
                         dbo.propietarios INNER JOIN
                         dbo.stock INNER JOIN
                         dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                         dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                         dbo.bodega_tramo INNER JOIN
                         dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
                         dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_bodega INNER JOIN
                         dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                         dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                         dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                         dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                         dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                         dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock
						 LEFT OUTER JOIN dbo.trans_re_enc as re_enc on re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc
						 LEFT OUTER JOIN dbo.trans_re_oc as re_oc on re_oc.IdRecepcionEnc=re_enc.IdRecepcionEnc
						 LEFT JOIN dbo.trans_oc_pol as oc_pol on oc_pol.IdOrdenCompraEnc= re_oc.IdOrdenCompraEnc
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                         dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                         dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                         dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                         dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, 
                         dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, 
                         dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, 
                         dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta,
						 oc_pol.numero_orden,oc_pol.codigo_poliza,re_oc.IdOrdenCompraEnc





/****** #EJC - Agregué ubicacion_picking a vista Object:  View [dbo].[VW_Stock_Res]    Script Date: 16/12/2021 12:47:20 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT        dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, 
                         dbo.stock.IdStock, dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion,
                          dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                         dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                         dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                         dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, 
                         dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, 
                         dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, 
                         dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                         dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, 
                         ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, bodega_ubicacion.ubicacion_picking
FROM            dbo.producto_estado INNER JOIN
                         dbo.unidad_medida INNER JOIN
                         dbo.propietarios INNER JOIN
                         dbo.stock INNER JOIN
                         dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                         dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                         dbo.bodega_tramo INNER JOIN
                         dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
                         dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_bodega INNER JOIN
                         dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                         dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                         dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                         dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                         dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                         dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                         dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                         dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                         dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                         dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                         dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, 
                         dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, 
                         dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, 
                         dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, 
                         oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, bodega_ubicacion.ubicacion_picking
GO


ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT        dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, 
                         dbo.stock.IdStock, dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion,
                          dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                         dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                         dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                         dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, 
                         dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, 
                         dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, 
                         dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                         dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, 
                         ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, 
                         dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama
FROM            dbo.producto_estado INNER JOIN
                         dbo.unidad_medida INNER JOIN
                         dbo.propietarios INNER JOIN
                         dbo.stock INNER JOIN
                         dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                         dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                         dbo.bodega_tramo INNER JOIN
                         dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
                         dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_bodega INNER JOIN
                         dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                         dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                         dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                         dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                         dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                         dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                         dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                         dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                         dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                         dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                         dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, 
                         dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, 
                         dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, 
                         dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, 
                         oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama
GO


/****** Object:  View [dbo].[VW_Stock_Res] EJC ADD es_rack   Script Date: 29/01/2022 15:40:29 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT        dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, 
                         dbo.stock.IdStock, dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion,
                          dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                         dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                         dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                         dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, 
                         dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, 
                         dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, 
                         dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                         dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, 
                         ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, 
                         dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack
FROM            dbo.producto_estado INNER JOIN
                         dbo.unidad_medida INNER JOIN
                         dbo.propietarios INNER JOIN
                         dbo.stock INNER JOIN
                         dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                         dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                         dbo.bodega_tramo INNER JOIN
                         dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
                         dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_bodega INNER JOIN
                         dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                         dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                         dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                         dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                         dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                         dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                         dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                         dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                         dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                         dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                         dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, 
                         dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, 
                         dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, 
                         dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, 
                         oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama
GO


--#EJC20220217_2353AM: Agregué Area (nombre) CEALSA.
ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT        dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, 
                         dbo.stock.IdStock, dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion,
                          dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                         dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                         dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                         dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, 
                         dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, 
                         dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, 
                         dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
                         dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, 
                         ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, 
                         dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack, dbo.Nombre_Area(bodega_ubicacion.IdArea,bodega_ubicacion.IdBodega) as Area
FROM            dbo.producto_estado INNER JOIN
                         dbo.unidad_medida INNER JOIN
                         dbo.propietarios INNER JOIN
                         dbo.stock INNER JOIN
                         dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                         dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                         dbo.bodega_tramo INNER JOIN
                         dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND 
                         dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_bodega INNER JOIN
                         dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                         dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                         dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                         dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                         dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                         dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                         dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                         dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                         dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                         dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, 
                         dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                         dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                         dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                         dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, 
                         dbo.producto_presentacion.MaximoExistencia, dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, 
                         dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, 
                         dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, 
                         oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
						 bodega_ubicacion.IdArea, bodega_ubicacion.IdBodega
GO



/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 22/02/2022 10:59:03 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, 
                  dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, 
                  dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                  dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                  dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
                  dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, 
                  dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
                  dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, 
                  dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, 
                  ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack, 
                  dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, oc_pol.NoPoliza AS NoTO
FROM     dbo.producto_estado INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON 
                  dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                  dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                  dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, 
                  dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega, oc_pol.NoPoliza
GO


/****************************GT25022022 Se agrega clasificacion para propietario ref de cealsa ********************************************/

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, 
                  dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, 
                  dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                  dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                  dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
                  dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, 
                  dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
                  dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, 
                  dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, 
                  ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack, 
                  dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, oc_pol.NoPoliza AS NoTO, isnull(pr_clas.nombre,'ND') as clasificacion
FROM     dbo.producto_estado INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON 
                  dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                  dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc LEFT OUTER JOIN
				  dbo.producto_clasificacion pr_clas on dbo.producto.IdClasificacion = pr_clas.IdClasificacion
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                  dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, 
                  dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega, oc_pol.NoPoliza,
				  pr_clas.nombre
				  



/******************************************************#GT Se agrega shipper 07032022  ***************************************************************************************/

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT   dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, 
                  dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, 
                  dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                  pr_est.nombre AS NomEstado, pr_est.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, pr_est.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                  dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                  dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
                  dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, 
                  dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
                  dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, 
                  dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, 
                  ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack, 
                  dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, oc_pol.NoPoliza AS NoTO, isnull(pr_clas.nombre,'ND') as clasificacion
				 ,oc_det.IdEmbarcador, oc_ship.Nombre as Embarcador
FROM              dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega
				  INNER JOIN
                  dbo.propietarios on dbo.propietario_bodega.IdPropietario = dbo.propietarios.IdPropietario
inner join  dbo.unidad_medida on
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida 
				  LEFT OUTER join dbo.producto_estado pr_est on dbo.stock.IdProductoEstado = pr_est.IdEstado
				   LEFT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON 
                  dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                  dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc LEFT OUTER JOIN
				  dbo.producto_clasificacion pr_clas on dbo.producto.IdClasificacion = pr_clas.IdClasificacion 
				  INNER JOIN dbo.trans_oc_det oc_det on oc_det.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc 
				  and oc_det.IdUnidadMedidaBasica = producto.IdUnidadMedidaBasica and oc_det.IdProductoBodega = dbo.stock.IdProductoBodega
				  LEFT OUTER JOIN trans_oc_embarcador oc_ship on oc_det.IdEmbarcador = oc_ship.IdEmbarcador  
		  GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, 
				  pr_est.nombre, pr_est.utilizable, 
                  pr_est.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, 
                  dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega, oc_pol.NoPoliza,
	          pr_clas.nombre, oc_det.IdEmbarcador, oc_ship.Nombre



/********************* GT LEFT OUTER JOIN TRANS_OC_DET para el shipper *************************/

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, 
                  dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, 
                  dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.producto_estado.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
                  dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
                  dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
                  dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, 
                  dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
                  dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, 
                  dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, 
                  ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack, 
                  dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, oc_pol.NoPoliza AS NoTO, isnull(pr_clas.nombre,'ND') as clasificacion
				  ,oc_det.IdEmbarcador, oc_ship.Nombre as Embarcador
FROM     dbo.producto_estado INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_estado.IdEstado = dbo.stock.IdProductoEstado LEFT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON 
                  dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                  dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock LEFT OUTER JOIN
                  dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc LEFT OUTER JOIN
				  dbo.producto_clasificacion pr_clas on dbo.producto.IdClasificacion = pr_clas.IdClasificacion LEFT OUTER JOIN 
				  dbo.trans_oc_det oc_det on oc_det.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc
				  and oc_det.IdUnidadMedidaBasica = producto.IdUnidadMedidaBasica and oc_det.IdProductoBodega = dbo.stock.IdProductoBodega LEFT OUTER JOIN 
				  trans_oc_embarcador oc_ship on oc_det.IdEmbarcador = oc_ship.IdEmbarcador  
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                  dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, 
                  dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega, oc_pol.NoPoliza,
				  pr_clas.nombre,oc_det.IdEmbarcador, oc_ship.Nombre

/**** #CKFK20220311 Corrección de la vista porque no se mostraban todos los registros *****************************/
/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 03/11/2022 12:35:52 p. m. ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, 
       dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, 
       dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, 
       dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
       pr_est.nombre AS NomEstado, pr_est.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, pr_est.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
       dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
       dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
       dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, 
       dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
       dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, 
       dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, 
       ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack, 
       dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, oc_pol.NoPoliza AS NoTO, isnull(pr_clas.nombre,'ND') as clasificacion,
	   oc_det.IdEmbarcador, oc_ship.Nombre as Embarcador
FROM  dbo.stock 
	  INNER JOIN
	  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega
	  INNER JOIN
	  dbo.propietarios on dbo.propietario_bodega.IdPropietario = dbo.propietarios.IdPropietario inner join  dbo.unidad_medida on
      dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida 
	  INNER join dbo.producto_estado pr_est on dbo.stock.IdProductoEstado = pr_est.IdEstado
	  INNER JOIN dbo.bodega_tramo 
	  INNER JOIN dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON 
                 dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion 
      INNER JOIN dbo.producto_bodega 
	  INNER JOIN dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto 
	  INNER JOIN dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega 
	  LEFT OUTER JOIN dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega 
	  LEFT OUTER JOIN dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND 
	                                   dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND 
									   dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                                       dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion AND
									   dbo.stock.IdBodega = dbo.stock_res.IdBodega AND
									   dbo.stock.IdProductoEstado  = dbo.stock_res.IdProductoEstado AND
									   dbo.stock.IdProductoEstado = pr_est.IdEstado AND
									   dbo.stock_res.IdUnidadMedida = dbo.unidad_medida.IdUnidadMedida
      LEFT OUTER JOIN dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion 
	  LEFT OUTER JOIN dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock 
	  LEFT OUTER JOIN dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc 
      LEFT OUTER JOIN  dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc 
	  LEFT OUTER JOIN dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc 
	  LEFT OUTER JOIN dbo.producto_clasificacion pr_clas on dbo.producto.IdClasificacion = pr_clas.IdClasificacion 
      LEFT OUTER JOIN dbo.trans_oc_det oc_det on oc_det.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc and 
	                  oc_det.IdUnidadMedidaBasica = producto.IdUnidadMedidaBasica and 
					  oc_det.IdProductoBodega = dbo.stock.IdProductoBodega and
					  oc_det.IdOrdenCompraDet = dbo.stock.IdRecepcionDet
      LEFT OUTER JOIN trans_oc_embarcador oc_ship on oc_det.IdEmbarcador = oc_ship.IdEmbarcador  
		  GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, 
				  pr_est.nombre, pr_est.utilizable, 
                  pr_est.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, 
                  dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega, oc_pol.NoPoliza,
	          pr_clas.nombre, oc_det.IdEmbarcador, oc_ship.Nombre

GO

--#AT 20220314 db.Nombre_Completo_Ubicacion
/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 14/03/2022 18:21:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, 
       dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, 
       dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, 
       dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad, 
       pr_est.nombre AS NomEstado, pr_est.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, pr_est.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, 
       dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada, 
       dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
       dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres, 
       dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
       dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion, 
       dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza, 
       ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack, 
       dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, oc_pol.NoPoliza AS NoTO, isnull(pr_clas.nombre,'ND') as clasificacion,
	   oc_det.IdEmbarcador, oc_ship.Nombre as Embarcador, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion,dbo.bodega_ubicacion.IdBodega) as NombreUbicacion
FROM  dbo.stock 
	  INNER JOIN
	  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega
	  INNER JOIN
	  dbo.propietarios on dbo.propietario_bodega.IdPropietario = dbo.propietarios.IdPropietario inner join  dbo.unidad_medida on
      dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida 
	  INNER join dbo.producto_estado pr_est on dbo.stock.IdProductoEstado = pr_est.IdEstado
	  INNER JOIN dbo.bodega_tramo 
	  INNER JOIN dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON 
                 dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion 
      INNER JOIN dbo.producto_bodega 
	  INNER JOIN dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto 
	  INNER JOIN dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega 
	  LEFT OUTER JOIN dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega 
	  LEFT OUTER JOIN dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND 
	                                   dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND 
									   dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND 
                                       dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion AND
									   dbo.stock.IdBodega = dbo.stock_res.IdBodega AND
									   dbo.stock.IdProductoEstado  = dbo.stock_res.IdProductoEstado AND
									   dbo.stock.IdProductoEstado = pr_est.IdEstado AND
									   dbo.stock_res.IdUnidadMedida = dbo.unidad_medida.IdUnidadMedida
      LEFT OUTER JOIN dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion 
	  LEFT OUTER JOIN dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock 
	  LEFT OUTER JOIN dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc 
      LEFT OUTER JOIN  dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc 
	  LEFT OUTER JOIN dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc 
	  LEFT OUTER JOIN dbo.producto_clasificacion pr_clas on dbo.producto.IdClasificacion = pr_clas.IdClasificacion 
      LEFT OUTER JOIN dbo.trans_oc_det oc_det on oc_det.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc and 
	                  oc_det.IdUnidadMedidaBasica = producto.IdUnidadMedidaBasica and 
					  oc_det.IdProductoBodega = dbo.stock.IdProductoBodega and
					  oc_det.IdOrdenCompraDet = dbo.stock.IdRecepcionDet
      LEFT OUTER JOIN trans_oc_embarcador oc_ship on oc_det.IdEmbarcador = oc_ship.IdEmbarcador  
		  GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, 
				  pr_est.nombre, pr_est.utilizable, 
                  pr_est.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo, 
                  dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking, 
                  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega, oc_pol.NoPoliza,
	          pr_clas.nombre, oc_det.IdEmbarcador, oc_ship.Nombre

GO

/******#CKFK20220719 Agregué el max de IdPedido porque lo necesitamos en la HH en el cambio de ubicación******/
/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 19/07/2022 17:09:43 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER VIEW [dbo].[VW_Stock_Res]
AS
SELECT dbo.producto_bodega.IdBodega, dbo.bodega.codigo AS Bodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock,
dbo.stock.pallet_no_estandar, ISNULL(dbo.stock_det.posiciones, 1) AS Posiciones, dbo.stock.IdUbicacion_anterior, dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc,
dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote,
dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad,
pr_est.nombre AS NomEstado, pr_est.dañado, ISNULL(dbo.producto_presentacion.factor, 0) AS Factor, pr_est.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate,
dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, SUM(dbo.stock_res.cantidad) AS CantidadReservada,
dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS ancho_ubicacion, dbo.bodega_ubicacion.largo AS largo_ubicacion, dbo.bodega_ubicacion.alto AS alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion,
dbo.producto.existencia_min AS existencia_min_umbas, dbo.producto.existencia_max AS existencia_max_umbas, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS existencia_min_pres,
dbo.producto_presentacion.MaximoExistencia AS existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel,
dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion,
dbo.stock.IdBodega) AS Nombre_Completo, dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta, ISNULL(oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(oc_pol.codigo_poliza, 'ND') AS codigo_poliza,
ISNULL(re_oc.IdOrdenCompraEnc, 0) AS Documento_Ingreso, dbo.bodega_ubicacion.ubicacion_picking, dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_tramo.es_rack,
dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, oc_pol.NoPoliza AS NoTO, isnull(pr_clas.nombre,'ND') as clasificacion,
oc_det.IdEmbarcador, oc_ship.Nombre as Embarcador, dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion,dbo.bodega_ubicacion.IdBodega) as NombreUbicacion, MAX(ISNULL(stock_res.IdPedido,0)) IdPedido
FROM dbo.stock
INNER JOIN
dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega
INNER JOIN
dbo.propietarios on dbo.propietario_bodega.IdPropietario = dbo.propietarios.IdPropietario inner join dbo.unidad_medida on
dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida
INNER join dbo.producto_estado pr_est on dbo.stock.IdProductoEstado = pr_est.IdEstado
INNER JOIN dbo.bodega_tramo
INNER JOIN dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector ON
dbo.stock.IdBodega = dbo.bodega_ubicacion.IdBodega AND dbo.stock.IdUbicacion = dbo.bodega_ubicacion.IdUbicacion
INNER JOIN dbo.producto_bodega
INNER JOIN dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto
INNER JOIN dbo.bodega ON dbo.producto_bodega.IdBodega = dbo.bodega.IdBodega
LEFT OUTER JOIN dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion ON dbo.stock.IdProductoBodega = dbo.producto_bodega.IdProductoBodega
LEFT OUTER JOIN dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock AND
dbo.stock.IdPropietarioBodega = dbo.stock_res.IdPropietarioBodega AND
dbo.stock.IdProductoBodega = dbo.stock_res.IdProductoBodega AND
dbo.stock.IdUbicacion = dbo.stock_res.IdUbicacion AND
dbo.stock.IdBodega = dbo.stock_res.IdBodega AND
dbo.stock.IdProductoEstado = dbo.stock_res.IdProductoEstado AND
dbo.stock.IdProductoEstado = pr_est.IdEstado AND
dbo.stock_res.IdUnidadMedida = dbo.unidad_medida.IdUnidadMedida
LEFT OUTER JOIN dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion
LEFT OUTER JOIN dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock
LEFT OUTER JOIN dbo.trans_re_enc AS re_enc ON re_enc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc
LEFT OUTER JOIN dbo.trans_re_oc AS re_oc ON re_oc.IdRecepcionEnc = re_enc.IdRecepcionEnc
LEFT OUTER JOIN dbo.trans_oc_pol AS oc_pol ON oc_pol.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc
LEFT OUTER JOIN dbo.producto_clasificacion pr_clas on dbo.producto.IdClasificacion = pr_clas.IdClasificacion
LEFT OUTER JOIN dbo.trans_oc_det oc_det on oc_det.IdOrdenCompraEnc = re_oc.IdOrdenCompraEnc and
oc_det.IdUnidadMedidaBasica = producto.IdUnidadMedidaBasica and
oc_det.IdProductoBodega = dbo.stock.IdProductoBodega and
oc_det.IdOrdenCompraDet = dbo.stock.IdRecepcionDet
LEFT OUTER JOIN trans_oc_embarcador oc_ship on oc_det.IdEmbarcador = oc_ship.IdEmbarcador
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega,
dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote,
dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado,
pr_est.nombre, pr_est.utilizable,
pr_est.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto,
dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto,
dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia,
dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion,
dbo.bodega_tramo.descripcion, dbo.bodega_ubicacion.orientacion_pos, dbo.bodega_tramo.es_rack, dbo.bodega_tramo.descripcion, dbo.bodega_tramo.IdBodega, dbo.bodega_tramo.IdTramo, dbo.stock.IdBodega, dbo.bodega.codigo,
dbo.bodega.IdEmpresa, dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta, oc_pol.numero_orden, oc_pol.codigo_poliza, re_oc.IdOrdenCompraEnc, dbo.bodega_ubicacion.ubicacion_picking,
dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama, dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega, oc_pol.NoPoliza,
pr_clas.nombre, oc_det.IdEmbarcador, oc_ship.Nombre


GO

--#GT02092022 se agrega es_rack

USE [IMS4MB_DYD_QAS]
GO

/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 2/09/2022 09:58:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_Stock_Res] AS 
SELECT dbo.producto_bodega.IdBodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, 
                  dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.codigo_barra AS Barra, 
                  dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote,                  				  
                  SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, dbo.stock.peso, 
                  ISNULL(dbo.stock.cantidad / IIF(dbo.producto_presentacion.factor = 0, 1, dbo.producto_presentacion.factor), 0) AS Cantidad_Presentacion, dbo.producto_estado.nombre AS NomEstado, 
                  dbo.Nombre_Completo_Ubicacion(dbo.bodega_ubicacion.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS UbicacionCompleta, dbo.producto_estado.dañado, dbo.producto_presentacion.factor, 
                  dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, 
                  dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, 
                  dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, dbo.producto.existencia_max AS Existencia_max_umbas, dbo.producto.costo, 
                  dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, 
                  dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, 
                  ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, 
                  dbo.producto_familia.nombre AS Familia, dbo.trans_oc_pol.numero_orden AS NoTO, dbo.trans_oc_enc.Referencia, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, 
                  dbo.producto_clasificacion.nombre AS Clasificacion, ISNULL(dbo.trans_oc_det.IdEmbarcador, '') IdEmbarcador, ISNULL(oc_emb.Nombre, 'N/D') AS Shipper, ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc, 
                  ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, '') doc_ingreso, dbo.bodega.codigo + ' - ' + dbo.bodega.nombre AS bodega, dbo.p_parametro.descripcion AS parametro_personalizado, 
				  dbo.producto.IDPRODUCTOPARAMETROA, dbo.producto.IDPRODUCTOPARAMETROB, 
                  dbo.producto_parametro_a.Nombre AS parametro_a, 
				  dbo.producto_parametro_b.Nombre AS parametro_b,
				  bodega_tramo.es_rack
				  
FROM     dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc INNER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc INNER JOIN
                  dbo.trans_oc_det ON dbo.trans_oc_enc.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto LEFT OUTER JOIN
                  dbo.producto_clasificacion ON dbo.producto.IdClasificacion = dbo.producto_clasificacion.IdClasificacion RIGHT OUTER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON 
                  dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.trans_oc_embarcador oc_emb ON dbo.trans_oc_det.IdEmbarcador = oc_emb.IdEmbarcador LEFT OUTER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega AND dbo.bodega.IdBodega = dbo.bodega_ubicacion.IdBodega LEFT OUTER JOIN
                  dbo.stock_parametro ON dbo.stock.IdStock = dbo.stock_parametro.IdStock LEFT OUTER JOIN
                  dbo.producto_parametros ON dbo.stock_parametro.IdProductoParametro = dbo.producto_parametros.IdProductoParametro LEFT OUTER JOIN
                  dbo.p_parametro ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock INNER JOIN
                  dbo.trans_re_det ON dbo.trans_oc_det.IdOrdenCompraEnc = dbo.trans_re_det.IdOrdenCompraEnc 
				  AND dbo.trans_oc_det.IdOrdenCompraDet = dbo.trans_re_det.IdOrdenCompraDet 
				  AND dbo.stock.IdRecepcionEnc = dbo.trans_re_det.IdRecepcionEnc
				  AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet
				  --AND dbo.stock.lic_plate = dbo.trans_re_det.lic_plate
				  LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  LEFT OUTER JOIN
                  dbo.producto_parametro_a ON dbo.producto.IDPRODUCTOPARAMETROA = dbo.producto_parametro_a.IdProductoParametroA LEFT OUTER JOIN
                  dbo.producto_parametro_b ON dbo.producto.IDPRODUCTOPARAMETROB = dbo.producto_parametro_b.IdProductoParametroB
				  GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                  dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad, dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.trans_oc_det.IdEmbarcador, oc_emb.Nombre, dbo.trans_oc_enc.Referencia, dbo.trans_oc_enc.IdOrdenCompraEnc, 
                  dbo.bodega.nombre, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, 
                  dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, dbo.bodega.codigo, dbo.trans_oc_enc.no_ticket_tms, dbo.tms_ticket.Fecha_Ingreso,
				  dbo.producto.IDPRODUCTOPARAMETROA,dbo.producto.IDPRODUCTOPARAMETROB,
				  dbo.producto_parametro_a.Nombre,dbo.producto_parametro_b.Nombre, bodega_tramo.es_rack
GO




--#GT07092022-- Se vuelve a agregar IdPedido y renombran campos definidos en la ante-penultima versión de este update.

Alter view VW_Stock_Res as
SELECT dbo.producto_bodega.IdBodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, 
                  dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, 
                  dbo.producto.nombre, dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, 
				  dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso,
				  dbo.stock_det.posiciones,
				  dbo.stock.pallet_no_estandar,
				  SUM(dbo.stock_res.cantidad) AS CantidadReservada,
				  dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas,
                   dbo.producto_estado.nombre AS NomEstado, 
                  dbo.Nombre_Completo_Ubicacion(dbo.bodega_ubicacion.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.producto_estado.dañado, dbo.producto_presentacion.factor, 
                  dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, 
                  dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, dbo.bodega_ubicacion.largo AS Largo_ubicacion, dbo.bodega_ubicacion.alto AS Alto_ubicacion, 
                  dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, dbo.producto.existencia_max AS Existencia_max_umbas, 
				  dbo.producto.codigo_barra,
				  ISNULL(dbo.trans_oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(dbo.trans_oc_pol.codigo_poliza, 'ND') AS codigo_poliza, 
				  ISNULL(dbo.stock.cantidad / IIF(dbo.producto_presentacion.factor = 0, 1, dbo.producto_presentacion.factor), 0) AS Cantidad,
				  dbo.producto.costo, 
                  dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, 
                  dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, 
                  ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion,  
                  dbo.producto_familia.nombre AS Familia, dbo.trans_oc_pol.numero_orden AS NoTO, dbo.trans_oc_enc.Referencia, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, 
                  dbo.producto_clasificacion.nombre AS Clasificacion, ISNULL(dbo.trans_oc_det.IdEmbarcador, '') IdEmbarcador, dbo.trans_oc_embarcador.Nombre AS Embarcador,
				  ISNULL(oc_emb.Nombre, 'N/D') AS Shipper, ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc, 
                  ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, '') Documento_Ingreso, 
				  dbo.bodega.codigo + ' - ' + dbo.bodega.nombre AS bodega, dbo.p_parametro.descripcion AS parametro_personalizado, 
				  dbo.producto.IDPRODUCTOPARAMETROA, dbo.producto.IDPRODUCTOPARAMETROB, 
                  dbo.producto_parametro_a.Nombre AS parametro_a, 
				  dbo.producto_parametro_b.Nombre AS parametro_b,
				  bodega_tramo.es_rack,
				  MAX(ISNULL(dbo.stock_res.IdPedido, 0)) AS IdPedido,
				  dbo.bodega_ubicacion.ubicacion_picking, dbo.producto.IdTipoEtiqueta
FROM     dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc INNER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc INNER JOIN
                  dbo.trans_oc_det ON dbo.trans_oc_enc.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto LEFT OUTER JOIN
                  dbo.producto_clasificacion ON dbo.producto.IdClasificacion = dbo.producto_clasificacion.IdClasificacion RIGHT OUTER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON 
                  dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.trans_oc_embarcador oc_emb ON dbo.trans_oc_det.IdEmbarcador = oc_emb.IdEmbarcador LEFT OUTER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega AND dbo.bodega.IdBodega = dbo.bodega_ubicacion.IdBodega LEFT OUTER JOIN
                  dbo.stock_parametro ON dbo.stock.IdStock = dbo.stock_parametro.IdStock LEFT OUTER JOIN
                  dbo.producto_parametros ON dbo.stock_parametro.IdProductoParametro = dbo.producto_parametros.IdProductoParametro LEFT OUTER JOIN
                  dbo.p_parametro ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock INNER JOIN
                  dbo.trans_re_det ON dbo.trans_oc_det.IdOrdenCompraEnc = dbo.trans_re_det.IdOrdenCompraEnc 
				  AND dbo.trans_oc_det.IdOrdenCompraDet = dbo.trans_re_det.IdOrdenCompraDet 
				  AND dbo.stock.IdRecepcionEnc = dbo.trans_re_det.IdRecepcionEnc
				  AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet
				  --AND dbo.stock.lic_plate = dbo.trans_re_det.lic_plate
				  LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket
				  LEFT OUTER JOIN
                  dbo.producto_parametro_a ON dbo.producto.IDPRODUCTOPARAMETROA = dbo.producto_parametro_a.IdProductoParametroA LEFT OUTER JOIN
                  dbo.producto_parametro_b ON dbo.producto.IDPRODUCTOPARAMETROB = dbo.producto_parametro_b.IdProductoParametroB
				  LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador =  dbo.trans_oc_embarcador.IdEmbarcador
				  GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                  dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad, dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.trans_oc_det.IdEmbarcador, oc_emb.Nombre, dbo.trans_oc_enc.Referencia, dbo.trans_oc_enc.IdOrdenCompraEnc, 
                  dbo.bodega.nombre, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, 
                  dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, dbo.bodega.codigo, dbo.trans_oc_enc.no_ticket_tms, dbo.tms_ticket.Fecha_Ingreso,
				  dbo.producto.IDPRODUCTOPARAMETROA,dbo.producto.IDPRODUCTOPARAMETROB,
				  dbo.producto_parametro_a.Nombre,dbo.producto_parametro_b.Nombre, bodega_tramo.es_rack,
				  dbo.bodega_ubicacion.ubicacion_picking, dbo.trans_oc_embarcador.Nombre,dbo.stock.pallet_no_estandar,dbo.producto.IdTipoEtiqueta



--#GT26092022: se agregan campos para DyD 


/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 26/09/2022 11:59:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[VW_Stock_Res] as
SELECT dbo.producto_bodega.IdBodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, 
                  dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, 
                  dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, 
                  dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, SUM(dbo.stock_res.cantidad) AS CantidadReservada, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.Nombre_Completo_Ubicacion(dbo.bodega_ubicacion.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.producto_estado.dañado, 
                  dbo.producto_presentacion.factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, dbo.bodega_ubicacion.largo AS Largo_ubicacion, 
                  dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, dbo.producto.existencia_max AS Existencia_max_umbas, 
                  dbo.producto.codigo_barra, ISNULL(dbo.trans_oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(dbo.trans_oc_pol.codigo_poliza, 'ND') AS codigo_poliza, ISNULL(dbo.stock.cantidad / IIF(dbo.producto_presentacion.factor = 0, 1, 
                  dbo.producto_presentacion.factor), 0) AS Cantidad, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, 
                  dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.numero_orden AS NoTO, dbo.trans_oc_enc.Referencia, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, 
                  ISNULL(dbo.trans_oc_det.IdEmbarcador, '') IdEmbarcador, dbo.trans_oc_embarcador.Nombre AS Embarcador, ISNULL(oc_emb.Nombre, 'N/D') AS Shipper, ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc, 
                  ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, '') Documento_Ingreso, dbo.bodega.codigo + ' - ' + dbo.bodega.nombre AS bodega, dbo.p_parametro.descripcion AS parametro_personalizado, 
				  dbo.producto.IDPRODUCTOPARAMETROA, 
                  dbo.producto.IDPRODUCTOPARAMETROB, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, bodega_tramo.es_rack, MAX(ISNULL(dbo.stock_res.IdPedido, 0)) AS IdPedido, 
                  dbo.bodega_ubicacion.ubicacion_picking, dbo.producto.IdTipoEtiqueta,
				  dbo.producto_marca.nombre as marca, dbo.producto_tipo.NombreTipoProducto as tipo
FROM     dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc INNER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc INNER JOIN
                  dbo.trans_oc_det ON dbo.trans_oc_enc.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto LEFT OUTER JOIN
                  dbo.producto_clasificacion ON dbo.producto.IdClasificacion = dbo.producto_clasificacion.IdClasificacion RIGHT OUTER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON 
                  dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.trans_oc_embarcador oc_emb ON dbo.trans_oc_det.IdEmbarcador = oc_emb.IdEmbarcador LEFT OUTER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega AND dbo.bodega.IdBodega = dbo.bodega_ubicacion.IdBodega LEFT OUTER JOIN
                  dbo.stock_parametro ON dbo.stock.IdStock = dbo.stock_parametro.IdStock LEFT OUTER JOIN
                  dbo.producto_parametros ON dbo.stock_parametro.IdProductoParametro = dbo.producto_parametros.IdProductoParametro LEFT OUTER JOIN
                  dbo.p_parametro ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock INNER JOIN
                  dbo.trans_re_det ON dbo.trans_oc_det.IdOrdenCompraEnc = dbo.trans_re_det.IdOrdenCompraEnc AND dbo.trans_oc_det.IdOrdenCompraDet = dbo.trans_re_det.IdOrdenCompraDet AND 
                  dbo.stock.IdRecepcionEnc = dbo.trans_re_det.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet /*AND dbo.stock.lic_plate = dbo.trans_re_det.lic_plate*/ LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket LEFT OUTER JOIN
                  dbo.producto_parametro_a ON dbo.producto.IDPRODUCTOPARAMETROA = dbo.producto_parametro_a.IdProductoParametroA LEFT OUTER JOIN
                  dbo.producto_parametro_b ON dbo.producto.IDPRODUCTOPARAMETROB = dbo.producto_parametro_b.IdProductoParametroB LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador
				  LEFT OUTER JOIN dbo.producto_marca on dbo.producto.IdMarca = dbo.producto_marca.IdMarca and 
				  dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario
				  LEFT OUTER JOIN dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto and
				  dbo.producto.IdPropietario = dbo.producto_tipo.IdTipoProducto
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                  dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad, dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.trans_oc_det.IdEmbarcador, oc_emb.Nombre, dbo.trans_oc_enc.Referencia, dbo.trans_oc_enc.IdOrdenCompraEnc, 
                  dbo.bodega.nombre, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, 
                  dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, dbo.bodega.codigo, dbo.trans_oc_enc.no_ticket_tms, dbo.tms_ticket.Fecha_Ingreso, dbo.producto.IDPRODUCTOPARAMETROA, 
                  dbo.producto.IDPRODUCTOPARAMETROB, dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, bodega_tramo.es_rack, dbo.bodega_ubicacion.ubicacion_picking, dbo.trans_oc_embarcador.Nombre, 
                  dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta,
				   dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto
GO



--#GT06102022--Se cambia costos del producto por costos de la oc_det



ALTER view [dbo].[VW_Stock_Res] as
SELECT dbo.producto_bodega.IdBodega, dbo.propietarios.IdPropietario, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto.IdProducto, dbo.producto_bodega.IdProductoBodega, dbo.stock.IdStock, dbo.stock.IdUbicacion_anterior, 
                  dbo.unidad_medida.IdUnidadMedida, dbo.stock.IdProductoEstado, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.propietarios.nombre_comercial AS Propietario, dbo.producto.codigo, dbo.producto.nombre, 
                  dbo.unidad_medida.Nombre AS UnidadMedida, dbo.producto_presentacion.nombre AS Presentacion, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.fecha_vence, ISNULL(dbo.stock.cantidad, 0) AS CantidadSF, dbo.stock.peso, 
                  dbo.stock_det.posiciones, dbo.stock.pallet_no_estandar, SUM(dbo.stock_res.cantidad) AS CantidadReservada, dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, 
                  dbo.producto_estado.nombre AS NomEstado, dbo.Nombre_Completo_Ubicacion(dbo.bodega_ubicacion.IdUbicacion, dbo.bodega_ubicacion.IdBodega) AS Nombre_Completo, dbo.producto_estado.dañado, 
                  dbo.producto_presentacion.factor, dbo.producto_estado.utilizable AS EstadoUtilizable, dbo.stock.IdUbicacion, dbo.stock.lic_plate, dbo.stock.serial, dbo.stock.añada, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho AS Ancho_ubicacion, dbo.bodega_ubicacion.largo AS Largo_ubicacion, 
                  dbo.bodega_ubicacion.alto AS Alto_ubicacion, dbo.indice_rotacion.Descripcion AS IndiceRotacion, dbo.producto.existencia_min AS Existencia_min_umbas, dbo.producto.existencia_max AS Existencia_max_umbas, 
                  dbo.producto.codigo_barra, ISNULL(dbo.trans_oc_pol.numero_orden, 'ND') AS numero_orden, ISNULL(dbo.trans_oc_pol.codigo_poliza, 'ND') AS codigo_poliza, ISNULL(dbo.stock.cantidad / IIF(dbo.producto_presentacion.factor = 0, 1, 
                  dbo.producto_presentacion.factor), 0) AS Cantidad, 
				  --dbo.producto.costo, 
				  dbo.trans_oc_det.costo,
				  dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
                  dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual, dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, 
                  dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, dbo.producto_familia.nombre AS Familia, 
                  dbo.trans_oc_pol.numero_orden AS NoTO, dbo.trans_oc_enc.Referencia, dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, dbo.producto_clasificacion.nombre AS Clasificacion, 
                  ISNULL(dbo.trans_oc_det.IdEmbarcador, '') IdEmbarcador, dbo.trans_oc_embarcador.Nombre AS Embarcador, ISNULL(oc_emb.Nombre, 'N/D') AS Shipper, ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc, 
                  ISNULL(dbo.trans_oc_enc.IdOrdenCompraEnc, '') Documento_Ingreso, dbo.bodega.codigo + ' - ' + dbo.bodega.nombre AS bodega, dbo.p_parametro.descripcion AS parametro_personalizado, 
				  dbo.producto.IDPRODUCTOPARAMETROA, 
                  dbo.producto.IDPRODUCTOPARAMETROB, dbo.producto_parametro_a.Nombre AS parametro_a, dbo.producto_parametro_b.Nombre AS parametro_b, bodega_tramo.es_rack, MAX(ISNULL(dbo.stock_res.IdPedido, 0)) AS IdPedido, 
                  dbo.bodega_ubicacion.ubicacion_picking, dbo.producto.IdTipoEtiqueta,
				  dbo.producto_marca.nombre as marca, dbo.producto_tipo.NombreTipoProducto as tipo
FROM     dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc INNER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc INNER JOIN
                  dbo.trans_oc_det ON dbo.trans_oc_enc.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND 
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto LEFT OUTER JOIN
                  dbo.producto_clasificacion ON dbo.producto.IdClasificacion = dbo.producto_clasificacion.IdClasificacion RIGHT OUTER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON 
                  dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON 
                  dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.indice_rotacion ON dbo.producto.IdIndiceRotacion = dbo.indice_rotacion.IdIndiceRotacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_presentacion ON dbo.stock.IdPresentacion = dbo.producto_presentacion.IdPresentacion LEFT OUTER JOIN
                  dbo.trans_oc_embarcador oc_emb ON dbo.trans_oc_det.IdEmbarcador = oc_emb.IdEmbarcador LEFT OUTER JOIN
                  dbo.bodega ON dbo.stock.IdBodega = dbo.bodega.IdBodega AND dbo.bodega.IdBodega = dbo.bodega_ubicacion.IdBodega LEFT OUTER JOIN
                  dbo.stock_parametro ON dbo.stock.IdStock = dbo.stock_parametro.IdStock LEFT OUTER JOIN
                  dbo.producto_parametros ON dbo.stock_parametro.IdProductoParametro = dbo.producto_parametros.IdProductoParametro LEFT OUTER JOIN
                  dbo.p_parametro ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro LEFT OUTER JOIN
                  dbo.stock_det ON dbo.stock.IdStock = dbo.stock_det.IdStock INNER JOIN
                  dbo.trans_re_det ON dbo.trans_oc_det.IdOrdenCompraEnc = dbo.trans_re_det.IdOrdenCompraEnc AND dbo.trans_oc_det.IdOrdenCompraDet = dbo.trans_re_det.IdOrdenCompraDet AND 
                  dbo.stock.IdRecepcionEnc = dbo.trans_re_det.IdRecepcionEnc AND dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepcionDet /*AND dbo.stock.lic_plate = dbo.trans_re_det.lic_plate*/ LEFT OUTER JOIN
                  dbo.tms_ticket ON dbo.trans_oc_enc.no_ticket_tms = dbo.tms_ticket.IdTicket LEFT OUTER JOIN
                  dbo.producto_parametro_a ON dbo.producto.IDPRODUCTOPARAMETROA = dbo.producto_parametro_a.IdProductoParametroA LEFT OUTER JOIN
                  dbo.producto_parametro_b ON dbo.producto.IDPRODUCTOPARAMETROB = dbo.producto_parametro_b.IdProductoParametroB LEFT OUTER JOIN
                  dbo.trans_oc_embarcador ON dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador
				  LEFT OUTER JOIN dbo.producto_marca on dbo.producto.IdMarca = dbo.producto_marca.IdMarca and 
				  dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario
				  LEFT OUTER JOIN dbo.producto_tipo ON dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto and
				  dbo.producto.IdPropietario = dbo.producto_tipo.IdTipoProducto
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, 
                  dbo.producto_bodega.IdProductoBodega, dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, 
                  dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada, dbo.producto_bodega.IdBodega, dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, 
                  dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso, dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, 
                  dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo, dbo.bodega_ubicacion.alto, 
                  dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia, 
                  dbo.stock.cantidad, dbo.stock.cantidad, dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion, 
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, 
                  dbo.trans_oc_enc.Referencia, dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.trans_oc_det.IdEmbarcador, oc_emb.Nombre, dbo.trans_oc_enc.Referencia, dbo.trans_oc_enc.IdOrdenCompraEnc, 
                  dbo.bodega.nombre, dbo.p_parametro.descripcion, dbo.p_parametro.tipo, dbo.stock_parametro.valor_numerico, dbo.stock_parametro.valor_texto, dbo.stock_parametro.valor_fecha, dbo.stock_parametro.valor_logico, 
                  dbo.stock_det.posiciones, dbo.trans_oc_det.costo, dbo.trans_oc_det.cantidad_recibida, dbo.bodega.codigo, dbo.trans_oc_enc.no_ticket_tms, dbo.tms_ticket.Fecha_Ingreso, dbo.producto.IDPRODUCTOPARAMETROA, 
                  dbo.producto.IDPRODUCTOPARAMETROB, dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, bodega_tramo.es_rack, dbo.bodega_ubicacion.ubicacion_picking, dbo.trans_oc_embarcador.Nombre, 
                  dbo.stock.pallet_no_estandar, dbo.producto.IdTipoEtiqueta,
				   dbo.producto_marca.nombre, dbo.producto_tipo.NombreTipoProducto
GO
/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 18/10/2022 15:06:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER VIEW [dbo].[VW_Stock_Res] AS
SELECT     dbo.stock.IdBodega, 
		   dbo.bodega.nombre Bodega, 
           dbo.propietarios.IdPropietario, 
		   dbo.propietario_bodega.IdPropietarioBodega, 
		   dbo.propietarios.nombre_comercial AS Propietario,  
		   dbo.producto.IdProducto, 
		   dbo.producto_bodega.IdProductoBodega, 
		   dbo.stock.IdStock, 
		   dbo.stock.IdUbicacion_anterior, 
		   dbo.unidad_medida.IdUnidadMedida,
		   dbo.stock.IdProductoEstado, 
		   dbo.stock.IdPresentacion, 
		   dbo.stock.IdRecepcionEnc,
		   dbo.producto.codigo,
		   dbo.producto.codigo_barra,
		   dbo.producto.nombre, 
		   dbo.unidad_medida.Nombre AS UnidadMedida,
           dbo.producto_presentacion.nombre AS Presentacion, 
		   dbo.stock.lote, 
		   dbo.stock.fecha_ingreso, 
		   dbo.stock.fecha_vence, 
		   dbo.stock.cantidad AS Cantidad_UMBas, 
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, 
		   dbo.producto_presentacion.factor, 
		   SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, 
		   CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0))/ dbo.producto_presentacion.factor, 6) ELSE 0 END AS Cantidad_Reservada_Pres, 
		   dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, 
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, 
		   dbo.stock.peso, dbo.producto_estado.nombre AS NomEstado,
		   dbo.producto_estado.dañado, 
		   dbo.producto_estado.utilizable AS EstadoUtilizable, 
		   dbo.stock.IdUbicacion, 
		   dbo.stock.lic_plate,
           dbo.stock.serial, dbo.stock.añada, 
		   dbo.producto.IdIndiceRotacion, 
		   dbo.producto_presentacion.alto, 
		   dbo.producto_presentacion.largo, 
		   dbo.producto_presentacion.ancho, 
		   dbo.bodega_ubicacion.IdTramo, 
		   dbo.bodega_ubicacion.ancho AS Ancho_ubicacion,
           dbo.bodega_ubicacion.largo AS Largo_ubicacion, 
		   dbo.bodega_ubicacion.alto AS Alto_ubicacion, 
		   dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
		   dbo.producto.existencia_min AS Existencia_min_umbas, 
		   dbo.producto.existencia_max AS Existencia_max_umbas,
           dbo.trans_oc_det.costo, 
		   dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, 
		   dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
		   dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual,
           dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
		   dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, 
		   dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
		   dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, 
		   ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
		   ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, 
		   ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, 
		   --numero_orden, 
		   dbo.producto_familia.nombre AS Familia, 
		   dbo.trans_oc_pol.NoPoliza AS NoTO, 
		   dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, 
		   dbo.producto_clasificacion.nombre AS Clasificacion, 
		   dbo.producto_parametro_a.IdProductoParametroA, 
		   dbo.producto_parametro_b.IdProductoParametroB, 
		   stock.atributo_variante_1,
           dbo.producto_parametro_a.Nombre AS parametro_a, 
		   dbo.producto_parametro_b.Nombre AS parametro_b,
           dbo.p_parametro.descripcion AS parametro_personalizado,
           case
            when p_parametro.tipo = 'Númerico' then dbo.stock_parametro.valor_numerico
            when p_parametro.tipo = 'Texto' then dbo.stock_parametro.valor_texto
            when p_parametro.tipo = 'Fecha' then  convert(varchar, dbo.stock_parametro.valor_fecha, 101)   
            when p_parametro.tipo = 'Lógico' then dbo.stock_parametro.valor_logico end as parametro_valor,
           dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto as tipo,
		   dbo.producto_marca.IdMarca,dbo.producto_marca.nombre as marca,
		   dbo.stock.cantidad,
		   dbo.trans_oc_enc.IdOrdenCompraEnc as doc_ingreso,
		   ISNULL(dbo.stock_det.posiciones, 1) posiciones,
		   CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END valor_unitario, 
		   CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN 
				CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) > 0 
			THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo 
						ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END 
			END valor_total,
			ISNULL(dbo.trans_oc_det.IdEmbarcador,'') IdEmbarcador, ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D') as Shipper,
			dbo.bodega.nombre as Regimen,
			ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' '  + convert(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14),'') as ingreso_ticket,
			dbo.bodega.IdEmpresa, 
			IdTipoEtiqueta, 
			ubicacion_picking, 
			dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
			MAX(dbo.stock_res.IdPedido) AS IdPedido, 
			dbo.stock.pallet_no_estandar,
			ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D')  Embarcador, 
			ISNULL(trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso,
			SUM(ISNULL(dbo.stock_res.cantidad, 0)) CantidadReservada,
			ISNULL(dbo.stock.cantidad, 0) AS CantidadSF,
			dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion,dbo.bodega_ubicacion.IdBodega) as Nombre_Completo,
			dbo.bodega_tramo.es_rack, 
          ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc
FROM        dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON
                  dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND
                  dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON
                  dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON
                  dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro
				  LEFT OUTER JOIN dbo.producto_marca on dbo.producto.IdMarca = dbo.producto_marca.IdMarca
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario
				  LEFT OUTER JOIN dbo.producto_tipo on dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario

				  LEFT OUTER JOIN dbo.stock_det on dbo.stock.IdStock = dbo.stock_det.IdStock
				 left outer join dbo.trans_re_enc on dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc
				 left outer join dbo.trans_re_det on dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc 
				 and dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepciondet
				 left outer join  dbo.trans_oc_det on dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet 
				 and dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc
				 
				 LEFT OUTER JOIN dbo.trans_oc_embarcador on dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador
				 INNER JOIN dbo.bodega on dbo.stock.IdBodega = dbo.bodega.IdBodega
				 LEFT OUTER JOIN dbo.tms_ticket on dbo.trans_oc_enc.no_ticket_tms= dbo.tms_ticket.IdTicket
				
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto_bodega.IdProductoBodega,
                  dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada,
                  dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso,
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo,
                  dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia,
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion,
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, dbo.trans_oc_enc.Referencia,
                  dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega,
                  p_parametro.descripcion,p_parametro.tipo,stock_parametro.valor_numerico,stock_parametro.valor_texto,stock_parametro.valor_fecha,stock_parametro.valor_logico,
				  dbo.producto_tipo.IdTipoProducto,dbo.producto_marca.IdMarca,
				  dbo.producto_marca.nombre,dbo.producto_tipo.NombreTipoProducto,

				  dbo.trans_oc_enc.IdOrdenCompraEnc,dbo.stock_det.posiciones,
				  dbo.trans_oc_det.costo,
				  dbo.trans_oc_det.cantidad_recibida,
				  dbo.trans_oc_det.IdEmbarcador,dbo.trans_oc_embarcador.Nombre,
				  dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso
				  , dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta,
				  dbo.bodega_ubicacion.ubicacion_picking,  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
				  dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack
GO



--#GT 10112022 Se castean los valores de parametro_valor a nvarchar (sea tipo logico, date o int )

/****** Object:  View [dbo].[VW_Stock_Res]    Script Date: 10/11/2022 17:31:29 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[VW_Stock_Res] AS
SELECT     dbo.stock.IdBodega, 
		   dbo.bodega.nombre Bodega, 
           dbo.propietarios.IdPropietario, 
		   dbo.propietario_bodega.IdPropietarioBodega, 
		   dbo.propietarios.nombre_comercial AS Propietario,  
		   dbo.producto.IdProducto, 
		   dbo.producto_bodega.IdProductoBodega, 
		   dbo.stock.IdStock, 
		   dbo.stock.IdUbicacion_anterior, 
		   dbo.unidad_medida.IdUnidadMedida,
		   dbo.stock.IdProductoEstado, 
		   dbo.stock.IdPresentacion, 
		   dbo.stock.IdRecepcionEnc,
		   dbo.producto.codigo,
		   dbo.producto.codigo_barra,
		   dbo.producto.nombre, 
		   dbo.unidad_medida.Nombre AS UnidadMedida,
           dbo.producto_presentacion.nombre AS Presentacion, 
		   dbo.stock.lote, 
		   dbo.stock.fecha_ingreso, 
		   dbo.stock.fecha_vence, 
		   dbo.stock.cantidad AS Cantidad_UMBas,
		   ISNULL(dbo.stock.cantidad, 0) AS CantidadSF,
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, 
		   dbo.producto_presentacion.factor, 
		   SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, 
		   CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0))/ dbo.producto_presentacion.factor, 6) ELSE 0 END AS Cantidad_Reservada_Pres, 
		   dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, 
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, 
		   dbo.stock.peso, dbo.producto_estado.nombre AS NomEstado,
		   dbo.producto_estado.dañado, 
		   dbo.producto_estado.utilizable AS EstadoUtilizable, 
		   dbo.stock.IdUbicacion, 
		   dbo.stock.lic_plate,
           dbo.stock.serial, dbo.stock.añada, 
		   dbo.producto.IdIndiceRotacion, 
		   dbo.producto_presentacion.alto, 
		   dbo.producto_presentacion.largo, 
		   dbo.producto_presentacion.ancho, 
		   dbo.bodega_ubicacion.IdTramo, 
		   dbo.bodega_ubicacion.ancho AS Ancho_ubicacion,
           dbo.bodega_ubicacion.largo AS Largo_ubicacion, 
		   dbo.bodega_ubicacion.alto AS Alto_ubicacion, 
		   dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
		   dbo.producto.existencia_min AS Existencia_min_umbas, 
		   dbo.producto.existencia_max AS Existencia_max_umbas,
           dbo.trans_oc_det.costo, 
		   dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, 
		   dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
		   dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual,
           dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
		   dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, 
		   dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
		   dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, 
		   dbo.bodega_ubicacion.activo,
		   dbo.bodega_ubicacion.bloqueada,
		   dbo.bodega_ubicacion.ubicacion_merma,		   
		   ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
		   ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, 
		   ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, 
		   numero_orden, 
		   dbo.producto_familia.nombre AS Familia, 
		   dbo.trans_oc_pol.NoPoliza AS NoTO, 
		   dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, 
		   dbo.producto_clasificacion.nombre AS Clasificacion, 
		   dbo.producto_parametro_a.IdProductoParametroA, 
		   dbo.producto_parametro_b.IdProductoParametroB, 
		   stock.atributo_variante_1,
           dbo.producto_parametro_a.Nombre AS parametro_a, 
		   dbo.producto_parametro_b.Nombre AS parametro_b,
           dbo.p_parametro.descripcion AS parametro_personalizado,
           case
            when p_parametro.tipo = 'Númerico'  then CAST( dbo.stock_parametro.valor_numerico AS nvarchar)
            when p_parametro.tipo = 'Texto' then dbo.stock_parametro.valor_texto
            when p_parametro.tipo = 'Fecha' then  convert(varchar, dbo.stock_parametro.valor_fecha, 101)   
            when p_parametro.tipo = 'Lógico' then  CAST(dbo.stock_parametro.valor_logico AS nvarchar) end as parametro_valor,
           dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto as tipo,
		   dbo.producto_marca.IdMarca,dbo.producto_marca.nombre as marca,
		   dbo.stock.cantidad,
		   dbo.trans_oc_enc.IdOrdenCompraEnc as doc_ingreso,
		   ISNULL(dbo.stock_det.posiciones, 1) posiciones,
		   CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END valor_unitario, 
		   CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN 
				CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) > 0 
			THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo 
						ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END 
			END valor_total,
			ISNULL(dbo.trans_oc_det.IdEmbarcador,0) IdEmbarcador, ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D') as Shipper,
			dbo.bodega.nombre as Regimen,
			ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' '  + convert(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14),'') as ingreso_ticket,
			dbo.bodega.IdEmpresa, 
			IdTipoEtiqueta, 
			ubicacion_picking, 
			dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
			MAX(dbo.stock_res.IdPedido) AS IdPedido, 
			dbo.stock.pallet_no_estandar,
			ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D')  Embarcador, 
			ISNULL(trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso,
			SUM(ISNULL(dbo.stock_res.cantidad, 0)) CantidadReservada,
			
			dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion,dbo.bodega_ubicacion.IdBodega) as Nombre_Completo,
			dbo.bodega_tramo.es_rack, 
          ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc
FROM        dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON
                  dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND
                  dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON
                  dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON
                  dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro
				  LEFT OUTER JOIN dbo.producto_marca on dbo.producto.IdMarca = dbo.producto_marca.IdMarca
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario
				  LEFT OUTER JOIN dbo.producto_tipo on dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario

				  LEFT OUTER JOIN dbo.stock_det on dbo.stock.IdStock = dbo.stock_det.IdStock
				 left outer join dbo.trans_re_enc on dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc
				 left outer join dbo.trans_re_det on dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc 
				 and dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepciondet
				 left outer join  dbo.trans_oc_det on dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet 
				 and dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc
				 
				 LEFT OUTER JOIN dbo.trans_oc_embarcador on dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador
				 INNER JOIN dbo.bodega on dbo.stock.IdBodega = dbo.bodega.IdBodega
				 LEFT OUTER JOIN dbo.tms_ticket on dbo.trans_oc_enc.no_ticket_tms= dbo.tms_ticket.IdTicket
				
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto_bodega.IdProductoBodega,
                  dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada,
                  dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso,
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo,
                  dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia,
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion,
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, dbo.trans_oc_enc.Referencia,
                  dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega,
                  p_parametro.descripcion,p_parametro.tipo,stock_parametro.valor_numerico,stock_parametro.valor_texto,stock_parametro.valor_fecha,stock_parametro.valor_logico,
				  dbo.producto_tipo.IdTipoProducto,dbo.producto_marca.IdMarca,
				  dbo.producto_marca.nombre,dbo.producto_tipo.NombreTipoProducto,
				  dbo.bodega_ubicacion.activo,
				  dbo.bodega_ubicacion.bloqueada,
				  dbo.bodega_ubicacion.ubicacion_merma,
				  dbo.trans_oc_enc.IdOrdenCompraEnc,dbo.stock_det.posiciones,
				  dbo.trans_oc_det.costo,
				  dbo.trans_oc_det.cantidad_recibida,
				  dbo.trans_oc_det.IdEmbarcador,dbo.trans_oc_embarcador.Nombre,
				  dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso
				  , dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta,
				  dbo.bodega_ubicacion.ubicacion_picking,  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
				  dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack
GO



/************** #GT05122022: Campos de precio, costo y costo unitario para DyD


ALTER VIEW [dbo].[VW_Stock_Res] AS
SELECT     dbo.stock.IdBodega, 
		   dbo.bodega.nombre Bodega, 
           dbo.propietarios.IdPropietario, 
		   dbo.propietario_bodega.IdPropietarioBodega, 
		   dbo.propietarios.nombre_comercial AS Propietario,  
		   dbo.producto.IdProducto, 
		   dbo.producto_bodega.IdProductoBodega, 
		   dbo.stock.IdStock, 
		   dbo.stock.IdUbicacion_anterior, 
		   dbo.unidad_medida.IdUnidadMedida,
		   dbo.stock.IdProductoEstado, 
		   dbo.stock.IdPresentacion, 
		   dbo.stock.IdRecepcionEnc,
		   dbo.producto.codigo,
		   dbo.producto.codigo_barra,
		   dbo.producto.nombre, 
		   dbo.unidad_medida.Nombre AS UnidadMedida,
           dbo.producto_presentacion.nombre AS Presentacion, 
		   dbo.stock.lote, 
		   dbo.stock.fecha_ingreso, 
		   dbo.stock.fecha_vence, 
		   dbo.stock.cantidad AS Cantidad_UMBas,
		   ISNULL(dbo.stock.cantidad, 0) AS CantidadSF,
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) AS Cantidad_Presentacion, 
		   dbo.producto_presentacion.factor, 
		   SUM(ISNULL(dbo.stock_res.cantidad, 0)) AS CantidadReservadaUmBas, 
		   CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0))/ dbo.producto_presentacion.factor, 6) ELSE 0 END AS Cantidad_Reservada_Pres, 
		   dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0) AS Disponible_UMBas, 
		   ISNULL(dbo.stock.cantidad / dbo.producto_presentacion.factor, 0) - (CASE WHEN ISNULL(dbo.producto_presentacion.factor, 0) > 0 THEN ROUND(SUM(ISNULL(dbo.stock_res.cantidad, 0)) / dbo.producto_presentacion.factor, 6) ELSE 0 END) AS Disponible_Presentacion, 
		   dbo.stock.peso, dbo.producto_estado.nombre AS NomEstado,
		   dbo.producto_estado.dañado, 
		   dbo.producto_estado.utilizable AS EstadoUtilizable, 
		   dbo.stock.IdUbicacion, 
		   dbo.stock.lic_plate,
           dbo.stock.serial, dbo.stock.añada, 
		   dbo.producto.IdIndiceRotacion, 
		   dbo.producto_presentacion.alto, 
		   dbo.producto_presentacion.largo, 
		   dbo.producto_presentacion.ancho, 
		   dbo.bodega_ubicacion.IdTramo, 
		   dbo.bodega_ubicacion.ancho AS Ancho_ubicacion,
           dbo.bodega_ubicacion.largo AS Largo_ubicacion, 
		   dbo.bodega_ubicacion.alto AS Alto_ubicacion, 
		   dbo.indice_rotacion.Descripcion AS IndiceRotacion, 
		   dbo.producto.existencia_min AS Existencia_min_umbas, 
		   dbo.producto.existencia_max AS Existencia_max_umbas,
           dbo.trans_oc_det.costo, 
		   dbo.producto_presentacion.MinimoExistencia AS Existencia_min_pres, 
		   dbo.producto_presentacion.MaximoExistencia AS Existencia_max_pres, 
		   dbo.bodega_ubicacion.IdUbicacion AS IdUbicacionActual,
           dbo.bodega_ubicacion.nivel AS Ubicacion_Nivel, 
		   dbo.bodega_ubicacion.indice_x AS Ubicacion_Indice_X, 
		   dbo.bodega_ubicacion.descripcion AS Ubicacion_Nombre, 
		   dbo.bodega_tramo.descripcion AS Ubicacion_Tramo, 
		   dbo.bodega_ubicacion.activo,
		   dbo.bodega_ubicacion.bloqueada,
		   dbo.bodega_ubicacion.ubicacion_merma,		   
		   ISNULL(dbo.motivo_devolucion.Nombre, 'N/A') AS MotivoDevolucion, 
		   ISNULL(dbo.trans_oc_pol.codigo_poliza, 'N/D') AS Codigo_Poliza, 
		   ISNULL(dbo.trans_oc_pol.numero_orden, 'N/D') AS Numero_poliza, 
		   numero_orden, 
		   dbo.producto_familia.nombre AS Familia, 
		   dbo.trans_oc_pol.NoPoliza AS NoTO, 
		   dbo.Nombre_Area(dbo.bodega_ubicacion.IdArea, dbo.bodega_ubicacion.IdBodega) AS Area, 
		   dbo.producto_clasificacion.nombre AS Clasificacion, 
		   dbo.producto_parametro_a.IdProductoParametroA, 
		   dbo.producto_parametro_b.IdProductoParametroB, 
		   stock.atributo_variante_1,
           dbo.producto_parametro_a.Nombre AS parametro_a, 
		   dbo.producto_parametro_b.Nombre AS parametro_b,
           dbo.p_parametro.descripcion AS parametro_personalizado,
           case
            when p_parametro.tipo = 'Númerico'  then CAST( dbo.stock_parametro.valor_numerico AS nvarchar)
            when p_parametro.tipo = 'Texto' then dbo.stock_parametro.valor_texto
            when p_parametro.tipo = 'Fecha' then  convert(varchar, dbo.stock_parametro.valor_fecha, 101)   
            when p_parametro.tipo = 'Lógico' then  CAST(dbo.stock_parametro.valor_logico AS nvarchar) end as parametro_valor,
           dbo.producto_tipo.IdTipoProducto, dbo.producto_tipo.NombreTipoProducto as tipo,
		   dbo.producto_marca.IdMarca,dbo.producto_marca.nombre as marca,
		   dbo.stock.cantidad,
		   dbo.trans_oc_enc.IdOrdenCompraEnc as doc_ingreso,
		   ISNULL(dbo.stock_det.posiciones, 1) posiciones,
		   CASE WHEN dbo.trans_oc_det.costo > 0 THEN ROUND(dbo.trans_oc_det.costo, 2) ELSE 0 END valor_unitario, 
		   CASE WHEN dbo.trans_oc_det.cantidad_recibida > 0 THEN 
				CASE WHEN SUM(ISNULL(dbo.stock_res.cantidad, 0)) > 0 
			THEN (dbo.stock.cantidad - ISNULL(SUM(dbo.stock_res.cantidad), 0)) * dbo.trans_oc_det.costo 
						ELSE dbo.stock.cantidad * dbo.trans_oc_det.costo END 
			END valor_total,
			ISNULL(dbo.trans_oc_det.IdEmbarcador,0) IdEmbarcador, ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D') as Shipper,
			dbo.bodega.nombre as Regimen,
			ISNULL(CONVERT(VARCHAR(10), dbo.tms_ticket.Fecha_Ingreso, 103) + ' '  + convert(VARCHAR(8), dbo.tms_ticket.Fecha_Ingreso, 14),'') as ingreso_ticket,
			dbo.bodega.IdEmpresa, 
			IdTipoEtiqueta, 
			ubicacion_picking, 
			dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
			MAX(dbo.stock_res.IdPedido) AS IdPedido, 
			dbo.stock.pallet_no_estandar,
			ISNULL(dbo.trans_oc_embarcador.Nombre,'N/D')  Embarcador, 
			ISNULL(trans_oc_enc.IdOrdenCompraEnc, 0) AS Documento_Ingreso,
			SUM(ISNULL(dbo.stock_res.cantidad, 0)) CantidadReservada,
			
			dbo.Nombre_Completo_Ubicacion(dbo.stock.IdUbicacion,dbo.bodega_ubicacion.IdBodega) as Nombre_Completo,
			dbo.bodega_tramo.es_rack, 
          ISNULL(dbo.trans_oc_enc.Referencia, '') ReferenciaOCEnc,
		  dbo.producto.precio precio_producto,dbo.producto.costo costo_producto,dbo.trans_re_det.costo costo_ingreso
		
FROM        dbo.p_parametro RIGHT OUTER JOIN
                  dbo.producto_parametro_a RIGHT OUTER JOIN
                  dbo.producto_parametros RIGHT OUTER JOIN
                  dbo.stock_parametro RIGHT OUTER JOIN
                  dbo.indice_rotacion RIGHT OUTER JOIN
                  dbo.producto_presentacion RIGHT OUTER JOIN
                  dbo.bodega_tramo INNER JOIN
                  dbo.bodega_ubicacion ON dbo.bodega_tramo.IdTramo = dbo.bodega_ubicacion.IdTramo AND dbo.bodega_tramo.IdSector = dbo.bodega_ubicacion.IdSector AND dbo.bodega_tramo.IdArea = dbo.bodega_ubicacion.IdArea AND
                  dbo.bodega_tramo.IdBodega = dbo.bodega_ubicacion.IdBodega RIGHT OUTER JOIN
                  dbo.trans_oc_pol RIGHT OUTER JOIN
                  dbo.trans_re_oc LEFT OUTER JOIN
                  dbo.trans_oc_enc ON dbo.trans_re_oc.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc RIGHT OUTER JOIN
                  dbo.producto_clasificacion RIGHT OUTER JOIN
                  dbo.producto_parametro_b RIGHT OUTER JOIN
                  dbo.producto_bodega INNER JOIN
                  dbo.producto ON dbo.producto_bodega.IdProducto = dbo.producto.IdProducto INNER JOIN
                  dbo.unidad_medida INNER JOIN
                  dbo.propietarios INNER JOIN
                  dbo.stock INNER JOIN
                  dbo.propietario_bodega ON dbo.stock.IdPropietarioBodega = dbo.propietario_bodega.IdPropietarioBodega ON dbo.propietarios.IdPropietario = dbo.propietario_bodega.IdPropietario ON dbo.unidad_medida.IdUnidadMedida = dbo.stock.IdUnidadMedida ON
                  dbo.producto_bodega.IdProductoBodega = dbo.stock.IdProductoBodega ON dbo.producto_parametro_b.IdProductoParametroB = dbo.producto.IDPRODUCTOPARAMETROB ON dbo.producto_clasificacion.IdClasificacion = dbo.producto.IdClasificacion LEFT OUTER JOIN
                  dbo.stock_res ON dbo.stock.IdStock = dbo.stock_res.IdStock ON dbo.trans_re_oc.IdRecepcionEnc = dbo.stock.IdRecepcionEnc LEFT OUTER JOIN
                  dbo.motivo_devolucion ON dbo.trans_oc_enc.IdMotivoDevolucion = dbo.motivo_devolucion.IdMotivoDevolucion ON dbo.trans_oc_pol.IdOrdenCompraEnc = dbo.trans_oc_enc.IdOrdenCompraEnc ON dbo.bodega_ubicacion.IdBodega = dbo.stock.IdBodega AND
                  dbo.bodega_ubicacion.IdUbicacion = dbo.stock.IdUbicacion ON dbo.producto_presentacion.IdPresentacion = dbo.stock.IdPresentacion ON dbo.indice_rotacion.IdIndiceRotacion = dbo.producto.IdIndiceRotacion ON dbo.stock_parametro.IdStock = dbo.stock.IdStock ON
                  dbo.producto_parametros.IdProductoParametro = dbo.stock_parametro.IdProductoParametro AND dbo.producto_parametros.IdProducto = dbo.producto.IdProducto ON
                  dbo.producto_parametro_a.IdProductoParametroA = dbo.producto.IDPRODUCTOPARAMETROA LEFT OUTER JOIN
                  dbo.producto_estado ON dbo.stock.IdProductoEstado = dbo.producto_estado.IdEstado LEFT OUTER JOIN
                  dbo.producto_familia ON dbo.producto.IdFamilia = dbo.producto_familia.IdFamilia ON dbo.p_parametro.IdParametro = dbo.producto_parametros.IdParametro
				  LEFT OUTER JOIN dbo.producto_marca on dbo.producto.IdMarca = dbo.producto_marca.IdMarca
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario
				  LEFT OUTER JOIN dbo.producto_tipo on dbo.producto.IdTipoProducto = dbo.producto_tipo.IdTipoProducto
				  and dbo.producto.IdPropietario = dbo.producto_marca.IdPropietario

				  LEFT OUTER JOIN dbo.stock_det on dbo.stock.IdStock = dbo.stock_det.IdStock
				 left outer join dbo.trans_re_enc on dbo.stock.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc
				 left outer join dbo.trans_re_det on dbo.trans_re_det.IdRecepcionEnc = dbo.trans_re_enc.IdRecepcionEnc 
				 and dbo.stock.IdRecepcionDet = dbo.trans_re_det.IdRecepciondet
				 left outer join  dbo.trans_oc_det on dbo.trans_re_det.IdOrdenCompraDet = dbo.trans_oc_det.IdOrdenCompraDet 
				 and dbo.trans_re_det.IdOrdenCompraEnc = dbo.trans_oc_det.IdOrdenCompraEnc
				 
				 LEFT OUTER JOIN dbo.trans_oc_embarcador on dbo.trans_oc_det.IdEmbarcador = dbo.trans_oc_embarcador.IdEmbarcador
				 INNER JOIN dbo.bodega on dbo.stock.IdBodega = dbo.bodega.IdBodega
				 LEFT OUTER JOIN dbo.tms_ticket on dbo.trans_oc_enc.no_ticket_tms= dbo.tms_ticket.IdTicket
				
GROUP BY dbo.propietarios.nombre_comercial, dbo.propietarios.IdPropietario, dbo.stock.IdStock, dbo.bodega_ubicacion.IdUbicacion, dbo.stock.IdUbicacion_anterior, dbo.propietario_bodega.IdPropietarioBodega, dbo.producto_bodega.IdProductoBodega,
                  dbo.unidad_medida.IdUnidadMedida, dbo.unidad_medida.Nombre, dbo.producto_presentacion.nombre, dbo.producto.IdProducto, dbo.producto.codigo, dbo.producto.nombre, dbo.stock.lote, dbo.stock.fecha_ingreso, dbo.stock.serial, dbo.stock.añada,
                  dbo.stock.fecha_vence, dbo.stock.IdProductoEstado, dbo.producto_estado.nombre, dbo.producto_estado.utilizable, dbo.producto_estado.dañado, dbo.stock.IdUbicacion, dbo.stock.IdPresentacion, dbo.stock.IdRecepcionEnc, dbo.stock.lic_plate, dbo.stock.peso,
                  dbo.producto.IdIndiceRotacion, dbo.producto_presentacion.alto, dbo.producto_presentacion.largo, dbo.producto_presentacion.ancho, dbo.producto_presentacion.factor, dbo.bodega_ubicacion.IdTramo, dbo.bodega_ubicacion.ancho, dbo.bodega_ubicacion.largo,
                  dbo.bodega_ubicacion.alto, dbo.indice_rotacion.Descripcion, dbo.producto.existencia_min, dbo.producto.existencia_max, dbo.producto.codigo_barra, dbo.producto.costo, dbo.producto_presentacion.MinimoExistencia, dbo.producto_presentacion.MaximoExistencia,
                  dbo.stock.cantidad, dbo.stock.cantidad / dbo.producto_presentacion.factor, dbo.stock.atributo_variante_1, dbo.bodega_ubicacion.nivel, dbo.bodega_ubicacion.indice_x, dbo.bodega_ubicacion.descripcion, dbo.bodega_tramo.descripcion,
                  dbo.bodega_ubicacion.orientacion_pos, dbo.motivo_devolucion.Nombre, dbo.trans_oc_pol.codigo_poliza, dbo.bodega_ubicacion.IdBodega, dbo.trans_oc_pol.numero_orden, dbo.producto_familia.nombre, dbo.trans_oc_pol.NoPoliza, dbo.trans_oc_enc.Referencia,
                  dbo.bodega_ubicacion.IdArea, dbo.producto_clasificacion.nombre, dbo.producto_parametro_a.IdProductoParametroA, dbo.producto_parametro_b.IdProductoParametroB, dbo.producto_parametro_a.Nombre, dbo.producto_parametro_b.Nombre, dbo.stock.IdBodega,
                  p_parametro.descripcion,p_parametro.tipo,stock_parametro.valor_numerico,stock_parametro.valor_texto,stock_parametro.valor_fecha,stock_parametro.valor_logico,
				  dbo.producto_tipo.IdTipoProducto,dbo.producto_marca.IdMarca,
				  dbo.producto_marca.nombre,dbo.producto_tipo.NombreTipoProducto,
				  dbo.bodega_ubicacion.activo,
				  dbo.bodega_ubicacion.bloqueada,
				  dbo.bodega_ubicacion.ubicacion_merma,
				  dbo.trans_oc_enc.IdOrdenCompraEnc,dbo.stock_det.posiciones,
				  dbo.trans_oc_det.costo,
				  dbo.trans_oc_det.cantidad_recibida,
				  dbo.trans_oc_det.IdEmbarcador,dbo.trans_oc_embarcador.Nombre,
				  dbo.bodega.nombre, dbo.tms_ticket.Fecha_Ingreso
				  , dbo.bodega.IdEmpresa, dbo.producto.IdTipoEtiqueta,
				  dbo.bodega_ubicacion.ubicacion_picking,  dbo.producto_presentacion.CamasPorTarima, dbo.producto_presentacion.CajasPorCama,
				  dbo.stock.pallet_no_estandar, dbo.bodega_tramo.es_rack,
				  dbo.producto.precio,dbo.producto.costo,dbo.trans_re_det.costo










